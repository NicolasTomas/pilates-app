<!doctype html>
<html lang="es">

<head>
    <meta charset="utf-8" />
    <meta name="viewport" content="width=device-width, initial-scale=1" />
    <link href="https://fonts.googleapis.com/css2?family=Orbitron:wght@700&display=swap" rel="stylesheet">
    <title>Administración - Pilates Camilla</title>
    <style>
        * {
            margin: 0;
            padding: 0;
            box-sizing: border-box;
        }

        :root {
            /* Responsive sidebar width: scales with viewport but stays within sensible bounds */
            --sidebar-width: clamp(180px, 18vw, 260px);
            --sidebar-gap: 20px;
        }

        /* Fullscreen 'Ingreso por DNI' view styles */
        /* Always hide the top/header in ingreso-mode */
        body.ingreso-mode .top {
            display: none !important;
        }

        /* Hide the lateral navbar only on desktop when in ingreso-mode; on mobile it should remain available */
        @media (min-width: 768px) {
            body.ingreso-mode .navbar {
                display: none !important;
            }

            /* If the sidebar is opened while in ingreso-mode, ensure it becomes visible */
            body.ingreso-mode.nav-open .navbar {
                display: block !important;
            }
        }

        /* Keep the sidebar toggle visible in ingreso-mode so the user can re-open navigation */
        body.ingreso-mode #sideToggle {
            display: inline-flex !important;
            left: 12px !important;
            top: 12px !important;
            z-index: 1200 !important;
            background: #fff !important;
            box-shadow: 0 6px 20px rgba(0, 0, 0, 0.12) !important;
        }

        /* When in ingreso-mode make the card fill the viewport and center content */
        body.ingreso-mode .card {
            margin: 0;
            border-radius: 0;
            padding: 24px;
            max-width: none;
            min-height: 100vh;
            box-shadow: none;
        }

        /* Background decoration for the ingreso (DNI) view: stronger dark gradient + clearer circles
           Visible only when `body` has the `ingreso-mode` class. Circles are lighter and less blurred
           so they become more noticeable while still remaining decorative behind the content. */
        .bg-decor {
            display: none;
        }

        body.ingreso-mode .bg-decor {
            display: block;
            position: fixed;
            inset: 0;
            /* full viewport */
            z-index: 0;
            /* behind top/card but above page background */
            pointer-events: none;
            overflow: hidden;
        }

        /* Ensure core foreground elements stack above the decoration */
        body.ingreso-mode .top,
        body.ingreso-mode .card {
            position: relative;
            z-index: 1;
        }

        /* Stronger dark gradient used as base to make the backdrop more noticeable */
        body.ingreso-mode .bg-decor::before {
            content: '';
            position: absolute;
            inset: 0;
            background: linear-gradient(180deg, rgba(0, 0, 0, 1) 0%, rgba(12, 12, 12, 0.98) 45%, rgba(28, 28, 28, 0.98) 100%);
            pointer-events: none;
        }

        /* Soft circular shapes: lighter colors + reduced blur for clarity */
        .bg-circle {
            position: absolute;
            border-radius: 50%;
            filter: blur(16px);
            opacity: 0.56;
            pointer-events: none;
            transform: translate3d(0, 0, 0);
        }

        .bg-circle.c1 {
            width: 560px;
            height: 560px;
            left: -6%;
            top: 6%;
            background: rgba(140, 140, 140, 1);
        }

        .bg-circle.c2 {
            width: 380px;
            height: 380px;
            right: 6%;
            top: 26%;
            background: rgba(120, 120, 120, 1);
        }

        .bg-circle.c3 {
            width: 300px;
            height: 300px;
            left: 62%;
            bottom: 6%;
            background: rgba(100, 100, 100, 1);
        }

        /* Slight scale/position differences on smaller screens to avoid clipping */
        @media (max-width: 700px) {
            .bg-circle.c1 {
                width: 460px;
                height: 460px;
                left: -18%;
                top: 2%;
            }

            .bg-circle.c2 {
                width: 340px;
                height: 340px;
                right: -6%;
                top: 22%;
            }

            .bg-circle.c3 {
                width: 240px;
                height: 240px;
                left: 56%;
                bottom: -2%;
            }
        }

        .dni-check-container {
            display: flex;
            flex-direction: column;
            gap: 18px;
            height: 100%;
        }

        .dni-input-wrap {
            display: flex;
            gap: 8px;
            align-items: center;
            justify-content: center;
            padding: 8px 12px;
        }

        .dni-input-wrap input[type="text"],
        .dni-input-wrap input[type="number"] {
            width: min(420px, 60%);
            padding: 14px 16px;
            border-radius: 12px;
            border: 2px solid #e6edf3;
            font-size: 20px;
            box-shadow: 0 6px 20px rgba(2, 6, 23, 0.06);
        }

        .dni-input-wrap button {
            padding: 12px 16px;
            border-radius: 12px;
            background: linear-gradient(90deg, #22c55e, #16a34a);
            color: #fff;
            font-weight: 700;
            border: none;
            cursor: pointer;
            box-shadow: 0 8px 30px rgba(16, 185, 129, 0.18);
        }

        .dni-result-card {
            flex: 1 1 auto;
            display: flex;
            align-items: center;
            justify-content: center;
            border-radius: 18px;
            padding: 32px;
            color: #083344;
            transition: background .25s ease, color .25s ease, transform .18s ease;
            box-shadow: 0 30px 80px rgba(2, 6, 23, 0.12);
            background: linear-gradient(180deg, #dcf5e9, #93d1a8);
        }

        .dni-result-card.expired {
            background: linear-gradient(180deg, #fbdadc, #f1a4a4);
            color: #4c0519;
        }

        .dni-result-card .meta {
            font-size: 18px;
            color: inherit;
            opacity: 0.95;
        }

        .dni-result-card .name {
            font-size: 48px;
            font-weight: 800;
            margin-bottom: 12px;
        }

        /* Individual stacked fields inside the result card */
        .dni-result-card .field {
            display: block;
            font-size: 20px;
            opacity: 0.95;
            margin-top: 6px;
        }

        .dni-result-card .small {
            font-size: 18px;
            opacity: 0.9;
        }

        /* Ocultar el botón de búsqueda DNI en escritorio; dejar visible en mobile
           (en desktop se puede usar Enter en el input) */
        @media (min-width: 768px) {
            #dniSearchBtn {
                display: none !important;
            }
        }

        /* Specific heading style for the DNI view: centered and larger */
        #ingresoAlumnosSection .titulos {
            text-align: center;
            font-size: 34px;
            letter-spacing: 0.6px;
            margin-bottom: 12px;
        }

        body {
            font-family: 'Inter', -apple-system, BlinkMacSystemFont, 'Segoe UI', Arial, sans-serif;
            background-color: #d9d9d9;
            padding-top: 90px;
        }

        .top {
            background: rgb(255, 255, 255);
            backdrop-filter: blur(10px);
            color: #000000;
            padding: 24px 32px;
            padding-left: 32px;
            /* espacio por defecto para el botón hamburguesa */
            border-bottom: 1px solid rgba(255, 255, 255, 0.2);
            display: flex;
            align-items: center;
            justify-content: center;
            flex-direction: column;
            position: fixed;
            top: 0;
            width: 100%;


        }

        .top h1 {
            font-size: 28px;
            font-weight: 700;
            margin-bottom: 0;
            font-family: 'Orbitron', sans-serif;
        }

        .top>div {
            display: flex;
            justify-content: space-between;
            align-items: center;
        }

        .top button {
            padding: 5px 8px 5px 8px !important;
            border-radius: 8px;
            border: 2px solid rgba(255, 255, 255, 0.3);
            background: rgba(255, 255, 255, 0.2);
            color: #000000;
            font-weight: 600;
            cursor: pointer;
            transition: all 0.3s ease;
            backdrop-filter: blur(10px);
        }

        .top button:hover {
            background: rgba(255, 255, 255, 0.3);
            border-color: rgba(255, 255, 255, 0.5);
        }

        .card {
            /* background: #fff; */
            padding: 40px 32px;
            border-radius: 24px;
            /* box-shadow: 0 10px 40px rgba(0, 0, 0, 0.15); */
            max-width: 1200px;
            margin: 32px auto;
        }

        #newUserForm {
            background-color: white;
        }

        h1,
        h3,
        h4 {
            font-weight: 700;
        }

        h3 {
            color: #000000;
            font-size: 24px;
            margin-bottom: 12px;
        }

        h4 {
            color: #000000;
            font-size: 20px;
            margin-bottom: 16px;


        }

        .titulos {
            color: #000000;
            font-size: 20px;
            margin-bottom: 16px;
            font-family: 'Orbitron', sans-serif;
        }

        section {
            margin-bottom: 32px;
        }

        input,
        select,
        button {
            font-family: inherit;
            font-size: 15px;
        }

        /* Estilo para indicar campos obligatorios (asterisco en rojo) */
        .required {
            color: #e53e3e;
            /* rojo */
            margin-left: 4px;
            font-weight: 700;
        }

        input,
        select {
            padding: 12px 16px;
            border-radius: 12px;
            border: 2px solid #e2e8f0;
            background: #f8fafc;
            transition: all 0.3s ease;
        }

        input:focus,
        select:focus {
            border-color: #667eea;
            outline: none;
            background: #fff;
            box-shadow: 0 0 0 3px rgba(102, 126, 234, 0.1);
        }

        button {
            padding: 12px 24px;
            border-radius: 12px;
            border: none;
            background-color: #000000c5;
            color: #fff;
            font-weight: 600;
            cursor: pointer;
            box-shadow: 0 4px 12px rgba(102, 126, 234, 0.3);
            transition: all 0.3s ease;
        }

        button:hover {
            transform: translateY(-2px);
            box-shadow: 0 6px 16px rgba(102, 126, 234, 0.4);
        }

        button[style*="background:#38a169"],
        button[style*="background:#2b6cb0"],
        button[style*="background:#48bb78"] {
            background: linear-gradient(135deg, #48bb78 0%, #38a169 100%) !important;
            box-shadow: 0 4px 12px rgba(72, 187, 120, 0.3);
        }

        button[style*="background:#e53e3e"] {
            background: linear-gradient(135deg, #fc8181 0%, #e53e3e 100%) !important;
            box-shadow: 0 4px 12px rgba(229, 62, 62, 0.3);
        }

        .navbar {
            display: none;
            /* esconder la antigua barra horizontal; se mostrará como panel lateral cuando body.nav-open */
            background: rgb(255, 255, 255);
            backdrop-filter: blur(10px);
            box-shadow: 0 4px 20px rgba(0, 0, 0, 0.1);
            border-top-right-radius: 10px;
            border-bottom-right-radius: 10px;

            /* Permitir scroll horizontal en la barra, pero ocultar la scrollbar mediante reglas específicas */
            overflow: visible;

            padding: 0;
            position: sticky;
            top: 0;
            border-bottom: 1px solid rgba(255, 255, 255, 0.2);
            /* z-index: 999; */
        }

        .navbar ul {
            display: flex;
            gap: 0;
            margin: 0;
            padding: 0 32px;
            list-style: none;
            /* Scroll horizontal funcional */
            overflow-x: auto;
            -webkit-overflow-scrolling: touch;
            /* Ocultar scrollbar en distintos navegadores */
            scrollbar-width: none;
            /* Firefox */
            -ms-overflow-style: none;
            /* IE 10+ */
        }

        /* WebKit: ocultar barra de scroll horizontal */
        .navbar ul::-webkit-scrollbar {
            height: 0;
            background: transparent;
        }

        .navbar li {
            margin: 0;
        }

        .navbar a {
            display: flex;
            align-items: center;
            gap: 10px;
            padding: 20px 28px;
            color: #696969;
            font-weight: 600;
            text-decoration: none;
            border-right: 3px solid transparent;
            transition: all 0.3s ease;
            /* Mantener en una sola línea; el contenedor hará scroll si hace falta */
            white-space: nowrap;
        }

        .navbar a svg {
            width: 18px;
            height: 18px;
            stroke: currentColor;
        }

        /* The 'Ingreso de alumnos' link uses the default .navbar a styles like the other items. */

        .navbar a.active {
            /* background: linear-gradient(135deg, rgba(102, 126, 234, 0.1) 0%, rgba(118, 75, 162, 0.1) 100%); */
            border-right: 3px solid #000000;
            color: #000000;
            overflow-x: hidden;

        }

        .navbar a:hover {
            color: #000000;

        }

        table {
            width: 100%;
            border-collapse: separate;
            border-spacing: 0;
            background: #ffffff;
            border-radius: 12px;
            overflow: hidden;
            box-shadow: 0 2px 8px rgba(0, 0, 0, 0.05);
        }

        th,
        td {
            padding: 14px 12px;
            text-align: left;
        }

        th {
            background-color: #000000;
            color: #fff;
            font-weight: 600;
            font-size: 13px;
            text-transform: uppercase;
            letter-spacing: 0.5px;
        }

        tbody tr {
            border-bottom: 1px solid #f1f5f9;
            transition: all 0.2s ease;
        }

        tbody tr:hover {
            background: #f8fafc;
        }

        tbody tr:last-child {
            border-bottom: none;
        }

        .modal {
            position: fixed;
            inset: 0;
            background: rgba(0, 0, 0, 0.5);
            backdrop-filter: blur(5px);
            display: flex;
            align-items: center;
            justify-content: center;
            z-index: 1000;
            animation: fadeIn 0.3s ease;
        }

        @keyframes fadeIn {
            from {
                opacity: 0;
            }

            to {
                opacity: 1;
            }
        }

        .modal>div {
            background: #fff;
            padding: 32px;
            border-radius: 20px;
            box-shadow: 0 20px 60px rgba(0, 0, 0, 0.3);
            min-width: 380px;
            max-width: 95vw;
            max-height: 90vh;
            overflow-y: auto;
            animation: slideUp 0.3s ease;
        }

        @keyframes slideUp {
            from {
                opacity: 0;
                transform: translateY(20px);
            }

            to {
                opacity: 1;
                transform: translateY(0);
            }
        }

        @media (max-width: 700px) {
            body {
                overflow-x: hidden;
            }

            .top {
                padding: 16px;
            }

            .top h1 {
                font-size: 20px;
            }

            .top>div {
                flex-direction: column;
                gap: 12px;
                align-items: flex-start;
            }

            .top button {
                padding: 8px 16px;
                font-size: 14px;
            }

            #meInfo {
                font-size: 14px;
            }

            .card {
                margin: 20px 16px;
                padding: 24px 16px;
                border-radius: 16px;
            }

            h3 {
                font-size: 20px;
            }

            h4 {
                font-size: 18px;
            }

            .navbar ul {
                padding: 0 16px;
                overflow-x: auto;
                -webkit-overflow-scrolling: touch;
                scrollbar-width: none;
                -ms-overflow-style: none;
            }

            .navbar a {
                padding: 16px 16px;
                font-size: 14px;
                white-space: nowrap;
            }

            /* Hacer tablas scrolleables horizontalmente */
            table {
                display: block;
                overflow-x: auto;
                -webkit-overflow-scrolling: touch;
            }

            th,
            td {
                padding: 10px 8px;
                font-size: 13px;
                white-space: nowrap;
            }

            button {
                padding: 8px 14px;
                font-size: 14px;
            }

            input,
            select {
                padding: 10px 12px;
                font-size: 14px;
            }

            section {
                margin-bottom: 24px;
            }

            /* Formularios en columna simple en mobile */
            div[style*="grid-template-columns"] {
                display: flex !important;
                flex-direction: column !important;
                gap: 12px !important;
            }

            /* Exception: keep two columns for the Crear Usuario form on mobile */
            #usersSection #newUserForm div[style*="grid-template-columns"] {
                display: grid !important;
                grid-template-columns: 1fr 1fr !important;
                gap: 12px !important;
            }

            .modal>div {
                padding: 24px 16px;
                border-radius: 16px;
                min-width: auto;
                width: 90%;
            }
        }

        @media (max-width: 480px) {
            .top h1 {
                font-size: 18px;
            }

            .card {
                margin: 16px 12px;
                padding: 20px 12px;
            }

            .navbar a {
                padding: 12px 12px;
                font-size: 13px;
            }

            th,
            td {
                padding: 8px 6px;
                font-size: 12px;
            }

            button {
                padding: 6px 12px;
                font-size: 13px;
            }

            .modal>div {
                padding: 20px 12px;
                width: 95%;
            }
        }

        /* Reglas para desplegar la navbar como panel lateral con el botón */
        body.nav-open #navOverlay {
            display: block;
        }

        body.nav-open .navbar {
            display: block;
            position: fixed;
            left: 0;
            top: 0;
            bottom: 0;
            width: auto;
            padding-top: 72px;
            /* deja espacio al header */
            overflow-y: auto;
            z-index: 999;
            box-shadow: 0 8px 40px rgba(0, 0, 0, 0.12);
            background: rgb(255, 255, 255);
        }

        body.nav-open .navbar ul {
            flex-direction: column;
            /* leave space at the bottom for the logout footer */
            padding: 8px 0 96px 0;
        }

        body.nav-open .navbar a {
            padding: 12px 18px;
            border-bottom: none;
            border-right: 4px solid transparent;
            white-space: nowrap;
        }

        body.nav-open .navbar a.active {
            border-right-color: #000000;
        }

        /* Hamburger button styles */
        #sideToggle {
            width: 44px;
            height: 44px;
            padding: 8px;
            display: inline-flex;
            align-items: center;
            justify-content: center;
        }



        #sideToggle .hamburger {
            display: inline-block;
            width: 20px;
            height: 14px;
        }

        #sideToggle .hamburger span {
            display: block;
            height: 2px;
            background: #1f2937;
            border-radius: 2px;
            margin: 3px 0;
        }

        @media (prefers-reduced-motion: no-preference) {
            #sideToggle .hamburger span {
                transition: transform .18s ease, opacity .18s ease;
            }
        }

        /* Animated state: when #sideToggle has .open, transform bars into an X */
        #sideToggle.open .hamburger span:nth-child(1) {
            transform: translateY(5px) rotate(45deg);
        }

        #sideToggle.open .hamburger span:nth-child(2) {
            opacity: 0;
            transform: scaleX(.2);
        }

        /* Footer inside the sidebar for logout */
        .navbar .nav-footer {
            position: absolute;
            bottom: 16px;
            left: 0;
            width: 100%;
            display: flex;
            justify-content: center;
            padding: 8px 0;
            box-sizing: border-box;
        }

        .navbar .nav-footer button {
            width: calc(100% - 32px);
            margin: 0 16px;
            border-radius: 8px;
            background: linear-gradient(135deg, #ff6b6b 0%, #d51a1a 100%);
            color: #fff;
            border: none;
            font-weight: 600;
            cursor: pointer;
            box-shadow: 0 4px 12px rgba(229, 62, 62, 0.2);
            display: flex;
            align-items: center;
            justify-content: center;
            gap: 8px;
        }

        .navbar .nav-footer button svg {
            width: 18px;
            height: 18px;
            stroke: currentColor;
        }

        #sideToggle.open .hamburger span:nth-child(3) {
            transform: translateY(-5px) rotate(-45deg);
        }

        /* Sidebar close X: hidden by default, animates into view when in ingreso-mode and sidebar is opened */
        .navbar #sidebarCloseBtn {
            position: absolute;
            right: 12px;
            top: 12px;
            width: 36px;
            height: 36px;
            border-radius: 8px;
            border: none;
            background: rgba(255, 255, 255, 0.95);
            /* Ensure the X glyph is visible (global button rule sets color: #fff) */
            color: #111827;
            font-weight: 700;
            box-shadow: 0 6px 20px rgba(0, 0, 0, 0.08);
            display: inline-flex;
            align-items: center;
            justify-content: center;
            cursor: pointer;
            font-size: 18px;
            line-height: 1;
            opacity: 0;
            transform: translateY(-6px);
            transition: opacity .22s ease, transform .28s cubic-bezier(.2, .9, .2, 1);
            z-index: 1100;
            pointer-events: none;
        }

        /* Show the close button only when on the ingreso-mode and the sidebar is open (desktop only) */
        @media (min-width: 768px) {
            body.ingreso-mode.nav-open .navbar #sidebarCloseBtn {
                opacity: 1;
                transform: translateY(0);
                pointer-events: auto;
            }
        }

        /* Ensure the close button is not visible on small screens (mobile) */
        @media (max-width: 767px) {
            .navbar #sidebarCloseBtn {
                display: none !important;
            }
        }

        /* Desktop: keep sidebar visible and hide toggle button */
        @media (min-width: 768px) {
            #sideToggle {
                display: none !important;
            }

            .navbar {
                display: block;
                position: fixed;
                left: 0;
                top: 0;
                bottom: 0;
                width: var(--sidebar-width);
                padding-top: 72px;
            }

            /* push content to the right so the fixed sidebar doesn't cover it */
            .top,
            .card {
                transition: margin-left .22s ease, transform .22s ease;
                margin-left: calc(var(--sidebar-width) + var(--sidebar-gap));
            }

            /* make sure links stack vertically when sidebar is fixed */
            .navbar ul {
                flex-direction: column;
                /* ensure footer won't overlap the links when sidebar is fixed */
                padding: 12px 8px 96px 8px;
                align-items: stretch;
            }

            .navbar li {
                display: block;
            }

            .navbar a {
                display: flex;
                align-items: center;
                gap: 10px;
                padding: 12px 16px;
                border-left: 4px solid transparent;
                white-space: normal;
            }


        }

        /* When opening on smaller screens, slide the content slightly for a nicer effect */
        @media (min-width: 768px) {

            /* On desktop, keep the lateral navbar visually hidden in ingreso-mode but
               allow it to animate in when the user opens it (body.nav-open). We use
               transforms instead of display:none so the appearance can be animated. */
            body.ingreso-mode .navbar {
                /* keep layout out of flow but allow animation */
                display: block !important;
                transform: translateX(calc(-1 * var(--sidebar-width)));
                opacity: 0;
                pointer-events: none;
                transition: transform .32s cubic-bezier(.2, .9, .2, 1), opacity .22s ease;
            }

            /* If the sidebar is opened while in ingreso-mode, animate it into view */
            body.ingreso-mode.nav-open .navbar {
                transform: translateX(0) !important;
                opacity: 1 !important;
                pointer-events: auto !important;
                box-shadow: 0 8px 40px rgba(0, 0, 0, 0.12) !important;
            }
        }

        /* Ensure content shifts animate on resize as well */
        .top,
        .card {
            transition: margin-left .22s ease, transform .22s ease;
        }

        /* When a modal is open we prevent the page from animating the main
           content (which can move the modal). This keeps the modal centered
           even if the sidebar opens/closes. */
        .modal-open-no-shift .top,
        .modal-open-no-shift .card {
            transition: none !important;
            transform: none !important;
        }

        /* Ensure modal always sits above the sidebar */
        .modal {
            z-index: 3000 !important;
            position: fixed !important;
            inset: 0 !important;
        }

        /* Custom confirm modal styles */
        .confirm-backdrop {
            position: fixed;
            inset: 0;
            background: rgba(0, 0, 0, 0.45);
            display: flex;
            align-items: center;
            justify-content: center;
            z-index: 2000;
        }

        .confirm-modal {
            background: #fff;
            border-radius: 12px;
            padding: 20px 18px;
            width: 320px;
            max-width: calc(100% - 32px);
            box-shadow: 0 20px 60px rgba(0, 0, 0, 0.25);
            text-align: left;
            font-family: inherit;
        }

        .day-toggle {
            padding: 5px 9px !important;

        }

        #classDays {
            gap: 5px !important;
        }

        .confirm-modal h4 {
            margin-bottom: 8px;
            font-size: 16px;
        }

        .confirm-row {
            display: flex;
            gap: 8px;
            justify-content: flex-end;
            margin-top: 12px;
        }

        .confirm-modal button {
            padding: 8px 12px;
            border-radius: 8px;
            border: none;
            font-weight: 600;
            cursor: pointer;
        }

        .confirm-cancel {
            background: #f1f5f9;
            color: #111
        }

        .confirm-ok {
            background: #e53e3e;
            color: #fff
        }

        .modal-actions {
            margin-top: 15px;
        }

        /* Cards grid for lists - active for all sizes */
        .cards-grid {
            display: grid;
            gap: 14px;
            grid-template-columns: repeat(auto-fill, minmax(220px, 1fr));
        }

        /* For better readability, render the classes list as a vertical stack
           (one class per row). This keeps professors/students/rooms as cards. */
        #classesList>.cards-grid {
            grid-template-columns: 1fr;
        }

        .item-card {
            background: #fff;
            padding: 12px;
            border-radius: 12px;
            box-shadow: 0 6px 18px rgba(0, 0, 0, 0.06);
            display: flex;
            flex-direction: column;
            justify-content: space-between;
        }

        .item-card h4 {
            margin: 0 0 8px 0;
            font-size: 16px
        }

        .item-card .meta {
            color: #555;
            font-size: 14px;
            margin-bottom: 10px;
            white-space: normal
        }

        .item-card .actions {
            display: flex;
            gap: 8px;
            justify-content: flex-end;
            margin-top: 0.5rem;
        }

        .item-card .actions button {
            padding: 8px 10px;
            border-radius: 8px;
            border: none;
            font-weight: 600;
            cursor: pointer
        }

        .item-card .actions .btn-edit {
            background: #2b6cb0;
            color: #fff
        }

        .item-card .actions .btn-delete {
            background: #e53e3e;
            color: #fff
        }

        .item-card .actions .btn-manage {
            background: #48bb78;
            color: #fff
        }

        /* Professor classes: stack them vertically for readability */
        .prof-classes {
            display: flex;
            flex-direction: column;
            gap: 6px;
            margin-top: 8px;
        }

        .prof-classes .pill {
            display: block;
            background: #f1f5f9;
            color: #111827;
            padding: 6px 8px;
            border-radius: 8px;
            font-size: 13px;
        }

        /* no media query: cards are used at all viewport sizes */

        /* Toast / inline alerts (small, non-blocking) */
        .toast-container {
            position: fixed;
            top: 16px;
            right: 16px;
            display: flex;
            flex-direction: column;
            gap: 10px;
            z-index: 5000;
            pointer-events: none;
        }

        .toast {
            pointer-events: auto;
            min-width: 220px;
            max-width: 420px;
            padding: 10px 14px;
            border-radius: 10px;
            color: #fff;
            font-weight: 700;
            box-shadow: 0 8px 28px rgba(2, 6, 23, 0.12);
            animation: toastIn .18s ease;
        }

        .toast.success {
            background: linear-gradient(90deg, #16a34a, #059669);
        }

        .toast.error {
            background: linear-gradient(90deg, #ef4444, #dc2626);
        }

        .toast.info {
            background: linear-gradient(90deg, #2563eb, #1d4ed8);
        }

        @keyframes toastIn {
            from {
                transform: translateY(-6px);
                opacity: 0
            }

            to {
                transform: translateY(0);
                opacity: 1
            }
        }

        /* Membership types UI improvements */
        #membershipTypesList {
            /* override inline column layout to render as compact pills */
            display: flex !important;
            flex-wrap: wrap !important;
            gap: 8px !important;
            padding: 12px !important;
            background: #fff !important;
            border-radius: 10px !important;
            max-height: 220px;
            overflow: auto;
        }

        #membershipTypesList>div {
            display: inline-flex !important;
            align-items: center !important;
            gap: 10px !important;
            background: #f3f4f6;
            color: #0f172a;
            padding: 8px 12px;
            border-radius: 999px;
            box-shadow: 0 6px 20px rgba(2, 6, 23, 0.04);
            border: 1px solid rgba(15, 23, 42, 0.04);
            white-space: nowrap;
        }

        #membershipTypesList>div span {
            font-weight: 700;
        }

        #membershipTypesList .delMembership {
            background: transparent !important;
            color: #ef4444 !important;
            border: none !important;
            padding: 4px 6px !important;
            font-weight: 700 !important;
            cursor: pointer !important;
            border-radius: 6px !important;
        }

        #newMembershipInput {
            padding: 10px !important;
            border-radius: 8px !important;
            border: 1px solid #e6edf3 !important;
        }

        #addMembershipBtn {
            background: linear-gradient(135deg, #48bb78 0%, #38a169 100%) !important;
            color: #fff !important;
            border-radius: 8px !important;
            padding: 8px 14px !important;
            border: none !important;
            box-shadow: 0 8px 26px rgba(72, 187, 120, 0.12) !important;
        }

        /* Scroll fade indicators for lists (show subtle gradient when content overflows) */
        #newUserClassesContainer {
            position: relative;
            overflow-y: scroll;
        }

        #newUserClassesContainer::before,
        #newUserClassesContainer::after {
            content: '';
            position: absolute;
            left: 0;
            right: 0;
            height: 18px;
            pointer-events: none;
            opacity: 0;
            transition: opacity .18s ease;
            z-index: 2;
        }

        #newUserClassesContainer::before {
            top: 0;
            background: linear-gradient(to bottom, rgba(0, 0, 0, 0.12), transparent);
        }

        #newUserClassesContainer::after {
            bottom: 0;
            background: linear-gradient(to top, rgba(0, 0, 0, 0.12), transparent);
        }

        #newUserClassesContainer.has-top::before {
            opacity: 1;
        }

        #newUserClassesContainer.has-bottom::after {
            opacity: 1;
        }
    </style>
</head>

<body>
    <!-- Overlay usado cuando el menú lateral está abierto -->
    <div id="navOverlay" style="display:none;position:fixed;inset:0;background:rgba(0,0,0,0.35);z-index:998"></div>
    <!-- Background decoration for ingreso (dark gradient + circles). Hidden unless body.ingreso-mode is active -->
    <div class="bg-decor" aria-hidden="true">
        <span class="bg-circle c1" aria-hidden="true"></span>
        <span class="bg-circle c2" aria-hidden="true"></span>
        <span class="bg-circle c3" aria-hidden="true"></span>
    </div>
    <!-- Botón lateral fijo para desplegar la navbar (ubicado arriba a la izquierda) -->
    <button id="sideToggle" aria-label="Abrir menú" aria-expanded="false" title="Menú"
        style="position:fixed;left:8px;top:18px;z-index:1001;border-radius:10px;border:1px solid rgba(0,0,0,0.06);background:#fff;box-shadow:0 6px 20px rgba(0,0,0,0.08);">
        <span class="hamburger" aria-hidden="true"><span></span><span></span><span></span></span>
    </button>
    <div class="top">
        <h1>Panel de Administrador</h1>
        <div>
            <span id="meInfo">Cargando...</span>
        </div>
    </div>
    <nav class="navbar">
        <ul>
            <li><a href="#" class="nav-link active" data-section="usersSection">
                    <svg viewBox="0 0 24 24" fill="none" stroke-width="2" aria-hidden="true">
                        <path d="M16 21v-2a4 4 0 0 0-4-4H7a4 4 0 0 0-4 4v2" />
                        <circle cx="9" cy="7" r="4" />
                        <line x1="19" y1="8" x2="19" y2="14" />
                        <line x1="16" y1="11" x2="22" y2="11" />
                    </svg>
                    <span>Crear Usuario</span>
                </a></li>
            <li><a href="#" class="nav-link" data-section="professorsSection">
                    <svg viewBox="0 0 24 24" fill="none" stroke-width="2" aria-hidden="true">
                        <path d="M4 19v-4c0-1.1.9-2 2-2h4" />
                        <circle cx="10" cy="7" r="3.2" />
                        <path d="M16 16h3" />
                        <path d="M16 13h3" />
                        <path d="M16 10h3" />
                        <path d="M13 8h2v12h-2z" />
                    </svg>
                    <span>Profesores</span>
                </a></li>
            <li><a href="#" class="nav-link" data-section="studentsSection">
                    <svg viewBox="0 0 24 24" fill="none" stroke-width="2" aria-hidden="true">
                        <path d="M16 21v-2a4 4 0 0 0-4-4H6a4 4 0 0 0-4 4v2" />
                        <circle cx="9" cy="7" r="4" />
                        <path d="M22 21v-2a4 4 0 0 0-3-3.87" />
                        <path d="M16 3.13a4 4 0 0 1 0 7.75" />
                    </svg>
                    <span>Alumnos</span>
                </a></li>
            <li><a href="#" class="nav-link" data-section="roomsSection">
                    <svg viewBox="0 0 24 24" fill="none" stroke-width="2" aria-hidden="true">
                        <rect x="4" y="3" width="16" height="18" rx="2" />
                        <path d="M10 3v18" />
                        <circle cx="7.5" cy="12" r="0.9" />
                        <path d="M14 12h4" />
                    </svg>
                    <span>Salones</span>
                </a></li>
            <li><a href="#" class="nav-link" data-section="classesSection">
                    <svg viewBox="0 0 24 24" fill="none" stroke-width="2" aria-hidden="true">
                        <rect x="3" y="4" width="18" height="18" rx="2" ry="2" />
                        <line x1="16" y1="2" x2="16" y2="6" />
                        <line x1="8" y1="2" x2="8" y2="6" />
                        <line x1="3" y1="10" x2="21" y2="10" />
                        <circle cx="12" cy="16" r="4" />
                        <path d="M12 14v2.5l1.5 1" />
                    </svg>
                    <span>Clases</span>
                </a></li>
            <li><a href="#" class="nav-link" data-section="gymConfigSection">
                    <svg viewBox="0 0 24 24" fill="none" stroke-width="2" aria-hidden="true">
                        <circle cx="12" cy="12" r="3" />
                        <path d="M19.4 15a1.65 1.65 0 0 0 .33 1.82l.06.06a2 2 0 0 1-2.83 2.83l-.06-.06a1.65 1.65 0 0 0-1.82-.33 1.65 1.65 0 0 0-1 1.51V21a2 2 0 0 1-4 0v-.09a1.65 1.65 0 0 0-1-1.51 1.65 1.65 0 0 0-1.82.33l-.06.06a2 2 0 1 1-2.83-2.83l.06-.06a1.65 1.65 0 0 0 .33-1.82 1.65 1.65 0 0 0-1.51-1H3a2 2 0 0 1 0-4h.09a1.65 1.65 0 0 0 1.51-1 1.65 1.65 0 0 0-.33-1.82l-.06-.06a2 2 0 1 1 2.83-2.83l.06.06a1.65 1.65 0 0 0 1.82.33H9a1.65 1.65 0 0 0 1-1.51V3a2 2 0 0 1 4 0v.09a1.65 1.65 0 0 0 1 1.51 1.65 1.65 0 0 0 1.82-.33l.06-.06a2 2 0 1 1 2.83 2.83l-.06.06a1.65 1.65 0 0 0-.33 1.82V9a1.65 1.65 0 0 0 1.51 1H21a2 2 0 0 1 0 4h-.09a1.65 1.65 0 0 0-1.51 1z" />
                    </svg>
                    <span>Configuración</span>
                </a></li>
            <li><a href="#" class="nav-link" data-section="ingresoAlumnosSection">
                    <svg viewBox="0 0 24 24" fill="none" stroke-width="2" aria-hidden="true">
                        <rect x="3" y="4" width="18" height="16" rx="2" />
                        <line x1="7" y1="8" x2="13" y2="8" />
                        <line x1="7" y1="12" x2="12" y2="12" />
                        <circle cx="17" cy="12" r="2.5" />
                    </svg>
                    <span>Ingreso de alumnos</span>
                </a></li>
        </ul>
        <!-- Close button shown only when in ingreso-mode and sidebar is open -->
        <button id="sidebarCloseBtn" aria-label="Cerrar barra" title="Cerrar" type="button">✕</button>
        <!-- Logout moved here so it's always at the bottom of the sidebar -->
        <div class="nav-footer">
            <button id="logout" type="button" title="Cerrar sesión">
                <svg viewBox="0 0 24 24" fill="none" stroke-width="2" aria-hidden="true">
                    <path d="M10 17l-5-5 5-5" />
                    <path d="M5 12h14" />
                    <path d="M19 5v14" />
                </svg>
                <span>cerrar sesión</span>
            </button>
        </div>
    </nav>
    <div class="card">
        <section id="usersSection">
            <h4 class="titulos">Crear Usuario</h4>
            <!-- Formulario de creación de usuario mostrado directamente (sin botón) -->
        </section>
        <section id="professorsSection" style="display:none">
            <h4 class="titulos">Profesores</h4>
            <div style="display:flex;gap:8px;margin-bottom:8px;align-items:center">
                <input id="searchProfessors" placeholder="Buscar por nombre, apellido o DNI"
                    style="flex:1;padding:8px;border:1px solid #ddd;border-radius:4px" />
            </div>
            <div id="professorsList">Cargando...</div>
        </section>
        <section id="studentsSection" style="display:none">
            <h4 class="titulos">Alumnos</h4>
            <div style="display:flex;gap:8px;margin-bottom:8px;align-items:center">
                <input id="searchStudents" placeholder="Buscar por nombre, apellido o DNI"
                    style="flex:1;padding:8px;border:1px solid #ddd;border-radius:4px" />
            </div>
            <div id="studentsList">Cargando...</div>
        </section>
        <section id="ingresoAlumnosSection" style="display:none">
            <div class="dni-check-container">
                <div style="display:flex;justify-content:center;align-items:center;width:100%">
                    <h4 class="titulos">Ingreso por DNI</h4>
                </div>

                <div class="dni-input-wrap">
                    <input id="dniInput" type="text" inputmode="numeric" placeholder="Ingresá DNI" aria-label="DNI" />
                    <button id="dniSearchBtn" type="button">Buscar</button>
                </div>

                <div id="dniResultCard" class="dni-result-card" style="display:none;">
                    <div id="dniResultInner" style="text-align:center;max-width:900px;width:100%">
                        <!-- Rellenado por JS: nombre y apellido, dni, tipo de cuota, vencimiento -->
                        <div class="name">—</div>
                        <div class="field dni-field small" id="dniField">DNI: —</div>
                        <div class="field membership-field small" id="membershipField">Tipo cuota: —</div>
                        <div class="field due-field small" id="dueField">Vencimiento: —</div>
                        <div style="height:18px"></div>
                        <div id="dniStatus" class="meta" style="font-weight:800;font-size:20px">—</div>
                    </div>
                </div>
            </div>
        </section>
        <section id="roomsSection" style="display:none">
            <h4 class="titulos">Salones</h4>
            <div style="display:flex;gap:8px;margin-bottom:8px;align-items:center">
                <input id="searchRooms" placeholder="Buscar por nombre"
                    style="flex:1;padding:8px;border:1px solid #ddd;border-radius:4px" />
                <button id="btnNewRoom" style="background:#2b6cb0;color:#fff;padding:8px 12px;border-radius:6px">Nuevo
                    salón</button>
            </div>
            <div id="roomsList">Cargando...</div>
        </section>
        <section id="classesSection" style="display:none">
            <h4 class="titulos">Clases</h4>
            <div style="display:flex;gap:8px;margin-bottom:8px;align-items:center">
                <input id="searchClasses" placeholder="Buscar clases"
                    style="flex:1;padding:8px;border:1px solid #ddd;border-radius:4px" />
                <button id="btnNewClass" style="background:#2b6cb0;color:#fff;padding:8px 12px;border-radius:6px">Nueva
                    clase</button>
            </div>
            <div id="classesList">Cargando...</div>
        </section>
        <section id="gymConfigSection" style="display:none">
            <h4 class="titulos">Configuración del Gimnasio</h4>
            <div id="gymConfigForm" style="margin-top:12px">Cargando...</div>
        </section>
    </div>
    <script src="/public/js/auth.js"></script>
    <script>
        // Verificar sesión persistente al cargar la página
        (async () => {
            try {
                await pilatesAuth.checkSessionAndRedirect(['administrador', 'superusuario']);
            } catch (err) {
                console.error('Session check failed:', err);
            }
        })();
    </script>
    <script src="/public/js/admin_rooms.js"></script>
    <script src="/public/js/admin_classes.js"></script>
    <script src="/public/js/admin_students.js"></script>
    <script src="/public/js/admin_professors.js"></script>
    <script src="/public/js/admin_gym.js"></script>
    <script>
        // Navbar navegación entre secciones
        (function () {
            const links = Array.from(document.querySelectorAll('.nav-link'));
            const sideToggleBtn = document.getElementById('sideToggle');
            const topBar = document.querySelector('.top');

            function enterIngresoMode() {
                document.body.classList.add('ingreso-mode');
                try { if (sideToggleBtn && window.innerWidth >= 768) sideToggleBtn.style.setProperty('display', 'inline-flex', 'important'); } catch (e) { }
            }

            function exitIngresoMode() {
                document.body.classList.remove('ingreso-mode');
                try { if (sideToggleBtn) sideToggleBtn.style.removeProperty('display'); } catch (e) { }
                try { if (topBar) topBar.style.removeProperty('display'); } catch (e) { }
            }

            links.forEach(link => {
                link.addEventListener('click', e => {
                    e.preventDefault();
                    links.forEach(l => l.classList.remove('active'));
                    link.classList.add('active');
                    const sectionId = link.getAttribute('data-section');
                    document.querySelectorAll('.card section').forEach(sec => {
                        sec.style.display = sec.id === sectionId ? '' : 'none';
                    });

                    if (sectionId === 'ingresoAlumnosSection') enterIngresoMode(); else exitIngresoMode();

                    // If the sidebar is open, close it when switching sections to keep layout consistent
                    if (document.body.classList.contains('nav-open')) {
                        document.body.classList.remove('nav-open');
                        if (sideToggleBtn) {
                            sideToggleBtn.setAttribute('aria-expanded', 'false');
                            sideToggleBtn.classList.remove('open');
                            try { if (window.innerWidth >= 768 && document.body.classList.contains('ingreso-mode')) sideToggleBtn.style.removeProperty('display'); } catch (e) { }
                        }
                    }
                });
            });
        })();
        // Mostrar sección inicial
        document.querySelectorAll('.card section').forEach(sec => {
            sec.style.display = sec.id === 'usersSection' ? '' : 'none';
        });
        // Side toggle: abrir/cerrar la navbar como panel lateral
        (function () {
            const btn = document.getElementById('sideToggle');
            const overlay = document.getElementById('navOverlay');
            const mainNodes = [document.querySelector('.top'), document.querySelector('.card')].filter(Boolean);
            let _trapListener = null;

            function _setMainAriaHidden(v) {
                for (const n of mainNodes) {
                    try { n.setAttribute('aria-hidden', v ? 'true' : 'false'); } catch (e) { }
                }
            }

            function openNav() {
                document.body.classList.add('nav-open');
                btn.setAttribute('aria-expanded', 'true');
                btn.classList.add('open');
                // If we're in ingreso-mode, hide the toggle once the sidebar is opened (use inline !important)
                try {
                    // only hide the toggle on desktop when opening the sidebar
                    if (document.body.classList.contains('ingreso-mode') && window.innerWidth >= 768) {
                        btn.style.setProperty('display', 'none', 'important');
                    }
                } catch (e) { }
                _setMainAriaHidden(true);
                // focus first focusable element inside nav (first link)
                const first = document.querySelector('.navbar a');
                if (first) first.focus();
                // install focus trap
                _trapListener = function (e) {
                    if (e.key !== 'Tab') return;
                    const focusables = Array.from(document.querySelectorAll('.navbar a, .navbar button, .navbar [href], .navbar [tabindex]:not([tabindex="-1"])')).filter(el => !el.hasAttribute('disabled'));
                    if (!focusables.length) return;
                    const firstEl = focusables[0];
                    const lastEl = focusables[focusables.length - 1];
                    if (e.shiftKey) {
                        if (document.activeElement === firstEl) { e.preventDefault(); lastEl.focus(); }
                    } else {
                        if (document.activeElement === lastEl) { e.preventDefault(); firstEl.focus(); }
                    }
                };
                document.addEventListener('keydown', _trapListener);
            }

            function closeNav() {
                document.body.classList.remove('nav-open');
                btn.setAttribute('aria-expanded', 'false');
                btn.classList.remove('open');
                // If we're in ingreso-mode, show the toggle again when the sidebar closes (remove inline important)
                try {
                    // only remove the inline display override on desktop (if previously applied)
                    if (document.body.classList.contains('ingreso-mode') && window.innerWidth >= 768) {
                        btn.style.removeProperty('display');
                    }
                } catch (e) { }
                _setMainAriaHidden(false);
                // remove focus trap
                if (_trapListener) { document.removeEventListener('keydown', _trapListener); _trapListener = null; }
                // return focus to toggle button
                try { btn.focus(); } catch (e) { }
            }
            btn.addEventListener('click', () => {
                if (document.body.classList.contains('nav-open')) closeNav(); else openNav();
            });
            overlay.addEventListener('click', closeNav);
            // Sidebar close button inside the navbar: call closeNav when clicked
            try {
                const sidebarCloseBtn = document.getElementById('sidebarCloseBtn');
                if (sidebarCloseBtn) {
                    sidebarCloseBtn.addEventListener('click', (e) => { e.stopPropagation(); closeNav(); });
                }
            } catch (e) { }
            // cerrar con ESC
            document.addEventListener('keydown', (e) => { if (e.key === 'Escape') closeNav(); });
            // On resize, ensure breakpoint consistency: when width >= 768 remove mobile nav-open state
            window.addEventListener('resize', () => {
                try {
                    if (window.innerWidth >= 768) {
                        // ensure panel is considered closed for mobile-specific classes
                        if (document.body.classList.contains('nav-open')) {
                            document.body.classList.remove('nav-open');
                        }
                        if (btn) {
                            btn.setAttribute('aria-expanded', 'false');
                            btn.classList.remove('open');
                        }
                    }
                } catch (e) { }
            });
        })();

        // Ingreso por DNI behaviour
        (function () {
            const input = document.getElementById('dniInput');
            const btn = document.getElementById('dniSearchBtn');
            const card = document.getElementById('dniResultCard');
            const inner = document.getElementById('dniResultInner');

            function renderNotFound(dni) {
                card.classList.remove('expired');
                card.style.display = '';
                inner.querySelector('.name').textContent = 'No encontrado';
                inner.querySelector('#dniField').textContent = `DNI: ${dni || '—'}`;
                inner.querySelector('#membershipField').textContent = `Tipo cuota: —`;
                inner.querySelector('#dueField').textContent = `Vencimiento: —`;
                inner.querySelector('#dniStatus').textContent = 'Alumno no registrado';
            }

            async function searchDNI() {
                const v = (input && input.value || '').trim();
                if (!v) return;
                try {
                    const list = await adminStudents.listStudents(v);
                    if (!Array.isArray(list) || list.length === 0) {
                        renderNotFound(v);
                        return;
                    }
                    const s = list[0];
                    // Determine active vs expired
                    let isActive = false;
                    if (s.dueDate) {
                        try { isActive = new Date(s.dueDate) >= new Date(new Date().toDateString()); } catch (e) { isActive = false; }
                    }
                    card.style.display = '';
                    if (isActive) card.classList.remove('expired'); else card.classList.add('expired');
                    inner.querySelector('.name').textContent = `${s.name || ''} ${s.lastName || ''}`.trim() || s.dni || '—';
                    inner.querySelector('#dniField').textContent = `DNI: ${s.dni || '—'}`;
                    inner.querySelector('#membershipField').textContent = `Tipo cuota: ${s.membershipType || '—'}`;
                    // Format due date for display
                    let dueText = '—';
                    if (s.dueDate) {
                        try { dueText = new Date(s.dueDate).toLocaleDateString(); } catch (e) { dueText = String(s.dueDate); }
                    }
                    inner.querySelector('#dueField').textContent = `Vencimiento: ${dueText}`;
                    inner.querySelector('#dniStatus').textContent = isActive ? 'Cuota activa' : 'Cuota vencida';
                } catch (err) {
                    renderNotFound(v);
                }
            }

            if (btn) btn.addEventListener('click', searchDNI);
            if (input) input.addEventListener('keydown', (e) => { if (e.key === 'Enter') searchDNI(); });

            // Keep the main toggle visible even when ingreso-mode hides top/navbar
            // (sideToggle is fixed; nothing to do here)
        })();
    </script>
    <script>
        // Inline form para crear usuario (mostrado directamente)
        // Helper used by inline form construction (safe minimal escape-less version)
        function getMembershipOptionsHTML(selected) {
            const cfg = window.currentGymConfig || {};
            const types = Array.isArray(cfg.membershipTypes) && cfg.membershipTypes.length ? cfg.membershipTypes : ['Pilates en camilla'];
            return types.map(t => '<option value="' + t + '" ' + (selected === t ? 'selected' : '') + '>' + (t.charAt(0).toUpperCase() + t.slice(1)) + '</option>').join('');
        }

        (async function () {
            const formContainer = document.createElement('div');
            formContainer.id = 'newUserForm';
            formContainer.style = 'display:block;margin-top:12px;padding:12px;border-radius:12px;';
            formContainer.innerHTML = `
                <form id="createUserForm">
                    <div style="display:grid;grid-template-columns:1fr 1fr;gap:12px;margin:8px 0">
                        <div>
                            <div style="font-size:13px;margin-bottom:6px">Rol:</div>
                            <select id="newUserRole" style="width:100%;padding:10px;border-radius:8px;border:1px solid #ddd">
                                <option value="alumno">Alumno</option>
                                <option value="profesor">Profesor</option>
                            </select>
                        </div>
                        <div>
                            <div style="font-size:13px;margin-bottom:6px">DNI: <span class="required">*</span></div>
                            <input id="newUserDni" style="width:100%;padding:10px;border-radius:8px;border:1px solid #ddd" />
                        </div>
                        <div>
                            <div style="font-size:13px;margin-bottom:6px">Nombre: <span class="required">*</span></div>
                            <input id="newUserName" style="width:100%;padding:10px;border-radius:8px;border:1px solid #ddd" />
                        </div>
                        <div>
                            <div style="font-size:13px;margin-bottom:6px">Apellido: <span class="required">*</span></div>
                            <input id="newUserLastName" style="width:100%;padding:10px;border-radius:8px;border:1px solid #ddd" />
                        </div>
                        <div>
                            <div style="font-size:13px;margin-bottom:6px">Teléfono:</div>
                            <input id="newUserPhone" style="width:100%;padding:10px;border-radius:8px;border:1px solid #ddd" />
                        </div>
                        <div>
                            <div style="font-size:13px;margin-bottom:6px">Contacto de emergencia:</div>
                            <input id="newUserEmergency" style="width:100%;padding:10px;border-radius:8px;border:1px solid #ddd" />
                        </div>
                        <div>
                            <div style="font-size:13px;margin-bottom:6px">Tipo de cuota:</div>
                            <select id="newUserMembership" style="width:100%;padding:10px;border-radius:8px;border:1px solid #ddd">
                                ${getMembershipOptionsHTML()}
                            </select>
                        </div>
                        <div>
                            <div style="font-size:13px;margin-bottom:6px">Vencimiento:</div>
                            <input type="date" id="newUserDueDate" style="width:100%;padding:10px;border-radius:8px;border:1px solid #ddd" />
                        </div>
                    </div>
                    <div id="classesDivInline" style="margin-top:12px">
                        <div id="classesDivInlineLabel" style="font-size:13px;margin-bottom:6px">Clases asignadas: <span id="classesRequiredAsterisk" class="required">*</span></div>
                        <div style="display:flex;gap:8px;align-items:center;margin-bottom:8px">
                            <input id="newUserClassSearch" placeholder="Buscar clases por día u horario" style="flex:1;padding:8px;border:1px solid #ddd;border-radius:6px" />
                        </div>
                        <div id="newUserClassesContainer" style="max-height:150px;overflow-y:scroll;border:1px solid #ddd;border-radius:8px;padding:6px;background:#fff"></div>
                    </div>
                    <div style="display:flex;gap:8px;justify-content:flex-end;margin-top:12px">
                        <button type="submit" id="saveNewUser" style="background:#38a169;color:#fff">Guardar</button>
                    </div>
                </form>
            `;
            document.querySelector('#usersSection').appendChild(formContainer);

            // helper to refresh the classes list inside the create-user form with a single textual filter
            (function () {
                let _refreshTimer = null;
                window.refreshNewUserClasses = async function refreshNewUserClasses(filter) {
                    const container = document.getElementById('newUserClassesContainer');
                    if (!container) return;
                    try {
                        const classes = await adminClasses.listClasses();
                        // filter using the same accent-insensitive logic as loadClasses
                        const q = (filter || (document.getElementById('newUserClassSearch') && document.getElementById('newUserClassSearch').value) || '').toString().trim().toLowerCase();
                        function norm(s) {
                            if (!s) return '';
                            try { return s.toString().normalize('NFD').replace(/[\u0300-\u036f]/g, '').toLowerCase(); } catch (e) { return s.toString().toLowerCase(); }
                        }
                        const normQ = norm(q);

                        const filtered = classes.filter(c => {
                            if (!q) return true;
                            const start = (c.start || '').toString().toLowerCase();
                            const daysText = Array.isArray(c.days) ? c.days.join(' ').toLowerCase() : (c.days || '').toString().toLowerCase();
                            const normDays = norm(daysText);
                            if (start.includes(q) || start.startsWith(q)) return true;
                            if (normDays.includes(normQ)) return true;
                            const dayMatches = Array.isArray(c.days) && c.days.some(d => norm(d).includes(normQ));
                            if (dayMatches) return true;
                            return false;
                        });

                        // Ordenar clases por horario de menor a mayor
                        const sorted = filtered.sort((a, b) => {
                            const timeA = a.start || '00:00';
                            const timeB = b.start || '00:00';
                            return timeA.localeCompare(timeB);
                        });

                        container.innerHTML = sorted.map(c => `
                            <label style="display:block;padding:8px;border-bottom:1px solid #eee">
                                <input type="checkbox" value="${esc(c._id)}" class="newUserClass" />
                                ${esc((c.days || []).join(', '))} ${esc(c.start || '')}${c.start ? ' hrs' : ''}${c.roomName ? ' - ' + esc(c.roomName) : ''}
                            </label>
                        `).join('');

                        // attach scroll-fade behavior: show subtle top/bottom gradients when applicable
                        function updateScrollFades(ctn) {
                            try {
                                const top = ctn.scrollTop > 2;
                                const bottom = ctn.scrollTop + ctn.clientHeight < ctn.scrollHeight - 2;
                                ctn.classList.toggle('has-top', top);
                                ctn.classList.toggle('has-bottom', bottom);
                            } catch (e) { }
                        }

                        if (!container._scrollFadeAttached) {
                            container.addEventListener('scroll', () => updateScrollFades(container));
                            container._scrollFadeAttached = true;
                        }
                        // compute initial state
                        updateScrollFades(container);
                    } catch (err) {
                        container.innerHTML = '<i>Error cargando clases</i>';
                    }
                };

                // small debounce wrapper used by the search control
                function scheduleRefresh() {
                    try { if (_refreshTimer) clearTimeout(_refreshTimer); _refreshTimer = setTimeout(() => { try { window.refreshNewUserClasses(); } catch (e) { } }, 180); } catch (e) { }
                }

                // wire up the new single search input
                try {
                    const usersSection = document.getElementById('usersSection');
                    usersSection.addEventListener('input', (e) => {
                        if (!e.target) return;
                        if (e.target.id === 'newUserClassSearch') scheduleRefresh();
                    });
                } catch (e) { /* ignore wiring errors */ }

                // populate initially
                try { window.refreshNewUserClasses().catch(() => { }); } catch (e) { /* ignore */ }
            })();

            function toggleAlumnoFields() {
                const role = document.getElementById('newUserRole').value;
                // Show emergency contact for both alumnos and profesores
                const showEmergency = role === 'alumno' || role === 'profesor';
                document.getElementById('newUserEmergency').closest('div').style.display = showEmergency ? '' : 'none';
                const isAlumno = role === 'alumno';
                const isProfesor = role === 'profesor';
                // membership and due date only for alumnos
                document.getElementById('newUserMembership').closest('div').style.display = isAlumno ? '' : 'none';
                document.getElementById('newUserDueDate').closest('div').style.display = isAlumno ? '' : 'none';
                // classes can be assigned to both alumnos (required) and profesores (optional)
                document.getElementById('classesDivInline').style.display = (isAlumno || isProfesor) ? '' : 'none';
                // show the red asterisk only when creating an alumno (classes required)
                try {
                    const asteriskEl = document.getElementById('classesRequiredAsterisk');
                    if (asteriskEl) asteriskEl.style.display = isAlumno ? '' : 'none';
                } catch (e) { }
            }

            // Delegate events
            document.getElementById('usersSection').addEventListener('change', (e) => {
                if (e.target && e.target.id === 'newUserRole') toggleAlumnoFields();
            });

            // removed cancel button: users now only save via the Guardar button

            document.getElementById('usersSection').addEventListener('submit', async (e) => {
                if (e.target && e.target.id === 'createUserForm') {
                    e.preventDefault();
                    const role = document.getElementById('newUserRole').value;
                    const user = {
                        dni: document.getElementById('newUserDni').value.trim(),
                        name: document.getElementById('newUserName').value.trim(),
                        lastName: document.getElementById('newUserLastName').value.trim(),
                        phone: document.getElementById('newUserPhone').value.trim(),
                    };
                    if (!user.dni || !user.name || !user.lastName) return showToast('DNI, nombre y apellido son requeridos', 'error');
                    if (role === 'alumno') {
                        user.emergencyContact = document.getElementById('newUserEmergency').value.trim();
                        user.membershipType = document.getElementById('newUserMembership').value;
                        user.dueDate = document.getElementById('newUserDueDate').value;
                        user.classIds = Array.from(document.querySelectorAll('.newUserClass:checked')).map(cb => cb.value);
                        // Validar que al menos una clase esté seleccionada
                        if (!Array.isArray(user.classIds) || user.classIds.length === 0) {
                            return showToast('Debe asignar al menos una clase al crear un alumno', 'error');
                        }
                        try {
                            await adminStudents.createStudent(user);
                            showToast('Alumno creado', 'success');
                            document.getElementById('createUserForm').reset();
                            await loadStudents();
                            await loadClasses();
                        } catch (err) { showToast(err.message || 'Error creando alumno', 'error'); }
                    } else if (role === 'profesor') {
                        // include emergency contact for professors as well
                        user.emergencyContact = document.getElementById('newUserEmergency').value.trim();
                        // optional: allow assigning classes to the new professor (not mandatory)
                        const selectedClassIds = Array.from(document.querySelectorAll('.newUserClass:checked')).map(cb => cb.value);
                        try {
                            const created = await adminProfessors.createProfessor(user);
                            const newProfId = created.id || created._id || null;
                            // assign professor to selected classes (ignore per-class errors)
                            if (newProfId && Array.isArray(selectedClassIds) && selectedClassIds.length) {
                                for (const cid of selectedClassIds) {
                                    try { await adminClasses.assignProfessor(cid, newProfId); } catch (er) { /* ignore per-class errors */ }
                                }
                            }
                            showToast('Profesor creado', 'success');
                            document.getElementById('createUserForm').reset();
                            await loadProfessors();
                            await loadClasses();
                        } catch (err) { showToast(err.message || 'Error creando profesor', 'error'); }
                    }
                }
            });
            // set initial field visibility according to default role
            toggleAlumnoFields();
        })();
    </script>
    <script>
        const ensure = pilatesAuth.ensureRole(['administrador', 'superusuario']);
        ensure().then(async me => {
            document.getElementById('meInfo').textContent = `${me.email || me.dni} (${me.role})`;
            await loadRooms();
        });

        // Attach a simple, robust logout handler: perform the logout directly
        // (clear storage + navigate) to avoid depending on other modules.
        (function () {
            function directLogout() {
                try {
                    localStorage.removeItem('token');
                    localStorage.removeItem('role');
                } catch (e) { console.error('Clearing storage failed', e); }
                // replace so back button won't return to admin state
                window.location.replace('/index.html');
            }

            // Modal helpers (reused from alumno UI): showModal/closeModal and helpers
            function showModal(title, message, onConfirm) {
                const modalHTML = `
                    <div class="modal">
                        <div class="modal-content">
                            <h3>${title}</h3>
                            <p>${message}</p>
                            <div class="modal-actions">
                                <button onclick="closeModal()" style="background:#e2e8f0;color:#475569;box-shadow:none;">Cancelar</button>
                                <button onclick="confirmModal()">Confirmar</button>
                            </div>
                        </div>
                    </div>
                `;
                let container = document.getElementById('modalContainer');
                if (!container) {
                    container = document.createElement('div');
                    container.id = 'modalContainer';
                    document.body.appendChild(container);
                }
                container.innerHTML = modalHTML;
                window.modalConfirmCallback = onConfirm;
                window._modalOpen = true;
                try { document.body.classList.add('modal-open-no-shift'); } catch (e) { }
            }

            function closeModal() {
                const container = document.getElementById('modalContainer');
                if (container) container.innerHTML = '';
                window.modalConfirmCallback = null;
                window._modalOpen = false;
                try { document.body.classList.remove('modal-open-no-shift'); } catch (e) { }
            }

            function showOkModal(title, message, onOk) {
                const modalHTML = `
                    <div class="modal">
                        <div class="modal-content">
                            <h3>${title}</h3>
                            <p>${message}</p>
                            <div class="modal-actions" style="justify-content:center;">
                                <button onclick="okModalClick()" style="background:#667eea;color:#fff;">Aceptar</button>
                            </div>
                        </div>
                    </div>
                `;
                let container = document.getElementById('modalContainer');
                if (!container) {
                    container = document.createElement('div');
                    container.id = 'modalContainer';
                    document.body.appendChild(container);
                }
                container.innerHTML = modalHTML;
                window._modalOpen = true;
                try { document.body.classList.add('modal-open-no-shift'); } catch (e) { }
                window._okModalCallback = onOk;
            }

            function okModalClick() {
                try {
                    if (window._okModalCallback) window._okModalCallback();
                } finally {
                    const container = document.getElementById('modalContainer');
                    if (container) container.innerHTML = '';
                    window._okModalCallback = null;
                    window._modalOpen = false;
                    try { document.body.classList.remove('modal-open-no-shift'); } catch (e) { }
                }
            }

            function confirmModal() {
                if (window.modalConfirmCallback) {
                    try { window.modalConfirmCallback(); } catch (e) { console.error(e); }
                }
                closeModal();
            }
            // Expose modal helpers to global scope so inline onclick handlers work
            try {
                window.showModal = showModal;
                window.closeModal = closeModal;
                window.showOkModal = showOkModal;
                window.okModalClick = okModalClick;
                window.confirmModal = confirmModal;
            } catch (e) { /* ignore in non-browser env */ }

            function bindButton(btn) {
                // Use pointerdown in capture phase to intercept the user's action
                // before other handlers can close/hide the sidebar.
                const onPointerDown = function (e) {
                    try { e.preventDefault(); e.stopImmediatePropagation(); } catch (er) { }
                    showModal('Cerrar sesión', '¿Desea cerrar sesión?', directLogout);
                };
                // attach in capture so it runs early
                btn.addEventListener('pointerdown', onPointerDown, { capture: true });
                // also keep a capture click listener as backup
                btn.addEventListener('click', function (e) {
                    try { e.preventDefault(); e.stopImmediatePropagation(); } catch (er) { }
                    showModal('Cerrar sesión', '¿Desea cerrar sesión?', directLogout);
                }, { capture: true });
            }

            const btn = document.getElementById('logout');
            if (btn) {
                bindButton(btn);
            } else {
                // fallback: delegate on capture so we catch early if button is injected later
                document.addEventListener('click', function (e) {
                    const t = e.target;
                    if (!t) return;
                    if (t.id === 'logout' || (t.closest && t.closest('#logout'))) {
                        e.preventDefault();
                        e.stopPropagation();
                        showModal('Cerrar sesión', '¿Desea cerrar sesión?', directLogout);
                    }
                }, { capture: true });
            }
        })();

        async function loadRooms(filter = '') {
            try {
                const rooms = await adminRooms.listRooms();
                renderRooms(rooms.filter(r => r.name.toLowerCase().includes(filter.toLowerCase())));
            } catch (err) {
                document.getElementById('roomsList').textContent = 'Error cargando salones';
            }
        }
        // helper to escape inserted text
        function esc(s) { return String(s == null ? '' : s).replace(/&/g, '&amp;').replace(/</g, '&lt;').replace(/>/g, '&gt;'); }

        // Return membership types <option> HTML using the current gym config (falls back to default types)
        function getMembershipOptionsHTML(selected) {
            const cfg = window.currentGymConfig || {};
            const types = Array.isArray(cfg.membershipTypes) && cfg.membershipTypes.length ? cfg.membershipTypes : ['Pilates en camilla'];
            return types.map(t => `<option value="${esc(t)}" ${selected === t ? 'selected' : ''}>${esc(t.charAt(0).toUpperCase() + t.slice(1))}</option>`).join('');
        }

        // Lightweight toast helper for inline, aesthetic alerts
        function showToast(message, type = 'info', timeout = 3500) {
            try {
                let container = document.getElementById('toastContainer');
                if (!container) {
                    container = document.createElement('div');
                    container.id = 'toastContainer';
                    container.className = 'toast-container';
                    document.body.appendChild(container);
                }
                const t = document.createElement('div');
                t.className = 'toast ' + (type || 'info');
                t.textContent = message;
                container.appendChild(t);
                // auto remove
                setTimeout(() => {
                    try { t.style.transition = 'opacity .18s ease, transform .18s ease'; t.style.opacity = '0'; t.style.transform = 'translateY(-6px)'; } catch (e) { }
                    setTimeout(() => t.remove(), 220);
                }, timeout);
            } catch (e) { try { alert(message); } catch (_) { /* noop */ } }
        }

        // Update any existing membership <select> elements on the page so they reflect currentGymConfig
        function updateMembershipSelects() {
            try {
                const selIds = ['newUserMembership', 'newStudentMembership', 'editStudentMembership'];
                for (const id of selIds) {
                    const el = document.getElementById(id);
                    if (!el) continue;
                    const current = el.value;
                    el.innerHTML = getMembershipOptionsHTML(current);
                }
                // Also update any selects created dynamically inside modals that match the class 'membership-select'
                document.querySelectorAll('select.membership-select').forEach(s => {
                    const cur = s.value;
                    s.innerHTML = getMembershipOptionsHTML(cur);
                });
            } catch (e) { /* ignore */ }
        }

        function renderRooms(rooms) {
            const container = document.getElementById('roomsList');
            if (!rooms.length) { container.innerHTML = '<i>No hay salones</i>'; return }
            // Sort rooms by creation time (most recent first). Prefer createdAt, fall back to ObjectId timestamp
            function createdTs(r) {
                try {
                    if (!r) return 0;
                    if (r.createdAt) return new Date(r.createdAt).getTime();
                    if (r._id && String(r._id).length >= 8) return parseInt(String(r._id).slice(0, 8), 16) * 1000;
                } catch (e) { }
                return 0;
            }
            rooms.sort((a, b) => (createdTs(b) || 0) - (createdTs(a) || 0));
            // always show cards
            const cards = rooms.map(r => `
                <div class="item-card" data-id="${esc(r._id)}">
                    <div>
                        <h4>${esc(r.name)}</h4>
                        <div class="meta">Camillas: ${esc(r.capacity)}</div>
                    </div>
                    <div class="actions">
                        <button class="editRoom btn-edit">Editar</button>
                        <button class="delRoom btn-delete">Eliminar</button>
                    </div>
                </div>
            `).join('');
            container.innerHTML = `<div class="cards-grid">${cards}</div>`;

            container.querySelectorAll('.editRoom').forEach(b => b.addEventListener('click', e => {
                const card = e.target.closest('.item-card');
                const id = card.dataset.id;
                const name = card.querySelector('h4')?.textContent || '';
                const capText = card.querySelector('.meta')?.textContent || '';
                const capacity = (capText.match(/\d+/) || [''])[0];
                openEditRoomModal(id, name, capacity);
            }));

            container.querySelectorAll('.delRoom').forEach(b => b.addEventListener('click', async e => {
                const id = e.target.closest('.item-card').dataset.id;
                try {
                    window.showModal('Eliminar salón', '¿Desea eliminar el salón?', async function () {
                        try {
                            await adminRooms.deleteRoom(id);
                            showToast('Salón eliminado', 'success');
                            await loadRooms(document.getElementById('searchRooms').value);
                        } catch (err) {
                            showToast(err && err.message ? err.message : 'Error eliminando salón', 'error');
                        }
                    });
                } catch (err) {
                    // fallback to native confirm
                    if (!confirm('Eliminar salón?')) return;
                    try {
                        await adminRooms.deleteRoom(id);
                        showToast('Salón eliminado', 'success');
                        await loadRooms(document.getElementById('searchRooms').value);
                    } catch (e) {
                        showToast(e && e.message ? e.message : 'Error eliminando salón', 'error');
                    }
                }
            }));
        }

        document.getElementById('btnNewRoom').addEventListener('click', () => openNewRoomModal());
        document.getElementById('searchRooms').addEventListener('input', (e) => loadRooms(e.target.value));

        function openNewRoomModal() {
            const modal = document.createElement('div');
            modal.style = 'position:fixed;inset:0;background:rgba(0,0,0,0.35);display:flex;align-items:center;justify-content:center';
            modal.innerHTML = `
                    <div style="background:#fff;padding:16px;border-radius:8px;width:360px">
                        <h4>Nuevo salón</h4>
                        <input id="newRoomName" placeholder="Nombre" style="width:100%;padding:8px;margin:8px 0;border:1px solid #ddd;border-radius:4px" />
                        <input id="newRoomCapacity" type="number" placeholder="Cantidad de camillas" style="width:100%;padding:8px;margin:8px 0;border:1px solid #ddd;border-radius:4px" />
                        <div style="display:flex;gap:8px;justify-content:flex-end"><button id="cancelNew">Cancelar</button><button id="saveNew" style="background:#2b6cb0;color:#fff">Guardar</button></div>
                    </div>`;
            document.body.appendChild(modal);
            document.getElementById('cancelNew').addEventListener('click', () => modal.remove());
            document.getElementById('saveNew').addEventListener('click', async () => {
                const name = document.getElementById('newRoomName').value.trim();
                const capacity = document.getElementById('newRoomCapacity').value;
                if (!name || !capacity) return showToast('Completá nombre y capacidad', 'error');
                try {
                    await adminRooms.createRoom(name, Number(capacity));
                    modal.remove();
                    showToast('Salón creado', 'success');
                    await loadRooms();
                } catch (err) {
                    showToast(err && err.message ? err.message : 'Error creando salón', 'error');
                }
            });
        }

        function openEditRoomModal(id, name, capacity) {
            const modal = document.createElement('div');
            modal.style = 'position:fixed;inset:0;background:rgba(0,0,0,0.35);display:flex;align-items:center;justify-content:center';
            modal.innerHTML = `
                    <div style="background:#fff;padding:16px;border-radius:8px;width:360px">
                        <h4>Editar salón</h4>
                        <input id="editRoomName" value="${name}" style="width:100%;padding:8px;margin:8px 0;border:1px solid #ddd;border-radius:4px" />
                        <input id="editRoomCapacity" type="number" value="${capacity}" style="width:100%;padding:8px;margin:8px 0;border:1px solid #ddd;border-radius:4px" />
                        <div style="display:flex;gap:8px;justify-content:flex-end"><button id="cancelEdit">Cancelar</button><button id="saveEdit" style="background:#2b6cb0;color:#fff">Guardar</button></div>
                    </div>`;
            document.body.appendChild(modal);
            document.getElementById('cancelEdit').addEventListener('click', () => modal.remove());
            document.getElementById('saveEdit').addEventListener('click', async () => {
                const newName = document.getElementById('editRoomName').value.trim();
                const newCap = document.getElementById('editRoomCapacity').value;
                if (!newName || !newCap) return showToast('Completá nombre y capacidad', 'error');
                try {
                    await adminRooms.updateRoom(id, newName, Number(newCap));
                    modal.remove();
                    showToast('Salón actualizado', 'success');
                    await loadRooms();
                } catch (err) {
                    showToast(err && err.message ? err.message : 'Error actualizando salón', 'error');
                }
            });
        }
    </script>

    <script>
        // Clases
        async function loadClasses(filter = '') {
            try {
                const classes = await adminClasses.listClasses();
                // helper to obtain creation timestamp: prefer createdAt, fall back to ObjectId timestamp
                function createdTs(c) {
                    try {
                        if (!c) return 0;
                        if (c.createdAt) return new Date(c.createdAt).getTime();
                        if (c._id && String(c._id).length >= 8) return parseInt(String(c._id).slice(0, 8), 16) * 1000;
                    } catch (e) { }
                    return 0;
                }
                // Sort classes in-place: most recent first
                classes.sort((a, b) => (createdTs(b) || 0) - (createdTs(a) || 0));
                const q = (filter || '').toString().trim().toLowerCase();
                // helper to normalize accents for day matching
                function norm(s) {
                    if (!s) return '';
                    try {
                        return s.toString().normalize('NFD').replace(/[\u0300-\u036f]/g, '').toLowerCase();
                    } catch (e) {
                        return s.toString().toLowerCase();
                    }
                }

                const filtered = classes.filter(c => {
                    if (!q) return true;
                    const roomName = (c.roomName || '').toLowerCase();
                    const profName = (c.professorName || '').toLowerCase();
                    const start = (c.start || '').toString().toLowerCase();
                    const daysText = Array.isArray(c.days) ? c.days.join(' ').toLowerCase() : (c.days || '').toString().toLowerCase();

                    // Normalize for accent-insensitive comparison
                    const normDays = norm(daysText);
                    const normQ = norm(q);

                    // match room, professor, start (time) or days
                    if (roomName.includes(q) || profName.includes(q)) return true;
                    if (start.includes(q) || start.startsWith(q)) return true;
                    if (normDays.includes(normQ)) return true;
                    // allow searching by partial day names (e.g., 'lun' -> 'lunes')
                    const dayMatches = Array.isArray(c.days) && c.days.some(d => norm(d).includes(normQ));
                    if (dayMatches) return true;
                    return false;
                });

                renderClasses(filtered);
                // If the create-user form exists, refresh its classes list so new classes appear without reload
                try { if (window.refreshNewUserClasses) window.refreshNewUserClasses(); } catch (e) { /* ignore */ }
            } catch (err) { document.getElementById('classesList').textContent = 'Error cargando clases' }
        }

        function renderClasses(classes) {
            const container = document.getElementById('classesList');
            if (!classes.length) { container.innerHTML = '<i>No hay clases</i>'; return }
            
            // Ordenar clases por horario de menor a mayor
            const sortedClasses = classes.sort((a, b) => {
                const timeA = a.start || '00:00';
                const timeB = b.start || '00:00';
                return timeA.localeCompare(timeB);
            });
            
            // always render cards
            const cards = sortedClasses.map(c => `
                <div class="item-card" data-id="${esc(c._id)}">
                    <div>
                        <h4>${esc((c.days || []).join(', '))}${c.start ? ' - ' + esc(c.start + ' hrs') : ''}</h4>
                        <div class="meta">Salón: ${esc(c.roomName || '')} • Profesor: ${esc(c.professorName || '')}</div>
                        <div class="meta">Camillas libres: ${esc(c.camillasFree)}</div>
                    </div>
                    <div class="actions">
                        <button class="editClass btn-edit">Editar</button>
                        <button class="manageStudents btn-manage">Alumnos</button>
                        <button class="delClass btn-delete">Eliminar</button>
                    </div>
                </div>
            `).join('');
            container.innerHTML = `<div class="cards-grid">${cards}</div>`;

            container.querySelectorAll('.editClass').forEach(b => b.addEventListener('click', e => {
                const id = e.target.closest('.item-card').dataset.id;
                openEditClassModal(id);
            }));

            container.querySelectorAll('.delClass').forEach(b => b.addEventListener('click', async e => {
                const id = e.target.closest('.item-card').dataset.id;
                try {
                    window.showModal('Eliminar clase', '¿Desea eliminar la clase?', async function () {
                        try {
                            await adminClasses.deleteClass(id);
                            showToast('Clase eliminada', 'success');
                            await loadClasses(document.getElementById('searchClasses').value);
                            // notify other tabs about classes change
                            try { const bc = new BroadcastChannel('pilates-updates'); bc.postMessage({ type: 'classes' }); } catch (e) { }
                        } catch (err) {
                            showToast(err && err.message ? err.message : 'Error eliminando clase', 'error');
                        }
                    });
                } catch (err) {
                    // fallback
                    if (!confirm('Eliminar clase?')) return;
                    try {
                        await adminClasses.deleteClass(id);
                        showToast('Clase eliminada', 'success');
                        await loadClasses(document.getElementById('searchClasses').value);
                        // notify other tabs about classes change
                        try { const bc = new BroadcastChannel('pilates-updates'); bc.postMessage({ type: 'classes' }); } catch (e) { }
                    } catch (e) {
                        showToast(e && e.message ? e.message : 'Error eliminando clase', 'error');
                    }
                }
            }));

            container.querySelectorAll('.manageStudents').forEach(b => b.addEventListener('click', e => {
                const id = e.target.closest('.item-card').dataset.id;
                openManageStudentsModal(id);
            }));
        }

        document.getElementById('btnNewClass').addEventListener('click', () => openNewClassModal());
        document.getElementById('searchClasses').addEventListener('input', (e) => loadClasses(e.target.value));

        async function openNewClassModal() {
            // fetch rooms and professors
            const rooms = await adminRooms.listRooms();
            const profs = await fetch('/api/users?role=profesor', { headers: { Authorization: `Bearer ${localStorage.getItem('token')}` } }).then(r => r.json());
            const modal = document.createElement('div');
            modal.style = 'position:fixed;inset:0;background:rgba(0,0,0,0.35);display:flex;align-items:center;justify-content:center';
            modal.innerHTML = `
                    <div style="background:#fff;padding:16px;border-radius:8px;width:420px">
                        <h4>Crear clase</h4>
                        <div style="margin:6px 0 8px;font-size:14px;color:#374151">Días</div>
                        <div id="classDays" style="display:flex;gap:8px;flex-wrap:wrap;margin-bottom:10px">
                            <button type="button" class="day-toggle" data-day="lunes" style="padding:8px 12px;border-radius:8px;border:1px solid #e5e7eb;background:#fff;color:#111">lun</button>
                            <button type="button" class="day-toggle" data-day="martes" style="padding:8px 12px;border-radius:8px;border:1px solid #e5e7eb;background:#fff;color:#111">mar</button>
                            <button type="button" class="day-toggle" data-day="miercoles" style="padding:8px 12px;border-radius:8px;border:1px solid #e5e7eb;background:#fff;color:#111">mié</button>
                            <button type="button" class="day-toggle" data-day="jueves" style="padding:8px 12px;border-radius:8px;border:1px solid #e5e7eb;background:#fff;color:#111">jue</button>
                            <button type="button" class="day-toggle" data-day="viernes" style="padding:8px 12px;border-radius:8px;border:1px solid #e5e7eb;background:#fff;color:#111">vie</button>
                            <button type="button" class="day-toggle" data-day="sabado" style="padding:8px 12px;border-radius:8px;border:1px solid #e5e7eb;background:#fff;color:#111">sáb</button>
                            <button type="button" class="day-toggle" data-day="domingo" style="padding:8px 12px;border-radius:8px;border:1px solid #e5e7eb;background:#fff;color:#111">dom</button>
                        </div>
                        <input id="classStart" type="time" step="300" placeholder="Horario" style="width:100%;padding:8px;margin:8px 0;border:1px solid #ddd;border-radius:4px" />
                        <select id="classRoom" style="width:100%;padding:8px;margin:8px 0;border:1px solid #ddd;border-radius:4px">
                            <option value="">Salón</option>
                            ${rooms.map(r => `<option value="${r._id}">${r.name}</option>`).join('')}
                        </select>
                        <select id="classProf" style="width:100%;padding:8px;margin:8px 0;border:1px solid #ddd;border-radius:4px">
                            <option value="">Profesor</option>
                            ${profs.map(p => `<option value="${p._id}">${p.name}</option>`).join('')}
                        </select>
                        <div style="display:flex;gap:8px;justify-content:flex-end"><button id="cancelClass">Cancelar</button><button id="saveClass" style="background:#2b6cb0;color:#fff">Crear</button></div>
                    </div>`;
            document.body.appendChild(modal);
            const cancelBtn = modal.querySelector('#cancelClass');
            if (cancelBtn) cancelBtn.addEventListener('click', () => modal.remove());

            // day toggle behaviour
            (function bindDayToggles(containerId) {
                const container = modal.querySelector('#' + containerId);
                if (!container) { console.warn('[DEBUG] classDays container not found in modal for', containerId); return; }
                const toggles = Array.from(container.querySelectorAll('.day-toggle'));
                console.log('[DEBUG] classDays toggles count:', toggles.length);
                toggles.forEach(btn => {
                    const day = btn.getAttribute('data-day');
                    btn.addEventListener('click', () => {
                        const active = btn.classList.toggle('active');
                        console.log('[DEBUG] day-toggle clicked:', day, 'nowActive=', active);
                        if (active) {
                            btn.style.background = '#2563eb'; btn.style.color = '#fff'; btn.style.borderColor = '#2563eb';
                        } else {
                            btn.style.background = '#fff'; btn.style.color = '#111'; btn.style.borderColor = '#e5e7eb';
                        }
                    });
                });
            })('classDays');

            // Log initial modal elements for debugging
            try {
                console.log('[DEBUG] modal elements:', {
                    classDaysEl: modal.querySelector('#classDays') ? true : false,
                    classStartEl: modal.querySelector('#classStart') ? true : false,
                    classRoomEl: modal.querySelector('#classRoom') ? modal.querySelector('#classRoom').options.length : 0,
                    classProfEl: modal.querySelector('#classProf') ? modal.querySelector('#classProf').options.length : 0
                });
            } catch (e) { console.warn('[DEBUG] error logging modal elements', e); }

            // Auto-close native time picker: blur input when a full HH:MM value is selected
            try {
                const startInput = modal.querySelector('#classStart');
                if (startInput) {
                    const _onTimePicked = () => {
                        try {
                            const v = (startInput.value || '').trim();
                            if (/^\d{2}:\d{2}$/.test(v)) {
                                setTimeout(() => { try { startInput.blur(); } catch (e) { } }, 40);
                            }
                        } catch (e) { }
                    };
                    startInput.addEventListener('change', _onTimePicked);
                    startInput.addEventListener('input', _onTimePicked);
                }
            } catch (e) { }

            function getSelectedDays(containerId) {
                const c = modal.querySelector('#' + containerId);
                if (!c) return [];
                return Array.from(c.querySelectorAll('.day-toggle.active')).map(b => b.getAttribute('data-day'));
            }

            const saveBtn = modal.querySelector('#saveClass');
            if (saveBtn) saveBtn.addEventListener('click', async () => {
                const days = getSelectedDays('classDays');
                const startEl = modal.querySelector('#classStart');
                const start = startEl ? startEl.value.trim() : '';
                const durationEl = modal.querySelector('#classDuration');
                const roomEl = modal.querySelector('#classRoom');
                const profEl = modal.querySelector('#classProf');
                const roomId = roomEl ? roomEl.value : '';
                const professorId = profEl ? (profEl.value || null) : null;

                // Diagnostic logging to help identify why fields appear empty
                console.log('[DEBUG] Crear clase payload values:', { days, start, roomId, professorId });

                const missing = [];
                if (!days || !days.length) missing.push('días');
                if (!start) missing.push('horario');
                if (missing.length) {
                    const msg = 'Faltan datos requeridos: ' + missing.join(', ');
                    showToast(msg, 'error');
                    // also log to console for easier debugging
                    console.warn('[VALIDATION] createClass missing fields:', missing);
                    return;
                }

                try {
                    // duration is optional now — omit it when not provided
                    const payload = { days, start, professorId };
                    if (roomId) payload.roomId = roomId;
                    if (durationEl) {
                        const durationVal = durationEl.value;
                        if (durationVal) payload.duration = Number(durationVal);
                    }
                    await adminClasses.createClass(payload);
                    modal.remove();
                    showToast('Clase creada', 'success');
                    await loadClasses();
                    // notify other tabs (professors) about classes change
                    try { const bc = new BroadcastChannel('pilates-updates'); bc.postMessage({ type: 'classes' }); } catch (e) { }
                } catch (err) {
                    showToast(err && err.message ? err.message : 'Error creando clase', 'error');
                }
            });
        }

        async function openEditClassModal(id) {
            const classes = await adminClasses.listClasses();
            const c = classes.find(x => x._id === id || x._id == id);
            if (!c) {
                showToast('Clase no encontrada', 'error');
                return;
            }
            const rooms = await adminRooms.listRooms();
            const profs = await fetch('/api/users?role=profesor', { headers: { Authorization: `Bearer ${localStorage.getItem('token')}` } }).then(r => r.json());
            const modal = document.createElement('div');
            modal.style = 'position:fixed;inset:0;background:rgba(0,0,0,0.35);display:flex;align-items:center;justify-content:center';
            modal.innerHTML = `
                    <div style="background:#fff;padding:16px;border-radius:8px;width:420px">
                        <h4>Editar clase</h4>
                        <div style="margin:6px 0 8px;font-size:14px;color:#374151">Días</div>
                        <div id="classDaysEdit" style="display:flex;gap:8px;flex-wrap:wrap;margin-bottom:10px">
                            <button type="button" class="day-toggle" data-day="lunes" style="padding:8px 12px;border-radius:8px;border:1px solid #e5e7eb;background:#fff;color:#111">lun</button>
                            <button type="button" class="day-toggle" data-day="martes" style="padding:8px 12px;border-radius:8px;border:1px solid #e5e7eb;background:#fff;color:#111">mar</button>
                            <button type="button" class="day-toggle" data-day="miercoles" style="padding:8px 12px;border-radius:8px;border:1px solid #e5e7eb;background:#fff;color:#111">mié</button>
                            <button type="button" class="day-toggle" data-day="jueves" style="padding:8px 12px;border-radius:8px;border:1px solid #e5e7eb;background:#fff;color:#111">jue</button>
                            <button type="button" class="day-toggle" data-day="viernes" style="padding:8px 12px;border-radius:8px;border:1px solid #e5e7eb;background:#fff;color:#111">vie</button>
                            <button type="button" class="day-toggle" data-day="sabado" style="padding:8px 12px;border-radius:8px;border:1px solid #e5e7eb;background:#fff;color:#111">sáb</button>
                            <button type="button" class="day-toggle" data-day="domingo" style="padding:8px 12px;border-radius:8px;border:1px solid #e5e7eb;background:#fff;color:#111">dom</button>
                        </div>
                        <input id="classStartEdit" type="time" step="300" value="${c.start}" placeholder="Horario" style="width:100%;padding:8px;margin:8px 0;border:1px solid #ddd;border-radius:4px" />
                        <select id="classRoomEdit" style="width:100%;padding:8px;margin:8px 0;border:1px solid #ddd;border-radius:4px">
                            <option value="">Salón</option>
                            ${rooms.map(r => `<option value="${r._id}" ${c.roomId == r._id ? 'selected' : ''}>${r.name}</option>`).join('')}
                        </select>
                        <select id="classProfEdit" style="width:100%;padding:8px;margin:8px 0;border:1px solid #ddd;border-radius:4px">
                            <option value="">Profesor</option>
                            ${profs.map(p => `<option value="${p._id}" ${c.professorId == p._id ? 'selected' : ''}>${p.name}</option>`).join('')}
                        </select>
                        <div style="display:flex;gap:8px;justify-content:flex-end"><button id="cancelClassEdit">Cancelar</button><button id="saveClassEdit" style="background:#2b6cb0;color:#fff">Guardar</button></div>
                    </div>`;
            document.body.appendChild(modal);
            const cancelEditBtn = modal.querySelector('#cancelClassEdit');
            if (cancelEditBtn) cancelEditBtn.addEventListener('click', () => modal.remove());

            // bind toggles and preselect based on existing days
            (function bindAndPreselect(containerId, selectedDays) {
                const container = modal.querySelector('#' + containerId);
                if (!container) return;
                container.querySelectorAll('.day-toggle').forEach(btn => {
                    const day = btn.getAttribute('data-day');
                    if (selectedDays && selectedDays.includes(day)) {
                        btn.classList.add('active'); btn.style.background = '#2563eb'; btn.style.color = '#fff'; btn.style.borderColor = '#2563eb';
                    }
                    btn.addEventListener('click', () => {
                        const active = btn.classList.toggle('active');
                        if (active) { btn.style.background = '#2563eb'; btn.style.color = '#fff'; btn.style.borderColor = '#2563eb'; }
                        else { btn.style.background = '#fff'; btn.style.color = '#111'; btn.style.borderColor = '#e5e7eb'; }
                    });
                });
            })('classDaysEdit', c.days || []);

            // Auto-close native time picker in edit modal when a full HH:MM is chosen
            try {
                const startInputEdit = modal.querySelector('#classStartEdit');
                if (startInputEdit) {
                    const _onTimePickedEdit = () => {
                        try {
                            const v = (startInputEdit.value || '').trim();
                            if (/^\d{2}:\d{2}$/.test(v)) {
                                setTimeout(() => { try { startInputEdit.blur(); } catch (e) { } }, 40);
                            }
                        } catch (e) { }
                    };
                    startInputEdit.addEventListener('change', _onTimePickedEdit);
                    startInputEdit.addEventListener('input', _onTimePickedEdit);
                }
            } catch (e) { }

            function getSelectedDaysEdit(containerId) {
                const ctn = modal.querySelector('#' + containerId);
                if (!ctn) return [];
                return Array.from(ctn.querySelectorAll('.day-toggle.active')).map(b => b.getAttribute('data-day'));
            }

            const saveEditBtn = modal.querySelector('#saveClassEdit');
            if (saveEditBtn) saveEditBtn.addEventListener('click', async () => {
                const days = getSelectedDaysEdit('classDaysEdit');
                const startEl = modal.querySelector('#classStartEdit');
                const start = startEl ? startEl.value.trim() : '';
                const roomEl = modal.querySelector('#classRoomEdit');
                const profEl = modal.querySelector('#classProfEdit');
                const roomId = roomEl ? roomEl.value : '';
                const professorId = profEl ? (profEl.value || null) : null;
                if (!days.length || !start) return showToast('Completá los campos obligatorios: días y horario', 'error');
                try {
                    const payload = { days, start, professorId };
                    if (roomId) payload.roomId = roomId;
                    // duration is optional — only include if an input exists and has a value
                    const durEl = modal.querySelector('#classDurationEdit');
                    if (durEl && durEl.value) payload.duration = Number(durEl.value);
                    await adminClasses.updateClass(id, payload);
                    modal.remove();
                    showToast('Clase actualizada', 'success');
                    await loadClasses();
                    // refrescar panel de profesores para ver asignaciones sin recargar
                    try { await loadProfessors(); } catch (e) { console.warn('No se pudo refrescar profesores', e); }
                    // notify other tabs about classes change
                    try { const bc = new BroadcastChannel('pilates-updates'); bc.postMessage({ type: 'classes' }); } catch (e) { }
                } catch (err) {
                    showToast(err && err.message ? err.message : 'Error actualizando clase', 'error');
                }
            });
        }

        // inicializar
        async function openManageStudentsModal(classId) {
            // Obtener los estudiantes actuales de la clase
            const students = await adminClasses.getClassStudents(classId);

            // Obtener todos los estudiantes disponibles
            const allStudents = await fetch('/api/users?role=alumno', {
                headers: { Authorization: `Bearer ${localStorage.getItem('token')}` }
            }).then(r => r.json());

            // Obtener los datos de la clase
            const classes = await adminClasses.listClasses();
            const classInfo = classes.find(c => c._id === classId);

            const modal = document.createElement('div');
            modal.style = 'position:fixed;inset:0;background:rgba(0,0,0,0.35);display:flex;align-items:center;justify-content:center';
            modal.innerHTML = `
                <div style="background:#fff;padding:16px;border-radius:8px;width:480px;max-height:90vh;overflow-y:auto">
                    <h4>Gestionar Estudiantes - ${esc((classInfo.days || []).join(', '))}${classInfo.start ? ' - ' + esc(classInfo.start) + ' hrs' : ''}</h4>
                    
                    <div style="margin:16px 0">
                        <div>Agregar estudiante:</div>
                        <div style="display:flex;gap:8px;margin-top:8px">
                            <select id="newStudent" style="flex:1;padding:8px;border:1px solid #ddd;border-radius:4px">
                                <option value="">Seleccionar estudiante...</option>
                                ${allStudents
                    .filter(s => !students.find(cs => cs._id === s._id))
                    .map(s => `<option value="${s._id}">${s.name || s.dni}</option>`)
                    .join('')}
                            </select>
                            <button id="addStudent" style="background:#48bb78;color:#fff">Agregar</button>
                        </div>
                    </div>

                    <div style="margin:16px 0">
                        <div>Estudiantes inscritos (${students.length}/${classInfo.roomName ? ` max ${classInfo.camillasFree + students.length}` : ''}):</div>
                        ${students.length ? `
                            <div class="cards-grid" style="margin-top:8px">
                                ${students.map(s => `
                                    <div class="item-card" data-id="${esc(s._id)}">
                                        <div>
                                            <h4>${esc(s.name || '')} ${esc(s.lastName || '')}</h4>
                                            <div class="meta">DNI: ${esc(s.dni || '')}</div>
                                        </div>
                                        <div class="actions">
                                            <button class="removeStudent" data-id="${esc(s._id)}" style="background:#e53e3e;color:#fff">Dar de baja</button>
                                        </div>
                                    </div>
                                `).join('')}
                            </div>
                        ` : '<div style="margin-top:8px"><i>No hay estudiantes inscritos</i></div>'}
                    </div>

                    <div style="display:flex;justify-content:flex-end;margin-top:16px">
                        <button id="closeStudents">Cerrar</button>
                    </div>
                </div>
            `;

            document.body.appendChild(modal);

            // Event listeners
            document.getElementById('closeStudents').addEventListener('click', () => modal.remove());

            document.getElementById('addStudent').addEventListener('click', async () => {
                const studentId = document.getElementById('newStudent').value;
                if (!studentId) return showToast('Selecciona un estudiante', 'error');

                try {
                    await adminClasses.addStudent(classId, studentId);
                    modal.remove();
                    showToast('Estudiante inscrito', 'success');
                    openManageStudentsModal(classId); // Reabrir modal actualizado
                    await loadClasses(); // Actualizar lista de clases
                    try { const bc = new BroadcastChannel('pilates-updates'); bc.postMessage({ type: 'classes' }); } catch (e) { }
                } catch (err) {
                    showToast(err.message || 'Error al inscribir estudiante', 'error');
                }
            });

            document.querySelectorAll('.removeStudent').forEach(btn => {
                btn.addEventListener('click', async () => {
                    const studentId = btn.dataset.id;
                    try {
                        window.showModal('Dar de baja', '¿Desea dar de baja al estudiante? Esta acción puede afectar su inscripción en clases.', async function () {
                            try {
                                await adminClasses.removeStudent(classId, studentId);
                                modal.remove();
                                showToast('Estudiante dado de baja', 'success');
                                openManageStudentsModal(classId); // Reabrir modal actualizado
                                await loadClasses(); // Actualizar lista de clases
                                try { const bc = new BroadcastChannel('pilates-updates'); bc.postMessage({ type: 'classes' }); } catch (e) { }
                            } catch (err) {
                                showToast(err && err.message ? err.message : 'Error al dar de baja estudiante', 'error');
                            }
                        });
                    } catch (err) {
                        // fallback to native confirm
                        if (!confirm('¿Dar de baja al estudiante?')) return;
                        try { await adminClasses.removeStudent(classId, studentId); modal.remove(); showToast('Estudiante dado de baja', 'success'); openManageStudentsModal(classId); await loadClasses(); } catch (e) { showToast(e && e.message ? e.message : 'Error al dar de baja estudiante', 'error'); }
                    }
                });
            });
        }

        // Gestión de Alumnos
        async function loadStudents(search = '') {
            try {
                const students = await adminStudents.listStudents(search);
                await renderStudents(students);
            } catch (err) {
                document.getElementById('studentsList').textContent = 'Error cargando alumnos';
            }
        }
        async function renderStudents(students) {
            if (!students.length) {
                document.getElementById('studentsList').innerHTML = '<i>No hay alumnos</i>';
                return;
            }
            const container = document.getElementById('studentsList');

            // fetch classes once to compute assigned classes per student
            let classes = [];
            try { classes = await adminClasses.listClasses(); } catch (e) { classes = []; }

            const cards = students.map(s => {
                // find classes where this student is assigned
                const assigned = classes
                    .filter(c => Array.isArray(c.students) && c.students.some(ss => ss === s._id || (ss && ss._id === s._id)))
                    .map(c => {
                        const days = (c.days || []).join(', ');
                        const timePart = c.start ? `${c.start} hrs` : '';
                        const roomPart = c.roomName ? ` - ${c.roomName}` : '';
                        return `${days}${timePart ? ' - ' + timePart : ''}${roomPart}`;
                    });
                const assignedText = assigned.length ? assigned.join(' | ') : 'Sin asignar';
                const dueDate = s.dueDate ? new Date(s.dueDate).toLocaleDateString() : 'No establecida';
                return `
                    <div class="item-card" data-id="${esc(s._id)}">
                        <div>
                            <h4>${esc((s.name || '') + ' ' + (s.lastName || ''))}</h4>
                            <div class="meta">DNI: ${esc(s.dni || '')} • Tel: ${esc(s.phone || '')}</div>
                            <div class="meta">Contacto emergencia: ${esc(s.emergencyContact || '')}</div>
                            <div class="meta">Vencimiento: ${esc(dueDate)} • Tipo cuota: ${esc(s.membershipType || '')}</div>
                            <div class="meta">Clases: ${esc(assignedText)}</div>
                        </div>
                        <div class="actions">
                            <button class="editStudent btn-edit">Editar</button>
                            <button class="delStudent btn-delete">Eliminar</button>
                        </div>
                    </div>
                `;
            }).join('');

            container.innerHTML = `<div class="cards-grid">${cards}</div>`;

            container.querySelectorAll('.editStudent').forEach(b => b.addEventListener('click', e => {
                const id = e.target.closest('.item-card').dataset.id;
                openEditStudentModal(id);
            }));

            container.querySelectorAll('.delStudent').forEach(b => b.addEventListener('click', async e => {
                const id = e.target.closest('.item-card').dataset.id;
                try {
                    // Use the site's styled confirmation modal. On confirm, perform deletion and show toast.
                    window.showModal('Eliminar alumno', '¿Desea eliminar al alumno? Se dará de baja de todas sus clases.', async function () {
                        try {
                            await adminStudents.deleteStudent(id);
                            showToast('Alumno eliminado', 'success');
                            await loadStudents(document.getElementById('searchStudents').value);
                            await loadClasses(); // Actualizar lista de clases
                        } catch (err) {
                            showToast(err && err.message ? err.message : 'Error eliminando alumno', 'error');
                        }
                    });
                } catch (err) {
                    // fallback to native confirm if modal helper fails
                    if (!confirm('¿Eliminar alumno? Se dará de baja de todas sus clases.')) return;
                    try {
                        await adminStudents.deleteStudent(id);
                        showToast('Alumno eliminado', 'success');
                        await loadStudents(document.getElementById('searchStudents').value);
                        await loadClasses();
                    } catch (e) {
                        showToast(e && e.message ? e.message : 'Error eliminando alumno', 'error');
                    }
                }
            }));
        }

        async function openNewStudentModal() {
            const classes = await adminClasses.listClasses();

            const modal = document.createElement('div');
            modal.style = 'position:fixed;inset:0;background:rgba(0,0,0,0.35);display:flex;align-items:center;justify-content:center';
            modal.innerHTML = `
                <div style="background:#fff;padding:16px;border-radius:8px;width:600px;max-height:90vh;overflow-y:auto">
                    <h4>Nuevo Alumno</h4>
                    
                    <div style="display:grid;grid-template-columns:1fr 1fr;gap:12px;margin:16px 0">
                        <div>
                            <div>DNI: <span class="required">*</span></div>
                                <input id="newStudentDni" style="width:100%;padding:8px;margin:4px 0;border:1px solid #ddd;border-radius:4px" />
                        </div>
                        <div>
                            <div>Nombre: <span class="required">*</span></div>
                                <input id="newStudentName" style="width:100%;padding:8px;margin:4px 0;border:1px solid #ddd;border-radius:4px" />
                        </div>
                        <div>
                            <div>Apellido: <span class="required">*</span></div>
                                <input id="newStudentLastName" style="width:100%;padding:8px;margin:4px 0;border:1px solid #ddd;border-radius:4px" />
                        </div>
                        <div>
                            <div>Teléfono:</div>
                            <input id="newStudentPhone" style="width:100%;padding:8px;margin:4px 0;border:1px solid #ddd;border-radius:4px" />
                        </div>
                        <div>
                            <div>Contacto de emergencia:</div>
                            <input id="newStudentEmergency" style="width:100%;padding:8px;margin:4px 0;border:1px solid #ddd;border-radius:4px" />
                        </div>
                        <div>
                            <div>Tipo de cuota:</div>
                            <select id="newStudentMembership" style="width:100%;padding:8px;margin:4px 0;border:1px solid #ddd;border-radius:4px">
                                ${getMembershipOptionsHTML()}
                            </select>
                        </div>
                        <div>
                            <div>Vencimiento:</div>
                            <input type="date" id="newStudentDueDate" style="width:100%;padding:8px;margin:4px 0;border:1px solid #ddd;border-radius:4px" />
                        </div>
                    </div>

                    <div style="margin:16px 0">
                        <div>Clases asignadas:</div>
                        <div style="max-height:150px;overflow-y:auto;border:1px solid #ddd;border-radius:4px;margin-top:4px">
                            ${classes.map(c => `
                                <label style="display:block;padding:8px;border-bottom:1px solid #eee">
                                    <input type="checkbox" value="${esc(c._id)}" class="newStudentClass" />
                                    ${esc((c.days || []).join(', '))} ${esc(c.start || '')}${c.roomName ? ' - ' + esc(c.roomName) : ''}
                                    (${esc(c.camillasFree)} lugares libres)
                                </label>
                            `).join('')}
                        </div>
                    </div>

                    <div style="display:flex;gap:8px;justify-content:flex-end">
                        <button id="cancelNewStudent">Cancelar</button>
                        <button id="saveNewStudent" style="background:#2b6cb0;color:#fff">Guardar</button>
                    </div>
                </div>
            `;

            document.body.appendChild(modal);

            // Event listeners
            document.getElementById('cancelNewStudent').addEventListener('click', () => modal.remove());
            document.getElementById('saveNewStudent').addEventListener('click', async () => {
                const student = {
                    dni: document.getElementById('newStudentDni').value.trim(),
                    name: document.getElementById('newStudentName').value.trim(),
                    lastName: document.getElementById('newStudentLastName').value.trim(),
                    phone: document.getElementById('newStudentPhone').value.trim(),
                    emergencyContact: document.getElementById('newStudentEmergency').value.trim(),
                    membershipType: document.getElementById('newStudentMembership').value,
                    dueDate: document.getElementById('newStudentDueDate').value,
                    classIds: Array.from(document.querySelectorAll('.newStudentClass:checked')).map(cb => cb.value)
                };

                if (!student.dni || !student.name || !student.lastName) {
                    return showToast('DNI, nombre y apellido son requeridos', 'error');
                }

                // Validar que tenga al menos una clase asignada
                if (!Array.isArray(student.classIds) || student.classIds.length === 0) {
                    return showToast('Debe asignar al menos una clase al crear un alumno', 'error');
                }

                try {
                    await adminStudents.createStudent(student);
                    modal.remove();
                    showToast('Alumno creado', 'success');
                    await loadStudents();
                    await loadClasses(); // Actualizar lista de clases
                } catch (err) {
                    showToast(err.message || 'Error creando alumno', 'error');
                }
            });
        }

        async function openEditStudentModal(id) {
            const students = await adminStudents.listStudents();
            const student = students.find(s => s._id === id);
            if (!student) return showToast('Alumno no encontrado', 'error');

            const classes = await adminClasses.listClasses();
            const studentClasses = classes.filter(c =>
                c.students && c.students.some(s => s === id || s._id === id)
            );

            const modal = document.createElement('div');
            modal.style = 'position:fixed;inset:0;background:rgba(0,0,0,0.35);display:flex;align-items:center;justify-content:center';
            modal.innerHTML = `
                <div style="background:#fff;padding:16px;border-radius:8px;width:600px;max-height:90vh;overflow-y:auto">
                    <h4>Editar Alumno</h4>
                    
                    <div style="display:grid;grid-template-columns:1fr 1fr;gap:12px;margin:16px 0">
                        <div>
                            <div>DNI: <span class="required">*</span></div>
                                <input id="editStudentDni" value="${student.dni}" style="width:100%;padding:8px;margin:4px 0;border:1px solid #ddd;border-radius:4px" />
                        </div>
                        <div>
                            <div>Nombre: <span class="required">*</span></div>
                                <input id="editStudentName" value="${student.name || ''}" style="width:100%;padding:8px;margin:4px 0;border:1px solid #ddd;border-radius:4px" />
                        </div>
                        <div>
                            <div>Apellido: <span class="required">*</span></div>
                                <input id="editStudentLastName" value="${student.lastName || ''}" style="width:100%;padding:8px;margin:4px 0;border:1px solid #ddd;border-radius:4px" />
                        </div>
                        <div>
                            <div>Teléfono:</div>
                            <input id="editStudentPhone" value="${student.phone || ''}" style="width:100%;padding:8px;margin:4px 0;border:1px solid #ddd;border-radius:4px" />
                        </div>
                        <div>
                            <div>Contacto de emergencia:</div>
                            <input id="editStudentEmergency" value="${student.emergencyContact || ''}" style="width:100%;padding:8px;margin:4px 0;border:1px solid #ddd;border-radius:4px" />
                        </div>
                        <div>
                            <div>Tipo de cuota:</div>
                            <select id="editStudentMembership" style="width:100%;padding:8px;margin:4px 0;border:1px solid #ddd;border-radius:4px">
                                ${getMembershipOptionsHTML(student.membershipType)}
                            </select>
                        </div>
                        <div>
                            <div>Vencimiento:</div>
                            <input type="date" id="editStudentDueDate" value="${adminStudents.formatDate(student.dueDate)}" 
                                style="width:100%;padding:8px;margin:4px 0;border:1px solid #ddd;border-radius:4px" />
                        </div>
                    </div>

                    <div style="margin:16px 0">
                        <div>Clases asignadas:</div>
                        <div style="max-height:150px;overflow-y:auto;border:1px solid #ddd;border-radius:4px;margin-top:4px">
                            ${classes.map(c => `
                                <label style="display:block;padding:8px;border-bottom:1px solid #eee">
                                    <input type="checkbox" value="${esc(c._id)}" class="editStudentClass" 
                                        ${studentClasses.some(sc => sc._id === c._id) ? 'checked' : ''} />
                                    ${esc((c.days || []).join(', '))} ${esc(c.start || '')}${c.roomName ? ' - ' + esc(c.roomName) : ''}
                                    (${esc(c.camillasFree)} lugares libres)
                                </label>
                            `).join('')}
                        </div>
                    </div>

                    <div style="display:flex;gap:8px;justify-content:flex-end">
                        <button id="cancelEditStudent">Cancelar</button>
                        <button id="saveEditStudent" style="background:#2b6cb0;color:#fff">Guardar</button>
                    </div>
                </div>
            `;

            document.body.appendChild(modal);

            // Event listeners
            document.getElementById('cancelEditStudent').addEventListener('click', () => modal.remove());
            document.getElementById('saveEditStudent').addEventListener('click', async () => {
                const updatedStudent = {
                    dni: document.getElementById('editStudentDni').value.trim(),
                    name: document.getElementById('editStudentName').value.trim(),
                    lastName: document.getElementById('editStudentLastName').value.trim(),
                    phone: document.getElementById('editStudentPhone').value.trim(),
                    emergencyContact: document.getElementById('editStudentEmergency').value.trim(),
                    membershipType: document.getElementById('editStudentMembership').value,
                    dueDate: document.getElementById('editStudentDueDate').value,
                    classIds: Array.from(document.querySelectorAll('.editStudentClass:checked')).map(cb => cb.value)
                };

                if (!updatedStudent.dni || !updatedStudent.name || !updatedStudent.lastName) {
                    return showToast('DNI, nombre y apellido son requeridos', 'error');
                }

                try {
                    await adminStudents.updateStudent(id, updatedStudent);
                    modal.remove();
                    showToast('Cambios guardados', 'success');
                    await loadStudents();
                    await loadClasses(); // Actualizar lista de clases
                } catch (err) {
                    showToast(err.message || 'Error actualizando alumno', 'error');
                }
            });
        }

        // Event listeners para estudiantes
        const _btnNewStudent = document.getElementById('btnNewStudent');
        if (_btnNewStudent) _btnNewStudent.addEventListener('click', () => openNewStudentModal());
        document.getElementById('searchStudents').addEventListener('input', (e) => loadStudents(e.target.value));

        // Event listeners para profesores
        const _btnNewProfessor = document.getElementById('btnNewProfessor');
        if (_btnNewProfessor) _btnNewProfessor.addEventListener('click', () => openNewProfessorModal());
        const sp = document.getElementById('searchProfessors');
        if (sp) sp.addEventListener('input', (e) => loadProfessors(e.target.value));

        // Gestión de Profesores
        async function loadProfessors(search = '') {
            try {
                const professors = await adminProfessors.listProfessors();
                const q = (search || '').toLowerCase();
                const filtered = q ? professors.filter(p => {
                    return (p.name || '').toLowerCase().includes(q) || (p.lastName || '').toLowerCase().includes(q) || (String(p.dni || '')).toLowerCase().includes(q);
                }) : professors;
                await renderProfessors(filtered);
            } catch (err) {
                document.getElementById('professorsList').textContent = 'Error cargando profesores';
            }
        }

        // Global refresh function for professors list
        window.refreshProfessorsList = async function() {
            try {
                await loadProfessors();
            } catch (e) {
                console.error('Error refreshing professors list:', e);
            }
        };

        async function renderProfessors(professors) {
            const container = document.getElementById('professorsList');
            if (!professors.length) { container.innerHTML = '<i>No hay profesores</i>'; return }

            // load classes once to compute assigned classes per professor
            let classes = [];
            try { classes = await adminClasses.listClasses(); } catch (e) { classes = []; }

            // build map of professorId -> list of class descriptions (sorted by time)
            const byProf = {};
            for (const c of classes) {
                const pid = c.professorId ? String(c.professorId) : null;
                const desc = `${(c.days || []).join(', ')} ${c.start} - ${c.roomName || ''}`;
                if (!pid) continue;
                if (!byProf[pid]) byProf[pid] = [];
                byProf[pid].push({ desc, start: c.start || '00:00' });
            }
            
            // Sort assigned classes by start time
            for (const pid in byProf) {
                byProf[pid].sort((a, b) => a.start.localeCompare(b.start));
            }

            // always render cards, including assigned classes as pills
            const cards = professors.map(p => {
                const pid = String(p._id);
                const assigned = (byProf[pid] || []).map(x => x.desc);
                const full = assigned.length ? assigned.join(' • ') : 'Sin asignar';
                return `
                    <div class="item-card" data-id="${esc(p._id)}">
                        <div>
                            <h4>${esc((p.name || '') + ' ' + (p.lastName || ''))}</h4>
                            <div class="meta">DNI: ${esc(p.dni || '')} • Tel: ${esc(p.phone || '')}</div>
                            <div class="prof-classes" title="${esc(full)}">
                                ${assigned.length ? assigned.map(a => `<span class="pill">${esc(a)}</span>`).join('') : '<span class="pill">Sin asignar</span>'}
                            </div>
                        </div>
                        <div class="actions">
                            <button class="editProfessor btn-edit" type="button" data-action="edit">Editar</button>
                            <button class="delProfessor btn-delete" type="button" data-action="delete">Eliminar</button>
                        </div>
                    </div>
                `;
            }).join('');
            container.innerHTML = `<div class="cards-grid">${cards}</div>`;

            // Attach a single delegated event handler (attach once)
            if (!container.dataset.delegateAttached) {
                container.addEventListener('click', async (e) => {
                    const btn = e.target.closest('button[data-action]');
                    if (!btn) return;
                    const action = btn.getAttribute('data-action');
                    const card = btn.closest('.item-card');
                    if (!card) return;
                    const id = card.dataset.id;
                    if (action === 'edit') {
                        e.preventDefault();
                        openEditProfessorModal(id);
                        return;
                    }
                    if (action === 'delete') {
                        e.preventDefault();
                        // Use the site's styled confirmation modal. On confirm, perform deletion and show toast.
                        try {
                            window.showModal('Eliminar profesor', '¿Desea eliminar al profesor? Esta acción no se puede deshacer.', async function () {
                                try {
                                    await adminProfessors.deleteProfessor(id);
                                    showToast('Profesor eliminado', 'success');
                                    await loadProfessors();
                                    await loadClasses();
                                } catch (err) {
                                    showToast(err && err.message ? err.message : 'Error eliminando profesor', 'error');
                                }
                            });
                        } catch (err) {
                            // Fallback: ask with native confirm if modal helper fails
                            if (!confirm('¿Eliminar profesor?')) return;
                            try { await adminProfessors.deleteProfessor(id); showToast('Profesor eliminado', 'success'); await loadProfessors(); await loadClasses(); } catch (e) { showToast(e && e.message ? e.message : 'Error eliminando profesor', 'error'); }
                        }
                        return;
                    }
                });
                container.dataset.delegateAttached = '1';
            }
        }

        function openNewProfessorModal() {
            const modal = document.createElement('div');
            modal.style = 'position:fixed;inset:0;background:rgba(0,0,0,0.35);display:flex;align-items:center;justify-content:center';
            // Build modal content dynamically so we can load classes
            modal.innerHTML = `
                <div id="newProfessorModalContent" style="background:#fff;padding:16px;border-radius:8px;width:420px;max-height:80vh;overflow:auto">
                    <h4>Nuevo Profesor</h4>
                    <div id="newProfessorFields">Cargando...</div>
                </div>
            `;

            document.body.appendChild(modal);
            // populate fields including classes
            (async function populateNewProfessor() {
                try {
                    const classes = await adminClasses.listClasses();
                    const html = `
                        <div style="margin:16px 0">
                            <div>DNI: <span class="required">*</span></div>
                            <input id="newProfessorDni" style="width:100%;padding:8px;margin:4px 0;border:1px solid #ddd;border-radius:4px" />
                            
                            <div style="margin-top:8px">Nombre: <span class="required">*</span></div>
                            <input id="newProfessorName" style="width:100%;padding:8px;margin:4px 0;border:1px solid #ddd;border-radius:4px" />
                            
                            <div style="margin-top:8px">Apellido: <span class="required">*</span></div>
                            <input id="newProfessorLastName" style="width:100%;padding:8px;margin:4px 0;border:1px solid #ddd;border-radius:4px" />
                            
                            <div style="margin-top:8px">Teléfono:</div>
                            <input id="newProfessorPhone" style="width:100%;padding:8px;margin:4px 0;border:1px solid #ddd;border-radius:4px" />
                        </div>

                        <div style="margin:8px 0">
                            <div>Clases asignadas (opcional):</div>
                            <div style="max-height:160px;overflow:auto;border:1px solid #ddd;border-radius:4px;margin-top:6px;padding:6px;background:#fff">
                                ${classes.map(c => `
                                    <label style="display:block;padding:6px;border-bottom:1px solid #eee">
                                        <input type="checkbox" value="${c._id}" class="newProfessorClass" />
                                        ${esc((c.days || []).join(', '))} ${esc(c.start)} - ${esc(c.roomName || '')}
                                    </label>
                                `).join('')}
                            </div>
                        </div>

                        <div style="display:flex;gap:8px;justify-content:flex-end;margin-top:8px">
                            <button id="cancelNewProfessor">Cancelar</button>
                            <button id="saveNewProfessor" style="background:#2b6cb0;color:#fff">Guardar</button>
                        </div>
                    `;
                    document.getElementById('newProfessorFields').innerHTML = html;

                    document.getElementById('cancelNewProfessor').addEventListener('click', () => modal.remove());
                    document.getElementById('saveNewProfessor').addEventListener('click', async () => {
                        const professor = {
                            dni: document.getElementById('newProfessorDni').value.trim(),
                            name: document.getElementById('newProfessorName').value.trim(),
                            lastName: document.getElementById('newProfessorLastName').value.trim(),
                            phone: document.getElementById('newProfessorPhone').value.trim()
                        };

                        if (!professor.dni || !professor.name || !professor.lastName) {
                            return alert('DNI, nombre y apellido son requeridos');
                        }

                        const selectedClassIds = Array.from(document.querySelectorAll('.newProfessorClass:checked')).map(cb => cb.value);

                        try {
                            const created = await adminProfessors.createProfessor(professor);
                            // The API returns { id: <insertedId> } — use created.id
                            const newProfId = created.id || created._id || null;
                            // assign professor to selected classes by updating each class
                            if (newProfId && Array.isArray(selectedClassIds) && selectedClassIds.length) {
                                const allClasses = await adminClasses.listClasses();
                                for (const cid of selectedClassIds) {
                                    const cl = allClasses.find(x => x._id === cid || x._id == cid);
                                    if (!cl) continue;
                                    try { await adminClasses.assignProfessor(cid, newProfId); } catch (er) { /* ignore per-class errors */ }
                                }
                            }

                            modal.remove();
                            await loadProfessors();
                            await loadClasses();
                        } catch (err) {
                            alert(err.message || 'Error creando profesor');
                        }
                    });
                } catch (err) {
                    document.getElementById('newProfessorFields').innerHTML = '<i>Error cargando clases</i>';
                }
            })();
        }

        // Gestión de Configuración
        async function loadGymConfig() {
            try {
                const config = await adminGym.getConfig();
                // expose globally so other builders can use membershipTypes when rendering forms/modals
                window.currentGymConfig = config || {};
                renderGymConfig(config);
                // refresh any membership selects already rendered on the page (inline form created earlier)
                updateMembershipSelects();
            } catch (err) {
                document.getElementById('gymConfigForm').textContent = 'Error cargando configuración';
            }
        }

        function renderGymConfig(config) {
            const form = document.createElement('form');
            form.innerHTML = `
                <div style="display:flex;flex-direction:column;gap:12px">
                    <div>
                        <div style="font-weight:700">Horas mínimas de cancelación para permitir recuperar clase</div>
                        <div style="font-size:13px;color:#6b7280;margin:6px 0">Cantidad mínima de horas previas para poder sumar una clase para recuperar. Si cancela antes de este límite, recibe un crédito para recuperar la clase.</div>
                        <input type="number" id="minCancellationHours" value="${config.minCancellationHours}"
                            min="1" style="width:100%;padding:8px;margin:8px 0;border:1px solid #ddd;border-radius:4px" />
                    </div>
                    <div>
                        <div style="font-weight:700">Días de vencimiento de créditos</div>
                        <div style="font-size:13px;color:#6b7280;margin:6px 0">Cantidad de días que dura un crédito generado. Después de este tiempo, el crédito vence y ya no se podrá usar para recuperar clases.</div>
                        <input type="number" id="creditExpirationDays" value="${config.creditExpirationDays}"
                            min="1" style="width:100%;padding:8px;margin:8px 0;border:1px solid #ddd;border-radius:4px" />
                    </div>
                    <div>
                        <div style="font-weight:700">Días extra para recuperación de clases tras vencimiento de cuota</div>
                        <div style="font-size:13px;color:#6b7280;margin:6px 0">Permite agregar días adicionales para que los alumnos sigan pudiendo usar sus créditos incluso si su cuota ya venció. Este número se suma a la fecha de vencimiento de la cuota.</div>
                        <input type="number" id="autoCancelDueOverdueDays" value="${config.autoCancelDueOverdueDays}"
                            min="0" style="width:100%;padding:8px;margin:8px 0;border:1px solid #ddd;border-radius:4px" />
                    </div>
                    <div>
                        <div style="font-weight:700">Máximo de créditos acumulables</div>
                        <div style="font-size:13px;color:#6b7280;margin:6px 0">Define cuántos créditos como máximo puede tener un alumno al mismo tiempo. Si llega al límite, ya no generará nuevos créditos aunque cancele clases.</div>
                        <input type="number" id="maxCredits" value="${config.maxCredits}"
                            min="1" style="width:100%;padding:8px;margin:8px 0;border:1px solid #ddd;border-radius:4px" />
                    </div>
                </div>

                <!-- Membership types management: input first, then the list -->
                <div style="margin-top:16px">
                    <div style="font-weight:700;margin-bottom:8px">Tipos de cuota</div>
                    <div style="display:flex;gap:8px;margin-bottom:10px">
                        <input id="newMembershipInput" placeholder="Nuevo tipo de cuota" style="flex:1;padding:8px;border:1px solid #ddd;border-radius:6px" />
                        <button id="addMembershipBtn" type="button" style="background:#48bb78;color:#fff;padding:8px 12px;border-radius:6px">Agregar</button>
                    </div>
                    <div id="membershipTypesList" style="display:flex;flex-wrap:wrap;gap:8px;max-height:220px;overflow:auto;border:1px solid #eee;padding:8px;border-radius:8px;background:#fff">
                        <!-- populated dynamically by refreshMembershipList() -->
                    </div>
                </div>

                <div style="display:flex;justify-content:flex-end;margin-top:12px">
                    <div id="gymSaveStatus" style="display:none" aria-hidden="true"></div>
                </div>
            `;

            // membership types local copy and helper
            // Ensure there's always at least the default "Pilates en camilla" present
            let membershipTypes = Array.isArray(config.membershipTypes) && config.membershipTypes.length ? [].concat(config.membershipTypes) : ['Pilates en camilla'];

            // Debounced auto-save helper
            let saveTimer = null;
            async function performSave() {
                try {
                    const payload = {
                        minCancellationHours: parseInt(document.getElementById('minCancellationHours').value) || 0,
                        creditExpirationDays: parseInt(document.getElementById('creditExpirationDays').value) || 0,
                        autoCancelDueOverdueDays: parseInt(document.getElementById('autoCancelDueOverdueDays').value) || 0,
                        maxCredits: parseInt(document.getElementById('maxCredits').value) || 0,
                        membershipTypes: membershipTypes
                    };
                    await adminGym.updateConfig(payload);
                    // reflect saved config globally and update selects elsewhere
                    window.currentGymConfig = payload;
                    updateMembershipSelects();
                    // notify other tabs (professors) about gym config changes
                    try {
                        const bc = new BroadcastChannel('pilates-updates');
                        bc.postMessage({ type: 'gymConfig', membershipTypes: payload.membershipTypes });
                    } catch (e) { /* BroadcastChannel may not be available in all environments */ }
                } catch (err) {
                    console.error('Error saving gym config', err);
                }
            }

            function scheduleSave() {
                try {
                    if (saveTimer) clearTimeout(saveTimer);
                    saveTimer = setTimeout(performSave, 700);
                } catch (e) { }
            }

            function refreshMembershipList() {
                const list = form.querySelector('#membershipTypesList');
                list.innerHTML = membershipTypes.map((t, i) => `
                    <div style="display:flex;align-items:center;gap:8px;" data-index="${i}">
                        <span style="flex:1">${esc(t)}</span>
                        <button type="button" class="delMembership" data-index="${i}" style="background:transparent;color:#ef4444;padding:4px 6px;border-radius:6px;border:none">✕</button>
                    </div>
                `).join('');
                // attach delete handlers
                Array.from(list.querySelectorAll('.delMembership')).forEach(b => b.addEventListener('click', (ev) => {
                    const idx = Number(ev.currentTarget.getAttribute('data-index'));
                    if (isNaN(idx)) return;
                    const typeName = membershipTypes[idx] || '';
                    try {
                        window.showModal('Eliminar tipo de cuota', `¿Eliminar "${esc(typeName)}"?`, function () {
                            membershipTypes.splice(idx, 1);
                            refreshMembershipList();
                            scheduleSave();
                        });
                    } catch (err) {
                        // fallback to native confirm if modal helper fails
                        if (!confirm(`Eliminar tipo de cuota: ${typeName}?`)) return;
                        membershipTypes.splice(idx, 1);
                        refreshMembershipList();
                        scheduleSave();
                    }
                }));
            }

            // add membership handler
            form.addEventListener('click', (ev) => {
                if (!ev.target) return;
                if (ev.target.id === 'addMembershipBtn') {
                    const input = form.querySelector('#newMembershipInput');
                    const v = (input && input.value || '').trim();
                    if (!v) {
                        try {
                            showToast('Ingresá el nombre del tipo de cuota', 'error');
                            input && input.focus();
                        } catch (e) {
                            alert('Ingresá el nombre del tipo de cuota');
                            input && input.focus();
                        }
                        return;
                    }
                    if (membershipTypes.includes(v)) {
                        try { showToast('Ese tipo ya existe', 'error'); input && input.focus(); } catch (e) { alert('Ese tipo ya existe'); input && input.focus(); }
                        return;
                    }
                    membershipTypes.push(v);
                    input.value = '';
                    refreshMembershipList();
                    scheduleSave();
                }
            });

            refreshMembershipList();

            // Attach change/input listeners to numeric inputs to auto-save
            ['minCancellationHours', 'creditExpirationDays', 'autoCancelDueOverdueDays', 'maxCredits'].forEach(id => {
                const el = form.querySelector('#' + id);
                if (!el) return;
                el.addEventListener('input', () => scheduleSave());
                el.addEventListener('change', () => scheduleSave());
            });

            // keep status element hidden; no visible messages
            try { form.querySelector('#gymSaveStatus').style.display = 'none'; } catch (e) { }

            document.getElementById('gymConfigForm').innerHTML = '';
            document.getElementById('gymConfigForm').appendChild(form);
        }

        // Event listeners para profesores (handled earlier)

        async function openEditProfessorModal(id) {
            const modal = document.createElement('div');
            modal.style = 'position:fixed;inset:0;background:rgba(0,0,0,0.35);display:flex;align-items:center;justify-content:center';
            modal.innerHTML = `
                <div id="editProfessorModalContent" style="background:#fff;padding:16px;border-radius:8px;width:420px;max-height:80vh;overflow:auto">
                    <h4>Editar Profesor</h4>
                    <div id="editProfessorFields">Cargando...</div>
                </div>
            `;
            document.body.appendChild(modal);
            try {
                const professors = await adminProfessors.listProfessors();
                const prof = professors.find(p => p._id === id || p._id == id);
                if (!prof) {
                    modal.remove();
                    return alert('Profesor no encontrado');
                }

                const classes = await adminClasses.listClasses();
                const html = `
                    <div style="margin:16px 0">
                        <div>DNI: <span class="required">*</span></div>
                        <input id="editProfessorDni" value="${esc(prof.dni || '')}" style="width:100%;padding:8px;margin:4px 0;border:1px solid #ddd;border-radius:4px" />
                        
                        <div style="margin-top:8px">Nombre: <span class="required">*</span></div>
                        <input id="editProfessorName" value="${esc(prof.name || '')}" style="width:100%;padding:8px;margin:4px 0;border:1px solid #ddd;border-radius:4px" />
                        
                        <div style="margin-top:8px">Apellido: <span class="required">*</span></div>
                        <input id="editProfessorLastName" value="${esc(prof.lastName || '')}" style="width:100%;padding:8px;margin:4px 0;border:1px solid #ddd;border-radius:4px" />
                        
                        <div style="margin-top:8px">Teléfono:</div>
                        <input id="editProfessorPhone" value="${esc(prof.phone || '')}" style="width:100%;padding:8px;margin:4px 0;border:1px solid #ddd;border-radius:4px" />
                    </div>

                    <div style="margin:8px 0">
                        <div>Clases asignadas:</div>
                        <div style="max-height:160px;overflow:auto;border:1px solid #ddd;border-radius:4px;margin-top:6px;padding:6px;background:#fff">
                            ${classes.sort((a, b) => {
                                const timeA = a.start || '00:00';
                                const timeB = b.start || '00:00';
                                return timeA.localeCompare(timeB);
                            }).map(c => `
                                <label style="display:block;padding:6px;border-bottom:1px solid #eee">
                                    <input type="checkbox" value="${c._id}" class="editProfessorClass" ${c.professorId === prof._id ? 'checked' : ''} />
                                    ${esc((c.days || []).join(', '))} ${esc(c.start)} - ${esc(c.roomName || '')}
                                </label>
                            `).join('')}
                        </div>
                    </div>

                    <div style="display:flex;gap:8px;justify-content:flex-end;margin-top:8px">
                        <button id="cancelEditProfessor">Cancelar</button>
                        <button id="saveEditProfessor" style="background:#2b6cb0;color:#fff">Guardar</button>
                    </div>
                `;

                document.getElementById('editProfessorFields').innerHTML = html;

                document.getElementById('cancelEditProfessor').addEventListener('click', () => modal.remove());
                document.getElementById('saveEditProfessor').addEventListener('click', async () => {
                    const updated = {
                        dni: document.getElementById('editProfessorDni').value.trim(),
                        name: document.getElementById('editProfessorName').value.trim(),
                        lastName: document.getElementById('editProfessorLastName').value.trim(),
                        phone: document.getElementById('editProfessorPhone').value.trim()
                    };
                    if (!updated.dni || !updated.name || !updated.lastName) return showToast('DNI, nombre y apellido son requeridos', 'error');

                    const selectedClassIds = Array.from(document.querySelectorAll('.editProfessorClass:checked')).map(cb => cb.value);

                    try {
                        await adminProfessors.updateProfessor(id, updated);

                        // update classes: assign professorId for selected, unassign for others
                        const allClasses = await adminClasses.listClasses();
                        for (const cl of allClasses) {
                            const shouldHave = selectedClassIds.includes(String(cl._id));
                            const currentlyHas = cl.professorId === prof._id || cl.professorId == prof._id;
                            if (shouldHave && !currentlyHas) {
                                try { await adminClasses.assignProfessor(cl._id, id); } catch (er) { /* ignore per-class */ }
                            } else if (!shouldHave && currentlyHas) {
                                try { await adminClasses.assignProfessor(cl._id, null); } catch (er) { /* ignore per-class */ }
                            }
                        }

                        modal.remove();
                        // Esperar un poco y luego recargar todo
                        await new Promise(r => setTimeout(r, 300));
                        await loadProfessors();
                        await loadClasses();
                        // Refresh professor section to show updated classes
                        try { if (window.refreshProfessorsList) window.refreshProfessorsList(); } catch (e) { /* ignore */ }
                        showToast('Cambios guardados', 'success');
                    } catch (err) {
                        showToast(err.message || 'Error actualizando profesor', 'error');
                    }
                });
            } catch (err) {
                modal.remove();
                alert('Error cargando datos del profesor o clases');
            }
        }

        // breakpoint re-render removed: cards are active for all sizes, no layout switch needed

        // Inicializar
        (async () => {
            await loadStudents();
            await loadProfessors();
            await loadGymConfig();
            await loadRooms();
            await loadClasses();
        })();
    </script>

</body>

</html>