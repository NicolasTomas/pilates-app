<!doctype html>
<html lang="es">

<head>
    <meta charset="utf-8" />
    <meta name="viewport" content="width=device-width, initial-scale=1" />
    <link href="https://fonts.googleapis.com/css2?family=Orbitron:wght@700&display=swap" rel="stylesheet">
    <title>Administración - Pilates Camilla</title>
    <style>
        * {
            margin: 0;
            padding: 0;
            box-sizing: border-box;
        }

        :root {
            --sidebar-width: 220px;
            --sidebar-gap: 20px;
        }

        body {
            font-family: 'Inter', -apple-system, BlinkMacSystemFont, 'Segoe UI', Arial, sans-serif;
            background-color: #d9d9d9;
            padding-top: 90px;
        }

        .top {
            background: rgb(255, 255, 255);
            backdrop-filter: blur(10px);
            color: #000000;
            padding: 24px 32px;
            padding-left: 32px;
            /* espacio por defecto para el botón hamburguesa */
            border-bottom: 1px solid rgba(255, 255, 255, 0.2);
            display: flex;
            align-items: center;
            justify-content: center;
            flex-direction: column;
            position: fixed;
            top: 0;
            width: 100%;


        }

        .top h1 {
            font-size: 28px;
            font-weight: 700;
            margin-bottom: 0;
            font-family: 'Orbitron', sans-serif;
        }

        .top>div {
            display: flex;
            justify-content: space-between;
            align-items: center;
        }

        .top button {
            padding: 5px 8px 5px 8px !important;
            border-radius: 8px;
            border: 2px solid rgba(255, 255, 255, 0.3);
            background: rgba(255, 255, 255, 0.2);
            color: #000000;
            font-weight: 600;
            cursor: pointer;
            transition: all 0.3s ease;
            backdrop-filter: blur(10px);
        }

        .top button:hover {
            background: rgba(255, 255, 255, 0.3);
            border-color: rgba(255, 255, 255, 0.5);
        }

        .card {
            background: #fff;
            padding: 40px 32px;
            border-radius: 24px;
            box-shadow: 0 10px 40px rgba(0, 0, 0, 0.15);
            max-width: 1200px;
            margin: 32px auto;
        }

        h1,
        h3,
        h4 {
            font-weight: 700;
        }

        h3 {
            color: #000000;
            font-size: 24px;
            margin-bottom: 12px;
        }

        h4 {
            color: #764ba2;
            font-size: 20px;
            margin-bottom: 16px;
        }

        section {
            margin-bottom: 32px;
        }

        input,
        select,
        button {
            font-family: inherit;
            font-size: 15px;
        }

        /* Estilo para indicar campos obligatorios (asterisco en rojo) */
        .required {
            color: #e53e3e;
            /* rojo */
            margin-left: 4px;
            font-weight: 700;
        }

        input,
        select {
            padding: 12px 16px;
            border-radius: 12px;
            border: 2px solid #e2e8f0;
            background: #f8fafc;
            transition: all 0.3s ease;
        }

        input:focus,
        select:focus {
            border-color: #667eea;
            outline: none;
            background: #fff;
            box-shadow: 0 0 0 3px rgba(102, 126, 234, 0.1);
        }

        button {
            padding: 12px 24px;
            border-radius: 12px;
            border: none;
            background-color: #000000c5;
            color: #fff;
            font-weight: 600;
            cursor: pointer;
            box-shadow: 0 4px 12px rgba(102, 126, 234, 0.3);
            transition: all 0.3s ease;
        }

        button:hover {
            transform: translateY(-2px);
            box-shadow: 0 6px 16px rgba(102, 126, 234, 0.4);
        }

        button[style*="background:#38a169"],
        button[style*="background:#2b6cb0"],
        button[style*="background:#48bb78"] {
            background: linear-gradient(135deg, #48bb78 0%, #38a169 100%) !important;
            box-shadow: 0 4px 12px rgba(72, 187, 120, 0.3);
        }

        button[style*="background:#e53e3e"] {
            background: linear-gradient(135deg, #fc8181 0%, #e53e3e 100%) !important;
            box-shadow: 0 4px 12px rgba(229, 62, 62, 0.3);
        }

        .navbar {
            display: none;
            /* esconder la antigua barra horizontal; se mostrará como panel lateral cuando body.nav-open */
            background: rgb(255, 255, 255);
            backdrop-filter: blur(10px);
            box-shadow: 0 4px 20px rgba(0, 0, 0, 0.1);

            /* Permitir scroll horizontal en la barra, pero ocultar la scrollbar mediante reglas específicas */
            overflow: visible;

            padding: 0;
            position: sticky;
            top: 0;
            border-bottom: 1px solid rgba(255, 255, 255, 0.2);
            /* z-index: 999; */
        }

        .navbar ul {
            display: flex;
            gap: 0;
            margin: 0;
            padding: 0 32px;
            list-style: none;
            /* Scroll horizontal funcional */
            overflow-x: auto;
            -webkit-overflow-scrolling: touch;
            /* Ocultar scrollbar en distintos navegadores */
            scrollbar-width: none;
            /* Firefox */
            -ms-overflow-style: none;
            /* IE 10+ */
        }

        /* WebKit: ocultar barra de scroll horizontal */
        .navbar ul::-webkit-scrollbar {
            height: 0;
            background: transparent;
        }

        .navbar li {
            margin: 0;
        }

        .navbar a {
            display: block;
            padding: 20px 28px;
            color: #696969;
            font-weight: 600;
            text-decoration: none;
            border-right: 3px solid transparent;
            transition: all 0.3s ease;
            /* Mantener en una sola línea; el contenedor hará scroll si hace falta */
            white-space: nowrap;
        }

        .navbar a.active {
            /* background: linear-gradient(135deg, rgba(102, 126, 234, 0.1) 0%, rgba(118, 75, 162, 0.1) 100%); */
            border-right: 3px solid #000000;
            color: #000000;
            overflow-x: hidden;

        }

        .navbar a:hover {
            color: #000000;

        }

        table {
            width: 100%;
            border-collapse: separate;
            border-spacing: 0;
            background: #ffffff;
            border-radius: 12px;
            overflow: hidden;
            box-shadow: 0 2px 8px rgba(0, 0, 0, 0.05);
        }

        th,
        td {
            padding: 14px 12px;
            text-align: left;
        }

        th {
            background-color: #000000;
            color: #fff;
            font-weight: 600;
            font-size: 13px;
            text-transform: uppercase;
            letter-spacing: 0.5px;
        }

        tbody tr {
            border-bottom: 1px solid #f1f5f9;
            transition: all 0.2s ease;
        }

        tbody tr:hover {
            background: #f8fafc;
        }

        tbody tr:last-child {
            border-bottom: none;
        }

        .modal {
            position: fixed;
            inset: 0;
            background: rgba(0, 0, 0, 0.5);
            backdrop-filter: blur(5px);
            display: flex;
            align-items: center;
            justify-content: center;
            z-index: 1000;
            animation: fadeIn 0.3s ease;
        }

        @keyframes fadeIn {
            from {
                opacity: 0;
            }

            to {
                opacity: 1;
            }
        }

        .modal>div {
            background: #fff;
            padding: 32px;
            border-radius: 20px;
            box-shadow: 0 20px 60px rgba(0, 0, 0, 0.3);
            min-width: 380px;
            max-width: 95vw;
            max-height: 90vh;
            overflow-y: auto;
            animation: slideUp 0.3s ease;
        }

        @keyframes slideUp {
            from {
                opacity: 0;
                transform: translateY(20px);
            }

            to {
                opacity: 1;
                transform: translateY(0);
            }
        }

        @media (max-width: 700px) {
            body {
                overflow-x: hidden;
            }

            .top {
                padding: 16px;
            }

            .top h1 {
                font-size: 20px;
            }

            .top>div {
                flex-direction: column;
                gap: 12px;
                align-items: flex-start;
            }

            .top button {
                padding: 8px 16px;
                font-size: 14px;
            }

            #meInfo {
                font-size: 14px;
            }

            .card {
                margin: 20px 16px;
                padding: 24px 16px;
                border-radius: 16px;
            }

            h3 {
                font-size: 20px;
            }

            h4 {
                font-size: 18px;
            }

            .navbar ul {
                padding: 0 16px;
                overflow-x: auto;
                -webkit-overflow-scrolling: touch;
                scrollbar-width: none;
                -ms-overflow-style: none;
            }

            .navbar a {
                padding: 16px 16px;
                font-size: 14px;
                white-space: nowrap;
            }

            /* Hacer tablas scrolleables horizontalmente */
            table {
                display: block;
                overflow-x: auto;
                -webkit-overflow-scrolling: touch;
            }

            th,
            td {
                padding: 10px 8px;
                font-size: 13px;
                white-space: nowrap;
            }

            button {
                padding: 8px 14px;
                font-size: 14px;
            }

            input,
            select {
                padding: 10px 12px;
                font-size: 14px;
            }

            section {
                margin-bottom: 24px;
            }

            /* Formularios en columna simple en mobile */
            div[style*="grid-template-columns"] {
                display: flex !important;
                flex-direction: column !important;
                gap: 12px !important;
            }

            .modal>div {
                padding: 24px 16px;
                border-radius: 16px;
                min-width: auto;
                width: 90%;
            }
        }

        @media (max-width: 480px) {
            .top h1 {
                font-size: 18px;
            }

            .card {
                margin: 16px 12px;
                padding: 20px 12px;
            }

            .navbar a {
                padding: 12px 12px;
                font-size: 13px;
            }

            th,
            td {
                padding: 8px 6px;
                font-size: 12px;
            }

            button {
                padding: 6px 12px;
                font-size: 13px;
            }

            .modal>div {
                padding: 20px 12px;
                width: 95%;
            }
        }

        /* Reglas para desplegar la navbar como panel lateral con el botón */
        body.nav-open #navOverlay {
            display: block;
        }

        body.nav-open .navbar {
            display: block;
            position: fixed;
            left: 0;
            top: 0;
            bottom: 0;
            width: 220px;
            padding-top: 72px;
            /* deja espacio al header */
            overflow-y: auto;
            z-index: 999;
            box-shadow: 0 8px 40px rgba(0, 0, 0, 0.12);
            background: rgb(255, 255, 255);
        }

        body.nav-open .navbar ul {
            flex-direction: column;
            /* leave space at the bottom for the logout footer */
            padding: 8px 0 96px 0;
        }

        body.nav-open .navbar a {
            padding: 12px 18px;
            border-bottom: none;
            border-right: 4px solid transparent;
            white-space: nowrap;
        }

        body.nav-open .navbar a.active {
            border-right-color: #000000;
        }

        /* Hamburger button styles */
        #sideToggle {
            width: 44px;
            height: 44px;
            padding: 8px;
            display: inline-flex;
            align-items: center;
            justify-content: center;
        }

        #sideToggle:focus {
            outline: 2px solid rgba(102, 126, 234, 0.25);
            outline-offset: 2px;
        }

        #sideToggle .hamburger {
            display: inline-block;
            width: 20px;
            height: 14px;
        }

        #sideToggle .hamburger span {
            display: block;
            height: 2px;
            background: #1f2937;
            border-radius: 2px;
            margin: 3px 0;
        }

        @media (prefers-reduced-motion: no-preference) {
            #sideToggle .hamburger span {
                transition: transform .18s ease, opacity .18s ease;
            }
        }

        /* Animated state: when #sideToggle has .open, transform bars into an X */
        #sideToggle.open .hamburger span:nth-child(1) {
            transform: translateY(5px) rotate(45deg);
        }

        #sideToggle.open .hamburger span:nth-child(2) {
            opacity: 0;
            transform: scaleX(.2);
        }

        /* Footer inside the sidebar for logout */
        .navbar .nav-footer {
            position: absolute;
            bottom: 16px;
            left: 0;
            width: 100%;
            display: flex;
            justify-content: center;
            padding: 8px 0;
            box-sizing: border-box;
        }

        .navbar .nav-footer button {
            width: calc(100% - 32px);
            margin: 0 16px;
            padding: 10px 12px;
            border-radius: 8px;
            background: linear-gradient(135deg, #fc8181 0%, #e53e3e 100%);
            color: #fff;
            border: none;
            font-weight: 600;
            cursor: pointer;
            box-shadow: 0 4px 12px rgba(229, 62, 62, 0.2);
        }

        #sideToggle.open .hamburger span:nth-child(3) {
            transform: translateY(-5px) rotate(-45deg);
        }

        /* Desktop: keep sidebar visible and hide toggle button */
        @media (min-width: 768px) {
            #sideToggle {
                display: none !important;
            }

            .navbar {
                display: block;
                position: fixed;
                left: 0;
                top: 0;
                bottom: 0;
                width: 220px;
                padding-top: 72px;
            }

            /* push content to the right so the fixed sidebar doesn't cover it */
            .top,
            .card {
                transition: margin-left .22s ease, transform .22s ease;
                margin-left: calc(var(--sidebar-width) + var(--sidebar-gap));
            }

            /* make sure links stack vertically when sidebar is fixed */
            .navbar ul {
                flex-direction: column;
                /* ensure footer won't overlap the links when sidebar is fixed */
                padding: 12px 8px 96px 8px;
                align-items: stretch;
            }

            .navbar li {
                display: block;
            }

            .navbar a {
                display: block;
                padding: 12px 16px;
                border-left: 4px solid transparent;
                white-space: normal;
            }
        }

        /* When opening on smaller screens, slide the content slightly for a nicer effect */
        @media (max-width: 767px) {

            body.nav-open .top,
            body.nav-open .card {
                transform: translateX(220px);
                transition: transform .22s ease;
            }
        }

        /* Ensure content shifts animate on resize as well */
        .top,
        .card {
            transition: margin-left .22s ease, transform .22s ease;
        }

        /* When a modal is open we prevent the page from animating the main
           content (which can move the modal). This keeps the modal centered
           even if the sidebar opens/closes. */
        .modal-open-no-shift .top,
        .modal-open-no-shift .card {
            transition: none !important;
            transform: none !important;
        }

        /* Ensure modal always sits above the sidebar */
        .modal {
            z-index: 3000 !important;
            position: fixed !important;
            inset: 0 !important;
        }

        /* Custom confirm modal styles */
        .confirm-backdrop {
            position: fixed;
            inset: 0;
            background: rgba(0, 0, 0, 0.45);
            display: flex;
            align-items: center;
            justify-content: center;
            z-index: 2000;
        }

        .confirm-modal {
            background: #fff;
            border-radius: 12px;
            padding: 20px 18px;
            width: 320px;
            max-width: calc(100% - 32px);
            box-shadow: 0 20px 60px rgba(0, 0, 0, 0.25);
            text-align: left;
            font-family: inherit;
        }

        .confirm-modal h4 {
            margin-bottom: 8px;
            font-size: 16px;
        }

        .confirm-row {
            display: flex;
            gap: 8px;
            justify-content: flex-end;
            margin-top: 12px;
        }

        .confirm-modal button {
            padding: 8px 12px;
            border-radius: 8px;
            border: none;
            font-weight: 600;
            cursor: pointer;
        }

        .confirm-cancel {
            background: #f1f5f9;
            color: #111
        }

        .confirm-ok {
            background: #e53e3e;
            color: #fff
        }

        .modal-actions {
            margin-top: 15px;
        }

        /* Cards grid for lists - active for all sizes */
        .cards-grid {
            display: grid;
            gap: 14px;
            grid-template-columns: repeat(auto-fill, minmax(220px, 1fr));
        }

        /* For better readability, render the classes list as a vertical stack
           (one class per row). This keeps professors/students/rooms as cards. */
        #classesList>.cards-grid {
            grid-template-columns: 1fr;
        }

        .item-card {
            background: #fff;
            padding: 12px;
            border-radius: 12px;
            box-shadow: 0 6px 18px rgba(0, 0, 0, 0.06);
            display: flex;
            flex-direction: column;
            justify-content: space-between;
        }

        .item-card h4 {
            margin: 0 0 8px 0;
            font-size: 16px
        }

        .item-card .meta {
            color: #555;
            font-size: 14px;
            margin-bottom: 10px;
            white-space: normal
        }

        .item-card .actions {
            display: flex;
            gap: 8px;
            justify-content: flex-end
        }

        .item-card .actions button {
            padding: 8px 10px;
            border-radius: 8px;
            border: none;
            font-weight: 600;
            cursor: pointer
        }

        .item-card .actions .btn-edit {
            background: #2b6cb0;
            color: #fff
        }

        .item-card .actions .btn-delete {
            background: #e53e3e;
            color: #fff
        }

        .item-card .actions .btn-manage {
            background: #48bb78;
            color: #fff
        }

        /* Professor classes: stack them vertically for readability */
        .prof-classes {
            display: flex;
            flex-direction: column;
            gap: 6px;
            margin-top: 8px;
        }

        .prof-classes .pill {
            display: block;
            background: #f1f5f9;
            color: #111827;
            padding: 6px 8px;
            border-radius: 8px;
            font-size: 13px;
        }

        /* no media query: cards are used at all viewport sizes */
    </style>
</head>

<body>
    <!-- Overlay usado cuando el menú lateral está abierto -->
    <div id="navOverlay" style="display:none;position:fixed;inset:0;background:rgba(0,0,0,0.35);z-index:998"></div>
    <!-- Botón lateral fijo para desplegar la navbar (ubicado arriba a la izquierda) -->
    <button id="sideToggle" aria-label="Abrir menú" aria-expanded="false" title="Menú"
        style="position:fixed;left:8px;top:18px;z-index:1001;border-radius:10px;border:1px solid rgba(0,0,0,0.06);background:#fff;box-shadow:0 6px 20px rgba(0,0,0,0.08);">
        <span class="hamburger" aria-hidden="true"><span></span><span></span><span></span></span>
    </button>
    <div class="top">
        <h1>Panel de Administrador</h1>
        <div>
            <span id="meInfo">Cargando...</span>
        </div>
    </div>
    <nav class="navbar">
        <ul>
            <li><a href="#" class="nav-link active" data-section="usersSection">Crear Usuario</a></li>
            <li><a href="#" class="nav-link" data-section="professorsSection">Profesores</a></li>
            <li><a href="#" class="nav-link" data-section="studentsSection">Alumnos</a></li>
            <li><a href="#" class="nav-link" data-section="roomsSection">Salones</a></li>
            <li><a href="#" class="nav-link" data-section="classesSection">Clases</a></li>
            <li><a href="#" class="nav-link" data-section="gymConfigSection">Configuración</a></li>
        </ul>
        <!-- Logout moved here so it's always at the bottom of the sidebar -->
        <div class="nav-footer">
            <button id="logout" type="button" title="Cerrar sesión">cerrar sesión</button>
        </div>
    </nav>
    <div class="card">
        <section id="usersSection">
            <h4>Crear Usuario</h4>
            <!-- Formulario de creación de usuario mostrado directamente (sin botón) -->
        </section>
        <section id="professorsSection" style="display:none">
            <h4>Profesores</h4>
            <div style="display:flex;gap:8px;margin-bottom:8px;align-items:center">
                <button id="btnNewProfessor" style="background:#2b6cb0;color:#fff;padding:8px 12px;border-radius:6px">
                    Nuevo profesor
                </button>
            </div>
            <div id="professorsList">Cargando...</div>
        </section>
        <section id="studentsSection" style="display:none">
            <h4>Alumnos</h4>
            <div style="display:flex;gap:8px;margin-bottom:8px;align-items:center">
                <input id="searchStudents" placeholder="Buscar por nombre, apellido o DNI"
                    style="flex:1;padding:8px;border:1px solid #ddd;border-radius:4px" />
                <button id="btnNewStudent" style="background:#2b6cb0;color:#fff;padding:8px 12px;border-radius:6px">
                    Nuevo alumno
                </button>
            </div>
            <div id="studentsList">Cargando...</div>
        </section>
        <section id="roomsSection" style="display:none">
            <h4>Salones</h4>
            <div style="display:flex;gap:8px;margin-bottom:8px;align-items:center">
                <input id="searchRooms" placeholder="Buscar por nombre"
                    style="flex:1;padding:8px;border:1px solid #ddd;border-radius:4px" />
                <button id="btnNewRoom" style="background:#2b6cb0;color:#fff;padding:8px 12px;border-radius:6px">Nuevo
                    salón</button>
            </div>
            <div id="roomsList">Cargando...</div>
        </section>
        <section id="classesSection" style="display:none">
            <h4>Clases</h4>
            <div style="display:flex;gap:8px;margin-bottom:8px;align-items:center">
                <input id="searchClasses" placeholder="Buscar clases"
                    style="flex:1;padding:8px;border:1px solid #ddd;border-radius:4px" />
                <button id="btnNewClass" style="background:#2b6cb0;color:#fff;padding:8px 12px;border-radius:6px">Nueva
                    clase</button>
            </div>
            <div id="classesList">Cargando...</div>
        </section>
        <section id="gymConfigSection" style="display:none">
            <h4>Configuración del Gimnasio</h4>
            <div id="gymConfigForm" style="margin-top:12px">Cargando...</div>
        </section>
    </div>
    <script src="/public/js/auth.js"></script>
    <script src="/public/js/admin_rooms.js"></script>
    <script src="/public/js/admin_classes.js"></script>
    <script src="/public/js/admin_students.js"></script>
    <script src="/public/js/admin_professors.js"></script>
    <script src="/public/js/admin_gym.js"></script>
    <script>
        // Navbar navegación entre secciones
        document.querySelectorAll('.nav-link').forEach(link => {
            link.addEventListener('click', e => {
                e.preventDefault();
                document.querySelectorAll('.nav-link').forEach(l => l.classList.remove('active'));
                link.classList.add('active');
                const sectionId = link.getAttribute('data-section');
                document.querySelectorAll('.card section').forEach(sec => {
                    sec.style.display = sec.id === sectionId ? '' : 'none';
                });
                // Al seleccionar un item, cerrar el panel lateral si está abierto
                if (document.body.classList.contains('nav-open')) {
                    document.body.classList.remove('nav-open');
                    const btn = document.getElementById('sideToggle');
                    if (btn) {
                        btn.setAttribute('aria-expanded', 'false');
                        btn.classList.remove('open');
                    }
                }
            });
        });
        // Mostrar sección inicial
        document.querySelectorAll('.card section').forEach(sec => {
            sec.style.display = sec.id === 'usersSection' ? '' : 'none';
        });
        // Side toggle: abrir/cerrar la navbar como panel lateral
        (function () {
            const btn = document.getElementById('sideToggle');
            const overlay = document.getElementById('navOverlay');
            const mainNodes = [document.querySelector('.top'), document.querySelector('.card')].filter(Boolean);
            let _trapListener = null;

            function _setMainAriaHidden(v) {
                for (const n of mainNodes) {
                    try { n.setAttribute('aria-hidden', v ? 'true' : 'false'); } catch (e) { }
                }
            }

            function openNav() {
                document.body.classList.add('nav-open');
                btn.setAttribute('aria-expanded', 'true');
                btn.classList.add('open');
                _setMainAriaHidden(true);
                // focus first focusable element inside nav (first link)
                const first = document.querySelector('.navbar a');
                if (first) first.focus();
                // install focus trap
                _trapListener = function (e) {
                    if (e.key !== 'Tab') return;
                    const focusables = Array.from(document.querySelectorAll('.navbar a, .navbar button, .navbar [href], .navbar [tabindex]:not([tabindex="-1"])')).filter(el => !el.hasAttribute('disabled'));
                    if (!focusables.length) return;
                    const firstEl = focusables[0];
                    const lastEl = focusables[focusables.length - 1];
                    if (e.shiftKey) {
                        if (document.activeElement === firstEl) { e.preventDefault(); lastEl.focus(); }
                    } else {
                        if (document.activeElement === lastEl) { e.preventDefault(); firstEl.focus(); }
                    }
                };
                document.addEventListener('keydown', _trapListener);
            }

            function closeNav() {
                document.body.classList.remove('nav-open');
                btn.setAttribute('aria-expanded', 'false');
                btn.classList.remove('open');
                _setMainAriaHidden(false);
                // remove focus trap
                if (_trapListener) { document.removeEventListener('keydown', _trapListener); _trapListener = null; }
                // return focus to toggle button
                try { btn.focus(); } catch (e) { }
            }
            btn.addEventListener('click', () => {
                if (document.body.classList.contains('nav-open')) closeNav(); else openNav();
            });
            overlay.addEventListener('click', closeNav);
            // cerrar con ESC
            document.addEventListener('keydown', (e) => { if (e.key === 'Escape') closeNav(); });
            // On resize, ensure breakpoint consistency: when width >= 768 remove mobile nav-open state
            window.addEventListener('resize', () => {
                try {
                    if (window.innerWidth >= 768) {
                        // ensure panel is considered closed for mobile-specific classes
                        if (document.body.classList.contains('nav-open')) {
                            document.body.classList.remove('nav-open');
                        }
                        if (btn) {
                            btn.setAttribute('aria-expanded', 'false');
                            btn.classList.remove('open');
                        }
                    }
                } catch (e) { }
            });
        })();
    </script>
    <script>
        // Inline form para crear usuario (mostrado directamente)
        (async function () {
            const formContainer = document.createElement('div');
            formContainer.id = 'newUserForm';
            formContainer.style = 'display:block;margin-top:12px;padding:12px;border-radius:12px;';
            formContainer.innerHTML = `
                <form id="createUserForm">
                    <div style="display:grid;grid-template-columns:1fr 1fr;gap:12px;margin:8px 0">
                        <div>
                            <div style="font-size:13px;margin-bottom:6px">Rol:</div>
                            <select id="newUserRole" style="width:100%;padding:10px;border-radius:8px;border:1px solid #ddd">
                                <option value="alumno">Alumno</option>
                                <option value="profesor">Profesor</option>
                            </select>
                        </div>
                        <div>
                            <div style="font-size:13px;margin-bottom:6px">DNI: <span class="required">*</span></div>
                            <input id="newUserDni" style="width:100%;padding:10px;border-radius:8px;border:1px solid #ddd" />
                        </div>
                        <div>
                            <div style="font-size:13px;margin-bottom:6px">Nombre: <span class="required">*</span></div>
                            <input id="newUserName" style="width:100%;padding:10px;border-radius:8px;border:1px solid #ddd" />
                        </div>
                        <div>
                            <div style="font-size:13px;margin-bottom:6px">Apellido: <span class="required">*</span></div>
                            <input id="newUserLastName" style="width:100%;padding:10px;border-radius:8px;border:1px solid #ddd" />
                        </div>
                        <div>
                            <div style="font-size:13px;margin-bottom:6px">Teléfono:</div>
                            <input id="newUserPhone" style="width:100%;padding:10px;border-radius:8px;border:1px solid #ddd" />
                        </div>
                        <div>
                            <div style="font-size:13px;margin-bottom:6px">Contacto de emergencia:</div>
                            <input id="newUserEmergency" style="width:100%;padding:10px;border-radius:8px;border:1px solid #ddd" />
                        </div>
                        <div>
                            <div style="font-size:13px;margin-bottom:6px">Tipo de cuota:</div>
                            <select id="newUserMembership" style="width:100%;padding:10px;border-radius:8px;border:1px solid #ddd">
                                <option value="mensual">Mensual</option>
                                <option value="trimestral">Trimestral</option>
                                <option value="anual">Anual</option>
                            </select>
                        </div>
                        <div>
                            <div style="font-size:13px;margin-bottom:6px">Vencimiento:</div>
                            <input type="date" id="newUserDueDate" style="width:100%;padding:10px;border-radius:8px;border:1px solid #ddd" />
                        </div>
                    </div>
                    <div id="classesDivInline" style="margin-top:12px">
                        <div style="font-size:13px;margin-bottom:6px">Clases asignadas: <span class="required">*</span></div>
                        <div id="newUserClassesContainer" style="max-height:150px;overflow-y:auto;border:1px solid #ddd;border-radius:8px;padding:6px;background:#fff"></div>
                    </div>
                    <div style="display:flex;gap:8px;justify-content:flex-end;margin-top:12px">
                        <button type="button" id="cancelNewUser">Cancelar</button>
                        <button type="submit" id="saveNewUser" style="background:#38a169;color:#fff">Guardar</button>
                    </div>
                </form>
            `;
            document.querySelector('#usersSection').appendChild(formContainer);

            // populate classes immediately (form is visible by default)
            try {
                const classes = await adminClasses.listClasses();
                const container = document.getElementById('newUserClassesContainer');
                container.innerHTML = classes.map(c => `
                    <label style="display:block;padding:8px;border-bottom:1px solid #eee">
                        <input type="checkbox" value="${c._id}" class="newUserClass" />
                        ${c.days.join(', ')} ${c.start} - ${c.roomName}
                    </label>
                `).join('');
            } catch (err) {
                document.getElementById('newUserClassesContainer').innerHTML = '<i>Error cargando clases</i>';
            }

            function toggleAlumnoFields() {
                const isAlumno = document.getElementById('newUserRole').value === 'alumno';
                document.getElementById('newUserEmergency').closest('div').style.display = isAlumno ? '' : 'none';
                document.getElementById('newUserMembership').closest('div').style.display = isAlumno ? '' : 'none';
                document.getElementById('newUserDueDate').closest('div').style.display = isAlumno ? '' : 'none';
                document.getElementById('classesDivInline').style.display = isAlumno ? '' : 'none';
            }

            // Delegate events
            document.getElementById('usersSection').addEventListener('change', (e) => {
                if (e.target && e.target.id === 'newUserRole') toggleAlumnoFields();
            });

            document.getElementById('usersSection').addEventListener('click', (e) => {
                if (e.target && e.target.id === 'cancelNewUser') {
                    // Reset form but keep it visible
                    const form = document.getElementById('createUserForm');
                    if (form) form.reset();
                    toggleAlumnoFields();
                }
            });

            document.getElementById('usersSection').addEventListener('submit', async (e) => {
                if (e.target && e.target.id === 'createUserForm') {
                    e.preventDefault();
                    const role = document.getElementById('newUserRole').value;
                    const user = {
                        dni: document.getElementById('newUserDni').value.trim(),
                        name: document.getElementById('newUserName').value.trim(),
                        lastName: document.getElementById('newUserLastName').value.trim(),
                        phone: document.getElementById('newUserPhone').value.trim(),
                    };
                    if (!user.dni || !user.name || !user.lastName) return alert('DNI, nombre y apellido son requeridos');
                    if (role === 'alumno') {
                        user.emergencyContact = document.getElementById('newUserEmergency').value.trim();
                        user.membershipType = document.getElementById('newUserMembership').value;
                        user.dueDate = document.getElementById('newUserDueDate').value;
                        user.classIds = Array.from(document.querySelectorAll('.newUserClass:checked')).map(cb => cb.value);
                        // Validar que al menos una clase esté seleccionada
                        if (!Array.isArray(user.classIds) || user.classIds.length === 0) {
                            return alert('Debe asignar al menos una clase al crear un alumno');
                        }
                        try {
                            await adminStudents.createStudent(user);
                            alert('Alumno creado');
                            document.getElementById('createUserForm').reset();
                            await loadStudents();
                            await loadClasses();
                        } catch (err) { alert(err.message || 'Error creando alumno'); }
                    } else if (role === 'profesor') {
                        try {
                            await adminProfessors.createProfessor(user);
                            alert('Profesor creado');
                            document.getElementById('createUserForm').reset();
                            await loadProfessors();
                        } catch (err) { alert(err.message || 'Error creando profesor'); }
                    }
                }
            });
            // set initial field visibility according to default role
            toggleAlumnoFields();
        })();
    </script>
    <script>
        const ensure = pilatesAuth.ensureRole(['administrador', 'superusuario']);
        ensure().then(async me => {
            document.getElementById('meInfo').textContent = `${me.email || me.dni} (${me.role})`;
            await loadRooms();
        });

        // Attach a simple, robust logout handler: perform the logout directly
        // (clear storage + navigate) to avoid depending on other modules.
        (function () {
            function directLogout() {
                try {
                    localStorage.removeItem('token');
                    localStorage.removeItem('role');
                } catch (e) { console.error('Clearing storage failed', e); }
                // replace so back button won't return to admin state
                window.location.replace('/index.html');
            }

            // Modal helpers (reused from alumno UI): showModal/closeModal and helpers
            function showModal(title, message, onConfirm) {
                const modalHTML = `
                    <div class="modal">
                        <div class="modal-content">
                            <h3>${title}</h3>
                            <p>${message}</p>
                            <div class="modal-actions">
                                <button onclick="closeModal()" style="background:#e2e8f0;color:#475569;box-shadow:none;">Cancelar</button>
                                <button onclick="confirmModal()">Confirmar</button>
                            </div>
                        </div>
                    </div>
                `;
                let container = document.getElementById('modalContainer');
                if (!container) {
                    container = document.createElement('div');
                    container.id = 'modalContainer';
                    document.body.appendChild(container);
                }
                container.innerHTML = modalHTML;
                window.modalConfirmCallback = onConfirm;
                window._modalOpen = true;
                try { document.body.classList.add('modal-open-no-shift'); } catch (e) { }
            }

            function closeModal() {
                const container = document.getElementById('modalContainer');
                if (container) container.innerHTML = '';
                window.modalConfirmCallback = null;
                window._modalOpen = false;
                try { document.body.classList.remove('modal-open-no-shift'); } catch (e) { }
            }

            function showOkModal(title, message, onOk) {
                const modalHTML = `
                    <div class="modal">
                        <div class="modal-content">
                            <h3>${title}</h3>
                            <p>${message}</p>
                            <div class="modal-actions" style="justify-content:center;">
                                <button onclick="okModalClick()" style="background:#667eea;color:#fff;">Aceptar</button>
                            </div>
                        </div>
                    </div>
                `;
                let container = document.getElementById('modalContainer');
                if (!container) {
                    container = document.createElement('div');
                    container.id = 'modalContainer';
                    document.body.appendChild(container);
                }
                container.innerHTML = modalHTML;
                window._modalOpen = true;
                try { document.body.classList.add('modal-open-no-shift'); } catch (e) { }
                window._okModalCallback = onOk;
            }

            function okModalClick() {
                try {
                    if (window._okModalCallback) window._okModalCallback();
                } finally {
                    const container = document.getElementById('modalContainer');
                    if (container) container.innerHTML = '';
                    window._okModalCallback = null;
                    window._modalOpen = false;
                    try { document.body.classList.remove('modal-open-no-shift'); } catch (e) { }
                }
            }

            function confirmModal() {
                if (window.modalConfirmCallback) {
                    try { window.modalConfirmCallback(); } catch (e) { console.error(e); }
                }
                closeModal();
            }
            // Expose modal helpers to global scope so inline onclick handlers work
            try {
                window.showModal = showModal;
                window.closeModal = closeModal;
                window.showOkModal = showOkModal;
                window.okModalClick = okModalClick;
                window.confirmModal = confirmModal;
            } catch (e) { /* ignore in non-browser env */ }

            function bindButton(btn) {
                // Use pointerdown in capture phase to intercept the user's action
                // before other handlers can close/hide the sidebar.
                const onPointerDown = function (e) {
                    try { e.preventDefault(); e.stopImmediatePropagation(); } catch (er) { }
                    showModal('Cerrar sesión', '¿Desea cerrar sesión?', directLogout);
                };
                // attach in capture so it runs early
                btn.addEventListener('pointerdown', onPointerDown, { capture: true });
                // also keep a capture click listener as backup
                btn.addEventListener('click', function (e) {
                    try { e.preventDefault(); e.stopImmediatePropagation(); } catch (er) { }
                    showModal('Cerrar sesión', '¿Desea cerrar sesión?', directLogout);
                }, { capture: true });
            }

            const btn = document.getElementById('logout');
            if (btn) {
                bindButton(btn);
            } else {
                // fallback: delegate on capture so we catch early if button is injected later
                document.addEventListener('click', function (e) {
                    const t = e.target;
                    if (!t) return;
                    if (t.id === 'logout' || (t.closest && t.closest('#logout'))) {
                        e.preventDefault();
                        e.stopPropagation();
                        showModal('Cerrar sesión', '¿Desea cerrar sesión?', directLogout);
                    }
                }, { capture: true });
            }
        })();

        async function loadRooms(filter = '') {
            try {
                const rooms = await adminRooms.listRooms();
                renderRooms(rooms.filter(r => r.name.toLowerCase().includes(filter.toLowerCase())));
            } catch (err) {
                document.getElementById('roomsList').textContent = 'Error cargando salones';
            }
        }
        // helper to escape inserted text
        function esc(s) { return String(s == null ? '' : s).replace(/&/g, '&amp;').replace(/</g, '&lt;').replace(/>/g, '&gt;'); }

        function renderRooms(rooms) {
            const container = document.getElementById('roomsList');
            if (!rooms.length) { container.innerHTML = '<i>No hay salones</i>'; return }
            // always show cards
            const cards = rooms.map(r => `
                <div class="item-card" data-id="${esc(r._id)}">
                    <div>
                        <h4>${esc(r.name)}</h4>
                        <div class="meta">Camillas: ${esc(r.capacity)}</div>
                    </div>
                    <div class="actions">
                        <button class="editRoom btn-edit">Editar</button>
                        <button class="delRoom btn-delete">Eliminar</button>
                    </div>
                </div>
            `).join('');
            container.innerHTML = `<div class="cards-grid">${cards}</div>`;

            container.querySelectorAll('.editRoom').forEach(b => b.addEventListener('click', e => {
                const card = e.target.closest('.item-card');
                const id = card.dataset.id;
                const name = card.querySelector('h4')?.textContent || '';
                const capText = card.querySelector('.meta')?.textContent || '';
                const capacity = (capText.match(/\d+/) || [''])[0];
                openEditRoomModal(id, name, capacity);
            }));

            container.querySelectorAll('.delRoom').forEach(b => b.addEventListener('click', async e => {
                const id = e.target.closest('.item-card').dataset.id;
                if (!confirm('Eliminar salón?')) return;
                await adminRooms.deleteRoom(id);
                await loadRooms(document.getElementById('searchRooms').value);
            }));
        }

        document.getElementById('btnNewRoom').addEventListener('click', () => openNewRoomModal());
        document.getElementById('searchRooms').addEventListener('input', (e) => loadRooms(e.target.value));

        function openNewRoomModal() {
            const modal = document.createElement('div');
            modal.style = 'position:fixed;inset:0;background:rgba(0,0,0,0.35);display:flex;align-items:center;justify-content:center';
            modal.innerHTML = `
                    <div style="background:#fff;padding:16px;border-radius:8px;width:360px">
                        <h4>Nuevo salón</h4>
                        <input id="newRoomName" placeholder="Nombre" style="width:100%;padding:8px;margin:8px 0;border:1px solid #ddd;border-radius:4px" />
                        <input id="newRoomCapacity" type="number" placeholder="Cantidad de camillas" style="width:100%;padding:8px;margin:8px 0;border:1px solid #ddd;border-radius:4px" />
                        <div style="display:flex;gap:8px;justify-content:flex-end"><button id="cancelNew">Cancelar</button><button id="saveNew" style="background:#2b6cb0;color:#fff">Guardar</button></div>
                    </div>`;
            document.body.appendChild(modal);
            document.getElementById('cancelNew').addEventListener('click', () => modal.remove());
            document.getElementById('saveNew').addEventListener('click', async () => {
                const name = document.getElementById('newRoomName').value.trim();
                const capacity = document.getElementById('newRoomCapacity').value;
                if (!name || !capacity) return alert('Completá nombre y capacidad');
                try { await adminRooms.createRoom(name, Number(capacity)); modal.remove(); await loadRooms(); } catch (err) { alert(err.message || 'Error creando salón') }
            });
        }

        function openEditRoomModal(id, name, capacity) {
            const modal = document.createElement('div');
            modal.style = 'position:fixed;inset:0;background:rgba(0,0,0,0.35);display:flex;align-items:center;justify-content:center';
            modal.innerHTML = `
                    <div style="background:#fff;padding:16px;border-radius:8px;width:360px">
                        <h4>Editar salón</h4>
                        <input id="editRoomName" value="${name}" style="width:100%;padding:8px;margin:8px 0;border:1px solid #ddd;border-radius:4px" />
                        <input id="editRoomCapacity" type="number" value="${capacity}" style="width:100%;padding:8px;margin:8px 0;border:1px solid #ddd;border-radius:4px" />
                        <div style="display:flex;gap:8px;justify-content:flex-end"><button id="cancelEdit">Cancelar</button><button id="saveEdit" style="background:#2b6cb0;color:#fff">Guardar</button></div>
                    </div>`;
            document.body.appendChild(modal);
            document.getElementById('cancelEdit').addEventListener('click', () => modal.remove());
            document.getElementById('saveEdit').addEventListener('click', async () => {
                const newName = document.getElementById('editRoomName').value.trim();
                const newCap = document.getElementById('editRoomCapacity').value;
                if (!newName || !newCap) return alert('Completá nombre y capacidad');
                try { await adminRooms.updateRoom(id, newName, Number(newCap)); modal.remove(); await loadRooms(); } catch (err) { alert(err.message || 'Error actualizando salón') }
            });
        }
    </script>

    <script>
        // Clases
        async function loadClasses(filter = '') {
            try {
                const classes = await adminClasses.listClasses();
                renderClasses(classes.filter(c => (c.roomName || '').toLowerCase().includes(filter.toLowerCase()) || (c.professorName || '').toLowerCase().includes(filter.toLowerCase())));
            } catch (err) { document.getElementById('classesList').textContent = 'Error cargando clases' }
        }

        function renderClasses(classes) {
            const container = document.getElementById('classesList');
            if (!classes.length) { container.innerHTML = '<i>No hay clases</i>'; return }
            // always render cards
            const cards = classes.map(c => `
                <div class="item-card" data-id="${esc(c._id)}">
                    <div>
                        <h4>${esc((c.days || []).join(', '))}</h4>
                        <div class="meta">Horario: ${esc(c.start)} (${esc(c.duration)} min) • Salón: ${esc(c.roomName || '')} • Profesor: ${esc(c.professorName || '')}</div>
                        <div class="meta">Camillas libres: ${esc(c.camillasFree)}</div>
                    </div>
                    <div class="actions">
                        <button class="editClass btn-edit">Editar</button>
                        <button class="manageStudents btn-manage">Alumnos</button>
                        <button class="delClass btn-delete">Eliminar</button>
                    </div>
                </div>
            `).join('');
            container.innerHTML = `<div class="cards-grid">${cards}</div>`;

            container.querySelectorAll('.editClass').forEach(b => b.addEventListener('click', e => {
                const id = e.target.closest('.item-card').dataset.id;
                openEditClassModal(id);
            }));

            container.querySelectorAll('.delClass').forEach(b => b.addEventListener('click', async e => {
                const id = e.target.closest('.item-card').dataset.id;
                if (!confirm('Eliminar clase?')) return;
                await adminClasses.deleteClass(id);
                await loadClasses(document.getElementById('searchClasses').value);
            }));

            container.querySelectorAll('.manageStudents').forEach(b => b.addEventListener('click', e => {
                const id = e.target.closest('.item-card').dataset.id;
                openManageStudentsModal(id);
            }));
        }

        document.getElementById('btnNewClass').addEventListener('click', () => openNewClassModal());
        document.getElementById('searchClasses').addEventListener('input', (e) => loadClasses(e.target.value));

        async function openNewClassModal() {
            // fetch rooms and professors
            const rooms = await adminRooms.listRooms();
            const profs = await fetch('/api/users?role=profesor', { headers: { Authorization: `Bearer ${localStorage.getItem('token')}` } }).then(r => r.json());
            const modal = document.createElement('div');
            modal.style = 'position:fixed;inset:0;background:rgba(0,0,0,0.35);display:flex;align-items:center;justify-content:center';
            modal.innerHTML = `
                    <div style="background:#fff;padding:16px;border-radius:8px;width:420px">
                        <h4>Crear clase</h4>
                        <div>Días (Ctrl+click para múltiples):</div>
                        <select id="classDays" multiple style="width:100%;height:80px;margin:8px 0">
                            <option>lunes</option><option>martes</option><option>miercoles</option><option>jueves</option><option>viernes</option><option>sabado</option>
                        </select>
                        <input id="classStart" placeholder="Horario (HH:MM)" style="width:100%;padding:8px;margin:8px 0;border:1px solid #ddd;border-radius:4px" />
                        <input id="classDuration" type="number" placeholder="Duración (min)" style="width:100%;padding:8px;margin:8px 0;border:1px solid #ddd;border-radius:4px" />
                        <select id="classRoom" style="width:100%;padding:8px;margin:8px 0;border:1px solid #ddd;border-radius:4px">
                            ${rooms.map(r => `<option value="${r._id}">${r.name}</option>`).join('')}
                        </select>
                        <select id="classProf" style="width:100%;padding:8px;margin:8px 0;border:1px solid #ddd;border-radius:4px">
                            <option value="">(sin asignar)</option>
                            ${profs.map(p => `<option value="${p._id}">${p.name}</option>`).join('')}
                        </select>
                        <div style="display:flex;gap:8px;justify-content:flex-end"><button id="cancelClass">Cancelar</button><button id="saveClass" style="background:#2b6cb0;color:#fff">Crear</button></div>
                    </div>`;
            document.body.appendChild(modal);
            document.getElementById('cancelClass').addEventListener('click', () => modal.remove());
            document.getElementById('saveClass').addEventListener('click', async () => {
                const days = Array.from(document.getElementById('classDays').selectedOptions).map(o => o.text);
                const start = document.getElementById('classStart').value.trim();
                const duration = document.getElementById('classDuration').value;
                const roomId = document.getElementById('classRoom').value;
                const professorId = document.getElementById('classProf').value || null;
                if (!days.length || !start || !duration || !roomId) return alert('Completá todos los campos');
                try { await adminClasses.createClass({ days, start, duration: Number(duration), roomId, professorId }); modal.remove(); await loadClasses(); } catch (err) { alert(err.message || 'Error creando clase') }
            });
        }

        async function openEditClassModal(id) {
            const classes = await adminClasses.listClasses();
            const c = classes.find(x => x._id === id || x._id == id);
            if (!c) return alert('Clase no encontrada');
            const rooms = await adminRooms.listRooms();
            const profs = await fetch('/api/users?role=profesor', { headers: { Authorization: `Bearer ${localStorage.getItem('token')}` } }).then(r => r.json());
            const modal = document.createElement('div');
            modal.style = 'position:fixed;inset:0;background:rgba(0,0,0,0.35);display:flex;align-items:center;justify-content:center';
            modal.innerHTML = `
                    <div style="background:#fff;padding:16px;border-radius:8px;width:420px">
                        <h4>Editar clase</h4>
                        <div>Días (Ctrl+click para múltiples):</div>
                        <select id="classDaysEdit" multiple style="width:100%;height:80px;margin:8px 0">
                            <option ${c.days.includes('lunes') ? 'selected' : ''}>lunes</option><option ${c.days.includes('martes') ? 'selected' : ''}>martes</option><option ${c.days.includes('miercoles') ? 'selected' : ''}>miercoles</option><option ${c.days.includes('jueves') ? 'selected' : ''}>jueves</option><option ${c.days.includes('viernes') ? 'selected' : ''}>viernes</option><option ${c.days.includes('sabado') ? 'selected' : ''}>sabado</option>
                        </select>
                        <input id="classStartEdit" value="${c.start}" style="width:100%;padding:8px;margin:8px 0;border:1px solid #ddd;border-radius:4px" />
                        <input id="classDurationEdit" type="number" value="${c.duration}" style="width:100%;padding:8px;margin:8px 0;border:1px solid #ddd;border-radius:4px" />
                        <select id="classRoomEdit" style="width:100%;padding:8px;margin:8px 0;border:1px solid #ddd;border-radius:4px">
                            ${rooms.map(r => `<option value="${r._id}" ${c.roomId == r._id ? 'selected' : ''}>${r.name}</option>`).join('')}
                        </select>
                        <select id="classProfEdit" style="width:100%;padding:8px;margin:8px 0;border:1px solid #ddd;border-radius:4px">
                            <option value="">(sin asignar)</option>
                            ${profs.map(p => `<option value="${p._id}" ${c.professorId == p._id ? 'selected' : ''}>${p.name}</option>`).join('')}
                        </select>
                        <div style="display:flex;gap:8px;justify-content:flex-end"><button id="cancelClassEdit">Cancelar</button><button id="saveClassEdit" style="background:#2b6cb0;color:#fff">Guardar</button></div>
                    </div>`;
            document.body.appendChild(modal);
            document.getElementById('cancelClassEdit').addEventListener('click', () => modal.remove());
            document.getElementById('saveClassEdit').addEventListener('click', async () => {
                const days = Array.from(document.getElementById('classDaysEdit').selectedOptions).map(o => o.text);
                const start = document.getElementById('classStartEdit').value.trim();
                const duration = document.getElementById('classDurationEdit').value;
                const roomId = document.getElementById('classRoomEdit').value;
                const professorId = document.getElementById('classProfEdit').value || null;
                if (!days.length || !start || !duration || !roomId) return alert('Completá todos los campos');
                try { await adminClasses.updateClass(id, { days, start, duration: Number(duration), roomId, professorId }); modal.remove(); await loadClasses(); } catch (err) { alert(err.message || 'Error actualizando clase') }
            });
        }

        // inicializar
        async function openManageStudentsModal(classId) {
            // Obtener los estudiantes actuales de la clase
            const students = await adminClasses.getClassStudents(classId);

            // Obtener todos los estudiantes disponibles
            const allStudents = await fetch('/api/users?role=alumno', {
                headers: { Authorization: `Bearer ${localStorage.getItem('token')}` }
            }).then(r => r.json());

            // Obtener los datos de la clase
            const classes = await adminClasses.listClasses();
            const classInfo = classes.find(c => c._id === classId);

            const modal = document.createElement('div');
            modal.style = 'position:fixed;inset:0;background:rgba(0,0,0,0.35);display:flex;align-items:center;justify-content:center';
            modal.innerHTML = `
                <div style="background:#fff;padding:16px;border-radius:8px;width:480px;max-height:90vh;overflow-y:auto">
                    <h4>Gestionar Estudiantes - ${classInfo.start} (${classInfo.days.join(', ')})</h4>
                    
                    <div style="margin:16px 0">
                        <div>Agregar estudiante:</div>
                        <div style="display:flex;gap:8px;margin-top:8px">
                            <select id="newStudent" style="flex:1;padding:8px;border:1px solid #ddd;border-radius:4px">
                                <option value="">Seleccionar estudiante...</option>
                                ${allStudents
                    .filter(s => !students.find(cs => cs._id === s._id))
                    .map(s => `<option value="${s._id}">${s.name || s.dni}</option>`)
                    .join('')}
                            </select>
                            <button id="addStudent" style="background:#48bb78;color:#fff">Agregar</button>
                        </div>
                    </div>

                    <div style="margin:16px 0">
                        <div>Estudiantes inscritos (${students.length}/${classInfo.roomName ? ` max ${classInfo.camillasFree + students.length}` : ''}):</div>
                        ${students.length ? `
                            <table style="width:100%;margin-top:8px;border-collapse:collapse">
                                <thead>
                                    <tr>
                                        <th style="text-align:left">Nombre/DNI</th>
                                        <th></th>
                                    </tr>
                                </thead>
                                <tbody>
                                    ${students.map(s => `
                                        <tr>
                                            <td style="padding:8px;border-top:1px solid #eee">${s.name || s.dni}</td>
                                            <td style="padding:8px;border-top:1px solid #eee;text-align:right">
                                                <button class="removeStudent" data-id="${s._id}" style="background:#e53e3e;color:#fff">
                                                    Dar de baja
                                                </button>
                                            </td>
                                        </tr>
                                    `).join('')}
                                </tbody>
                            </table>
                        ` : '<div style="margin-top:8px"><i>No hay estudiantes inscritos</i></div>'}
                    </div>

                    <div style="display:flex;justify-content:flex-end;margin-top:16px">
                        <button id="closeStudents">Cerrar</button>
                    </div>
                </div>
            `;

            document.body.appendChild(modal);

            // Event listeners
            document.getElementById('closeStudents').addEventListener('click', () => modal.remove());

            document.getElementById('addStudent').addEventListener('click', async () => {
                const studentId = document.getElementById('newStudent').value;
                if (!studentId) return alert('Selecciona un estudiante');

                try {
                    await adminClasses.addStudent(classId, studentId);
                    modal.remove();
                    openManageStudentsModal(classId); // Reabrir modal actualizado
                    await loadClasses(); // Actualizar lista de clases
                } catch (err) {
                    alert(err.message || 'Error al inscribir estudiante');
                }
            });

            document.querySelectorAll('.removeStudent').forEach(btn => {
                btn.addEventListener('click', async () => {
                    const studentId = btn.dataset.id;
                    if (!confirm('¿Dar de baja al estudiante?')) return;

                    try {
                        await adminClasses.removeStudent(classId, studentId);
                        modal.remove();
                        openManageStudentsModal(classId); // Reabrir modal actualizado
                        await loadClasses(); // Actualizar lista de clases
                    } catch (err) {
                        alert(err.message || 'Error al dar de baja estudiante');
                    }
                });
            });
        }

        // Gestión de Alumnos
        async function loadStudents(search = '') {
            try {
                const students = await adminStudents.listStudents(search);
                await renderStudents(students);
            } catch (err) {
                document.getElementById('studentsList').textContent = 'Error cargando alumnos';
            }
        }
        async function renderStudents(students) {
            if (!students.length) {
                document.getElementById('studentsList').innerHTML = '<i>No hay alumnos</i>';
                return;
            }
            const container = document.getElementById('studentsList');

            // fetch classes once to compute assigned classes per student
            let classes = [];
            try { classes = await adminClasses.listClasses(); } catch (e) { classes = []; }

            const cards = students.map(s => {
                // find classes where this student is assigned
                const assigned = classes.filter(c => Array.isArray(c.students) && c.students.some(ss => ss === s._id || (ss && ss._id === s._id))).map(c => `${(c.days || []).join(', ')} ${c.start} - ${c.roomName || ''}`);
                const assignedText = assigned.length ? assigned.join(' | ') : 'Sin asignar';
                const dueDate = s.dueDate ? new Date(s.dueDate).toLocaleDateString() : 'No establecida';
                return `
                    <div class="item-card" data-id="${esc(s._id)}">
                        <div>
                            <h4>${esc((s.name || '') + ' ' + (s.lastName || ''))}</h4>
                            <div class="meta">DNI: ${esc(s.dni || '')} • Tel: ${esc(s.phone || '')}</div>
                            <div class="meta">Contacto emergencia: ${esc(s.emergencyContact || '')}</div>
                            <div class="meta">Vencimiento: ${esc(dueDate)} • Tipo cuota: ${esc(s.membershipType || '')}</div>
                            <div class="meta">Clases: ${esc(assignedText)}</div>
                        </div>
                        <div class="actions">
                            <button class="editStudent btn-edit">Editar</button>
                            <button class="delStudent btn-delete">Eliminar</button>
                        </div>
                    </div>
                `;
            }).join('');

            container.innerHTML = `<div class="cards-grid">${cards}</div>`;

            container.querySelectorAll('.editStudent').forEach(b => b.addEventListener('click', e => {
                const id = e.target.closest('.item-card').dataset.id;
                openEditStudentModal(id);
            }));

            container.querySelectorAll('.delStudent').forEach(b => b.addEventListener('click', async e => {
                const id = e.target.closest('.item-card').dataset.id;
                if (!confirm('¿Eliminar alumno? Se dará de baja de todas sus clases.')) return;
                try {
                    await adminStudents.deleteStudent(id);
                    await loadStudents(document.getElementById('searchStudents').value);
                    await loadClasses(); // Actualizar lista de clases
                } catch (err) {
                    alert(err.message || 'Error eliminando alumno');
                }
            }));
        }

        async function openNewStudentModal() {
            const classes = await adminClasses.listClasses();

            const modal = document.createElement('div');
            modal.style = 'position:fixed;inset:0;background:rgba(0,0,0,0.35);display:flex;align-items:center;justify-content:center';
            modal.innerHTML = `
                <div style="background:#fff;padding:16px;border-radius:8px;width:600px;max-height:90vh;overflow-y:auto">
                    <h4>Nuevo Alumno</h4>
                    
                    <div style="display:grid;grid-template-columns:1fr 1fr;gap:12px;margin:16px 0">
                        <div>
                            <div>DNI: <span class="required">*</span></div>
                                <input id="newStudentDni" style="width:100%;padding:8px;margin:4px 0;border:1px solid #ddd;border-radius:4px" />
                        </div>
                        <div>
                            <div>Nombre: <span class="required">*</span></div>
                                <input id="newStudentName" style="width:100%;padding:8px;margin:4px 0;border:1px solid #ddd;border-radius:4px" />
                        </div>
                        <div>
                            <div>Apellido: <span class="required">*</span></div>
                                <input id="newStudentLastName" style="width:100%;padding:8px;margin:4px 0;border:1px solid #ddd;border-radius:4px" />
                        </div>
                        <div>
                            <div>Teléfono:</div>
                            <input id="newStudentPhone" style="width:100%;padding:8px;margin:4px 0;border:1px solid #ddd;border-radius:4px" />
                        </div>
                        <div>
                            <div>Contacto de emergencia:</div>
                            <input id="newStudentEmergency" style="width:100%;padding:8px;margin:4px 0;border:1px solid #ddd;border-radius:4px" />
                        </div>
                        <div>
                            <div>Tipo de cuota:</div>
                            <select id="newStudentMembership" style="width:100%;padding:8px;margin:4px 0;border:1px solid #ddd;border-radius:4px">
                                <option value="mensual">Mensual</option>
                                <option value="trimestral">Trimestral</option>
                                <option value="anual">Anual</option>
                            </select>
                        </div>
                        <div>
                            <div>Vencimiento:</div>
                            <input type="date" id="newStudentDueDate" style="width:100%;padding:8px;margin:4px 0;border:1px solid #ddd;border-radius:4px" />
                        </div>
                    </div>

                    <div style="margin:16px 0">
                        <div>Clases asignadas:</div>
                        <div style="max-height:150px;overflow-y:auto;border:1px solid #ddd;border-radius:4px;margin-top:4px">
                            ${classes.map(c => `
                                <label style="display:block;padding:8px;border-bottom:1px solid #eee">
                                    <input type="checkbox" value="${c._id}" class="newStudentClass" />
                                    ${c.days.join(', ')} ${c.start} - ${c.roomName}
                                    (${c.camillasFree} lugares libres)
                                </label>
                            `).join('')}
                        </div>
                    </div>

                    <div style="display:flex;gap:8px;justify-content:flex-end">
                        <button id="cancelNewStudent">Cancelar</button>
                        <button id="saveNewStudent" style="background:#2b6cb0;color:#fff">Guardar</button>
                    </div>
                </div>
            `;

            document.body.appendChild(modal);

            // Event listeners
            document.getElementById('cancelNewStudent').addEventListener('click', () => modal.remove());
            document.getElementById('saveNewStudent').addEventListener('click', async () => {
                const student = {
                    dni: document.getElementById('newStudentDni').value.trim(),
                    name: document.getElementById('newStudentName').value.trim(),
                    lastName: document.getElementById('newStudentLastName').value.trim(),
                    phone: document.getElementById('newStudentPhone').value.trim(),
                    emergencyContact: document.getElementById('newStudentEmergency').value.trim(),
                    membershipType: document.getElementById('newStudentMembership').value,
                    dueDate: document.getElementById('newStudentDueDate').value,
                    classIds: Array.from(document.querySelectorAll('.newStudentClass:checked')).map(cb => cb.value)
                };

                if (!student.dni || !student.name || !student.lastName) {
                    return alert('DNI, nombre y apellido son requeridos');
                }

                // Validar que tenga al menos una clase asignada
                if (!Array.isArray(student.classIds) || student.classIds.length === 0) {
                    return alert('Debe asignar al menos una clase al crear un alumno');
                }

                try {
                    await adminStudents.createStudent(student);
                    modal.remove();
                    await loadStudents();
                    await loadClasses(); // Actualizar lista de clases
                } catch (err) {
                    alert(err.message || 'Error creando alumno');
                }
            });
        }

        async function openEditStudentModal(id) {
            const students = await adminStudents.listStudents();
            const student = students.find(s => s._id === id);
            if (!student) return alert('Alumno no encontrado');

            const classes = await adminClasses.listClasses();
            const studentClasses = classes.filter(c =>
                c.students && c.students.some(s => s === id || s._id === id)
            );

            const modal = document.createElement('div');
            modal.style = 'position:fixed;inset:0;background:rgba(0,0,0,0.35);display:flex;align-items:center;justify-content:center';
            modal.innerHTML = `
                <div style="background:#fff;padding:16px;border-radius:8px;width:600px;max-height:90vh;overflow-y:auto">
                    <h4>Editar Alumno</h4>
                    
                    <div style="display:grid;grid-template-columns:1fr 1fr;gap:12px;margin:16px 0">
                        <div>
                            <div>DNI: <span class="required">*</span></div>
                                <input id="editStudentDni" value="${student.dni}" style="width:100%;padding:8px;margin:4px 0;border:1px solid #ddd;border-radius:4px" />
                        </div>
                        <div>
                            <div>Nombre: <span class="required">*</span></div>
                                <input id="editStudentName" value="${student.name || ''}" style="width:100%;padding:8px;margin:4px 0;border:1px solid #ddd;border-radius:4px" />
                        </div>
                        <div>
                            <div>Apellido: <span class="required">*</span></div>
                                <input id="editStudentLastName" value="${student.lastName || ''}" style="width:100%;padding:8px;margin:4px 0;border:1px solid #ddd;border-radius:4px" />
                        </div>
                        <div>
                            <div>Teléfono:</div>
                            <input id="editStudentPhone" value="${student.phone || ''}" style="width:100%;padding:8px;margin:4px 0;border:1px solid #ddd;border-radius:4px" />
                        </div>
                        <div>
                            <div>Contacto de emergencia:</div>
                            <input id="editStudentEmergency" value="${student.emergencyContact || ''}" style="width:100%;padding:8px;margin:4px 0;border:1px solid #ddd;border-radius:4px" />
                        </div>
                        <div>
                            <div>Tipo de cuota:</div>
                            <select id="editStudentMembership" style="width:100%;padding:8px;margin:4px 0;border:1px solid #ddd;border-radius:4px">
                                <option value="mensual" ${student.membershipType === 'mensual' ? 'selected' : ''}>Mensual</option>
                                <option value="trimestral" ${student.membershipType === 'trimestral' ? 'selected' : ''}>Trimestral</option>
                                <option value="anual" ${student.membershipType === 'anual' ? 'selected' : ''}>Anual</option>
                            </select>
                        </div>
                        <div>
                            <div>Vencimiento:</div>
                            <input type="date" id="editStudentDueDate" value="${adminStudents.formatDate(student.dueDate)}" 
                                style="width:100%;padding:8px;margin:4px 0;border:1px solid #ddd;border-radius:4px" />
                        </div>
                    </div>

                    <div style="margin:16px 0">
                        <div>Clases asignadas:</div>
                        <div style="max-height:150px;overflow-y:auto;border:1px solid #ddd;border-radius:4px;margin-top:4px">
                            ${classes.map(c => `
                                <label style="display:block;padding:8px;border-bottom:1px solid #eee">
                                    <input type="checkbox" value="${c._id}" class="editStudentClass" 
                                        ${studentClasses.some(sc => sc._id === c._id) ? 'checked' : ''} />
                                    ${c.days.join(', ')} ${c.start} - ${c.roomName}
                                    (${c.camillasFree} lugares libres)
                                </label>
                            `).join('')}
                        </div>
                    </div>

                    <div style="display:flex;gap:8px;justify-content:flex-end">
                        <button id="cancelEditStudent">Cancelar</button>
                        <button id="saveEditStudent" style="background:#2b6cb0;color:#fff">Guardar</button>
                    </div>
                </div>
            `;

            document.body.appendChild(modal);

            // Event listeners
            document.getElementById('cancelEditStudent').addEventListener('click', () => modal.remove());
            document.getElementById('saveEditStudent').addEventListener('click', async () => {
                const updatedStudent = {
                    dni: document.getElementById('editStudentDni').value.trim(),
                    name: document.getElementById('editStudentName').value.trim(),
                    lastName: document.getElementById('editStudentLastName').value.trim(),
                    phone: document.getElementById('editStudentPhone').value.trim(),
                    emergencyContact: document.getElementById('editStudentEmergency').value.trim(),
                    membershipType: document.getElementById('editStudentMembership').value,
                    dueDate: document.getElementById('editStudentDueDate').value,
                    classIds: Array.from(document.querySelectorAll('.editStudentClass:checked')).map(cb => cb.value)
                };

                if (!updatedStudent.dni || !updatedStudent.name || !updatedStudent.lastName) {
                    return alert('DNI, nombre y apellido son requeridos');
                }

                try {
                    await adminStudents.updateStudent(id, updatedStudent);
                    modal.remove();
                    await loadStudents();
                    await loadClasses(); // Actualizar lista de clases
                } catch (err) {
                    alert(err.message || 'Error actualizando alumno');
                }
            });
        }

        // Event listeners para estudiantes
        document.getElementById('btnNewStudent').addEventListener('click', () => openNewStudentModal());
        document.getElementById('searchStudents').addEventListener('input', (e) => loadStudents(e.target.value));

        // Gestión de Profesores
        async function loadProfessors() {
            try {
                const professors = await adminProfessors.listProfessors();
                await renderProfessors(professors);
            } catch (err) {
                document.getElementById('professorsList').textContent = 'Error cargando profesores';
            }
        }

        async function renderProfessors(professors) {
            const container = document.getElementById('professorsList');
            if (!professors.length) { container.innerHTML = '<i>No hay profesores</i>'; return }

            // load classes once to compute assigned classes per professor
            let classes = [];
            try { classes = await adminClasses.listClasses(); } catch (e) { classes = []; }

            // build map of professorId -> list of class descriptions
            const byProf = {};
            for (const c of classes) {
                const pid = c.professorId ? String(c.professorId) : null;
                const desc = `${(c.days || []).join(', ')} ${c.start} - ${c.roomName || ''}`;
                if (!pid) continue;
                if (!byProf[pid]) byProf[pid] = [];
                byProf[pid].push(desc);
            }

            // always render cards, including assigned classes as pills
            const cards = professors.map(p => {
                const pid = String(p._id);
                const assigned = byProf[pid] || [];
                const full = assigned.length ? assigned.join(' • ') : 'Sin asignar';
                return `
                    <div class="item-card" data-id="${esc(p._id)}">
                        <div>
                            <h4>${esc((p.name || '') + ' ' + (p.lastName || ''))}</h4>
                            <div class="meta">DNI: ${esc(p.dni || '')} • Tel: ${esc(p.phone || '')}</div>
                            <div class="prof-classes" title="${esc(full)}">
                                ${assigned.length ? assigned.map(a => `<span class="pill">${esc(a)}</span>`).join('') : '<span class="pill">Sin asignar</span>'}
                            </div>
                        </div>
                        <div class="actions">
                            <button class="editProfessor btn-edit" type="button" data-action="edit">Editar</button>
                            <button class="delProfessor btn-delete" type="button" data-action="delete">Eliminar</button>
                        </div>
                    </div>
                `;
            }).join('');
            container.innerHTML = `<div class="cards-grid">${cards}</div>`;

            // Attach a single delegated event handler (attach once)
            if (!container.dataset.delegateAttached) {
                container.addEventListener('click', async (e) => {
                    const btn = e.target.closest('button[data-action]');
                    if (!btn) return;
                    const action = btn.getAttribute('data-action');
                    const card = btn.closest('.item-card');
                    if (!card) return;
                    const id = card.dataset.id;
                    if (action === 'edit') {
                        e.preventDefault();
                        openEditProfessorModal(id);
                        return;
                    }
                    if (action === 'delete') {
                        e.preventDefault();
                        if (!confirm('¿Eliminar profesor?')) return;
                        try {
                            await adminProfessors.deleteProfessor(id);
                            await loadProfessors();
                            await loadClasses();
                        } catch (err) { alert(err.message || 'Error eliminando profesor'); }
                        return;
                    }
                });
                container.dataset.delegateAttached = '1';
            }
        }

        function openNewProfessorModal() {
            const modal = document.createElement('div');
            modal.style = 'position:fixed;inset:0;background:rgba(0,0,0,0.35);display:flex;align-items:center;justify-content:center';
            // Build modal content dynamically so we can load classes
            modal.innerHTML = `
                <div id="newProfessorModalContent" style="background:#fff;padding:16px;border-radius:8px;width:420px;max-height:80vh;overflow:auto">
                    <h4>Nuevo Profesor</h4>
                    <div id="newProfessorFields">Cargando...</div>
                </div>
            `;

            document.body.appendChild(modal);
            // populate fields including classes
            (async function populateNewProfessor() {
                try {
                    const classes = await adminClasses.listClasses();
                    const html = `
                        <div style="margin:16px 0">
                            <div>DNI: <span class="required">*</span></div>
                            <input id="newProfessorDni" style="width:100%;padding:8px;margin:4px 0;border:1px solid #ddd;border-radius:4px" />
                            
                            <div style="margin-top:8px">Nombre: <span class="required">*</span></div>
                            <input id="newProfessorName" style="width:100%;padding:8px;margin:4px 0;border:1px solid #ddd;border-radius:4px" />
                            
                            <div style="margin-top:8px">Apellido: <span class="required">*</span></div>
                            <input id="newProfessorLastName" style="width:100%;padding:8px;margin:4px 0;border:1px solid #ddd;border-radius:4px" />
                            
                            <div style="margin-top:8px">Teléfono:</div>
                            <input id="newProfessorPhone" style="width:100%;padding:8px;margin:4px 0;border:1px solid #ddd;border-radius:4px" />
                        </div>

                        <div style="margin:8px 0">
                            <div>Clases asignadas (opcional):</div>
                            <div style="max-height:160px;overflow:auto;border:1px solid #ddd;border-radius:4px;margin-top:6px;padding:6px;background:#fff">
                                ${classes.map(c => `
                                    <label style="display:block;padding:6px;border-bottom:1px solid #eee">
                                        <input type="checkbox" value="${c._id}" class="newProfessorClass" />
                                        ${esc((c.days || []).join(', '))} ${esc(c.start)} - ${esc(c.roomName || '')}
                                    </label>
                                `).join('')}
                            </div>
                        </div>

                        <div style="display:flex;gap:8px;justify-content:flex-end;margin-top:8px">
                            <button id="cancelNewProfessor">Cancelar</button>
                            <button id="saveNewProfessor" style="background:#2b6cb0;color:#fff">Guardar</button>
                        </div>
                    `;
                    document.getElementById('newProfessorFields').innerHTML = html;

                    document.getElementById('cancelNewProfessor').addEventListener('click', () => modal.remove());
                    document.getElementById('saveNewProfessor').addEventListener('click', async () => {
                        const professor = {
                            dni: document.getElementById('newProfessorDni').value.trim(),
                            name: document.getElementById('newProfessorName').value.trim(),
                            lastName: document.getElementById('newProfessorLastName').value.trim(),
                            phone: document.getElementById('newProfessorPhone').value.trim()
                        };

                        if (!professor.dni || !professor.name || !professor.lastName) {
                            return alert('DNI, nombre y apellido son requeridos');
                        }

                        const selectedClassIds = Array.from(document.querySelectorAll('.newProfessorClass:checked')).map(cb => cb.value);

                        try {
                            const created = await adminProfessors.createProfessor(professor);
                            // The API returns { id: <insertedId> } — use created.id
                            const newProfId = created.id || created._id || null;
                            // assign professor to selected classes by updating each class
                            if (newProfId && Array.isArray(selectedClassIds) && selectedClassIds.length) {
                                const allClasses = await adminClasses.listClasses();
                                for (const cid of selectedClassIds) {
                                    const cl = allClasses.find(x => x._id === cid || x._id == cid);
                                    if (!cl) continue;
                                    try { await adminClasses.assignProfessor(cid, newProfId); } catch (er) { /* ignore per-class errors */ }
                                }
                            }

                            modal.remove();
                            await loadProfessors();
                            await loadClasses();
                        } catch (err) {
                            alert(err.message || 'Error creando profesor');
                        }
                    });
                } catch (err) {
                    document.getElementById('newProfessorFields').innerHTML = '<i>Error cargando clases</i>';
                }
            })();
        }

        // Gestión de Configuración
        async function loadGymConfig() {
            try {
                const config = await adminGym.getConfig();
                renderGymConfig(config);
            } catch (err) {
                document.getElementById('gymConfigForm').textContent = 'Error cargando configuración';
            }
        }

        function renderGymConfig(config) {
            const form = document.createElement('form');
            form.innerHTML = `
                <div style="display:grid;grid-template-columns:1fr 1fr;gap:16px">
                    <div>
                        <div>Horas mínimas de cancelación:</div>
                        <input type="number" id="minCancellationHours" value="${config.minCancellationHours}"
                            min="1" style="width:100%;padding:8px;margin:4px 0;border:1px solid #ddd;border-radius:4px" />
                    </div>
                    <div>
                        <div>Días de vencimiento de créditos:</div>
                        <input type="number" id="creditExpirationDays" value="${config.creditExpirationDays}"
                            min="1" style="width:100%;padding:8px;margin:4px 0;border:1px solid #ddd;border-radius:4px" />
                    </div>
                    <div>
                        <div>Días extra para recuperación de clases tras vencimiento de cuota:</div>
                        <div style="font-size:13px;color:#6b7280;margin:6px 0">Permite definir cuántos días más los alumnos pueden seguir recuperando clases luego de que su cuota haya vencido. Este número se suma a la fecha de vencimiento al mostrar las clases de cada alumno.</div>
                        <input type="number" id="autoCancelDueOverdueDays" value="${config.autoCancelDueOverdueDays}"
                            min="0" style="width:100%;padding:8px;margin:4px 0;border:1px solid #ddd;border-radius:4px" />
                    </div>
                    <div>
                        <div>Máximo de créditos acumulables:</div>
                        <input type="number" id="maxCredits" value="${config.maxCredits}"
                            min="1" style="width:100%;padding:8px;margin:4px 0;border:1px solid #ddd;border-radius:4px" />
                    </div>
                </div>
                <div style="display:flex;justify-content:flex-end;margin-top:16px">
                    <button type="submit" style="background:#2b6cb0;color:#fff;padding:8px 12px;border-radius:6px">
                        Guardar cambios
                    </button>
                </div>
            `;

            form.addEventListener('submit', async (e) => {
                e.preventDefault();
                const newConfig = {
                    minCancellationHours: parseInt(document.getElementById('minCancellationHours').value),
                    creditExpirationDays: parseInt(document.getElementById('creditExpirationDays').value),
                    autoCancelDueOverdueDays: parseInt(document.getElementById('autoCancelDueOverdueDays').value),
                    maxCredits: parseInt(document.getElementById('maxCredits').value)
                };

                try {
                    await adminGym.updateConfig(newConfig);
                    alert('Configuración actualizada');
                } catch (err) {
                    alert(err.message || 'Error actualizando configuración');
                }
            });

            document.getElementById('gymConfigForm').innerHTML = '';
            document.getElementById('gymConfigForm').appendChild(form);
        }

        // Event listeners para profesores
        document.getElementById('btnNewProfessor').addEventListener('click', () => openNewProfessorModal());

        async function openEditProfessorModal(id) {
            const modal = document.createElement('div');
            modal.style = 'position:fixed;inset:0;background:rgba(0,0,0,0.35);display:flex;align-items:center;justify-content:center';
            modal.innerHTML = `
                <div id="editProfessorModalContent" style="background:#fff;padding:16px;border-radius:8px;width:420px;max-height:80vh;overflow:auto">
                    <h4>Editar Profesor</h4>
                    <div id="editProfessorFields">Cargando...</div>
                </div>
            `;
            document.body.appendChild(modal);
            try {
                const professors = await adminProfessors.listProfessors();
                const prof = professors.find(p => p._id === id || p._id == id);
                if (!prof) {
                    modal.remove();
                    return alert('Profesor no encontrado');
                }

                const classes = await adminClasses.listClasses();
                const html = `
                    <div style="margin:16px 0">
                        <div>DNI: <span class="required">*</span></div>
                        <input id="editProfessorDni" value="${esc(prof.dni || '')}" style="width:100%;padding:8px;margin:4px 0;border:1px solid #ddd;border-radius:4px" />
                        
                        <div style="margin-top:8px">Nombre: <span class="required">*</span></div>
                        <input id="editProfessorName" value="${esc(prof.name || '')}" style="width:100%;padding:8px;margin:4px 0;border:1px solid #ddd;border-radius:4px" />
                        
                        <div style="margin-top:8px">Apellido: <span class="required">*</span></div>
                        <input id="editProfessorLastName" value="${esc(prof.lastName || '')}" style="width:100%;padding:8px;margin:4px 0;border:1px solid #ddd;border-radius:4px" />
                        
                        <div style="margin-top:8px">Teléfono:</div>
                        <input id="editProfessorPhone" value="${esc(prof.phone || '')}" style="width:100%;padding:8px;margin:4px 0;border:1px solid #ddd;border-radius:4px" />
                    </div>

                    <div style="margin:8px 0">
                        <div>Clases asignadas:</div>
                        <div style="max-height:160px;overflow:auto;border:1px solid #ddd;border-radius:4px;margin-top:6px;padding:6px;background:#fff">
                            ${classes.map(c => `
                                <label style="display:block;padding:6px;border-bottom:1px solid #eee">
                                    <input type="checkbox" value="${c._id}" class="editProfessorClass" ${c.professorId === prof._id ? 'checked' : ''} />
                                    ${esc((c.days || []).join(', '))} ${esc(c.start)} - ${esc(c.roomName || '')}
                                </label>
                            `).join('')}
                        </div>
                    </div>

                    <div style="display:flex;gap:8px;justify-content:flex-end;margin-top:8px">
                        <button id="cancelEditProfessor">Cancelar</button>
                        <button id="saveEditProfessor" style="background:#2b6cb0;color:#fff">Guardar</button>
                    </div>
                `;

                document.getElementById('editProfessorFields').innerHTML = html;

                document.getElementById('cancelEditProfessor').addEventListener('click', () => modal.remove());
                document.getElementById('saveEditProfessor').addEventListener('click', async () => {
                    const updated = {
                        dni: document.getElementById('editProfessorDni').value.trim(),
                        name: document.getElementById('editProfessorName').value.trim(),
                        lastName: document.getElementById('editProfessorLastName').value.trim(),
                        phone: document.getElementById('editProfessorPhone').value.trim()
                    };
                    if (!updated.dni || !updated.name || !updated.lastName) return alert('DNI, nombre y apellido son requeridos');

                    const selectedClassIds = Array.from(document.querySelectorAll('.editProfessorClass:checked')).map(cb => cb.value);

                    try {
                        await adminProfessors.updateProfessor(id, updated);

                        // update classes: assign professorId for selected, unassign for others
                        const allClasses = await adminClasses.listClasses();
                        for (const cl of allClasses) {
                            const shouldHave = selectedClassIds.includes(String(cl._id));
                            const currentlyHas = cl.professorId === prof._id || cl.professorId == prof._id;
                            if (shouldHave && !currentlyHas) {
                                try { await adminClasses.assignProfessor(cl._id, id); } catch (er) { /* ignore per-class */ }
                            } else if (!shouldHave && currentlyHas) {
                                try { await adminClasses.assignProfessor(cl._id, null); } catch (er) { /* ignore per-class */ }
                            }
                        }

                        modal.remove();
                        await loadProfessors();
                        await loadClasses();
                    } catch (err) {
                        alert(err.message || 'Error actualizando profesor');
                    }
                });
            } catch (err) {
                modal.remove();
                alert('Error cargando datos del profesor o clases');
            }
        }

        // breakpoint re-render removed: cards are active for all sizes, no layout switch needed

        // Inicializar
        (async () => {
            await loadStudents();
            await loadProfessors();
            await loadGymConfig();
            await loadRooms();
            await loadClasses();
        })();
    </script>

</body>

</html>