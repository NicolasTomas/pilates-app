<!doctype html>
<html lang="es">

<head>
    <meta charset="utf-8" />
    <meta name="viewport" content="width=device-width, initial-scale=1" />
    <link href="https://fonts.googleapis.com/css2?family=Orbitron:wght@700&display=swap" rel="stylesheet">
    <title>Gym Control</title>
    <link rel="icon" type="image/png" sizes="64x64 128x128 192x192 512x512" href="/public/icons/app-icon.png?v=3">
    <link rel="apple-touch-icon" sizes="192x192" href="/public/icons/app-icon.png">
    <link rel="manifest" href="/public/manifest.webmanifest">
    <meta name="theme-color" content="#111827">
    <style>
        * {
            margin: 0;
            padding: 0;
            box-sizing: border-box;
        }

        /* Logo sizing based on context */
        @media (display-mode: standalone) {
            .logo {
                width: 297px;
                height: 297px;
            }
        }

        @media (display-mode: browser) {
            .logo {
                width: 371.25px;
                height: 371.25px;
            }
        }

        /* Fallback para navegador cuando display-mode no es soportado */
        .logo {
            width: 371.25px;
            height: 371.25px;
            background-image: url('/public/icons/app-icon.png');
            background-size: contain;
            background-repeat: no-repeat;
            background-position: center;
            margin: 0 auto 20px;
        }

        html,
        body {
            height: 100%;
            overflow: hidden;
        }

        body {
            font-family: 'Inter', -apple-system, BlinkMacSystemFont, 'Segoe UI', Arial, sans-serif;
            display: flex;
            min-height: 100vh;
            align-items: center;
            justify-content: center;
            background-color: #d9d9d9;
            position: relative;
            flex-direction: column;
        }

        body::before {
            content: '';
            position: absolute;
            /* Centrar la capa decorativa en el medio de la pantalla */
            top: 50%;
            left: 50%;
            width: 240%;
            height: 240%;
            /* Mantener el elemento centrado y rotarlo sin perder el translate */
            transform: translate(-50%, -50%) rotate(0deg);
            /* Halo más notorio: mayor opacidad y más spread. Se usan dos radiales para profundidad */
            background:
                radial-gradient(circle at center, rgba(255, 255, 255, 0.42) 0%, rgba(255, 255, 255, 0.12) 30%, transparent 60%),
                radial-gradient(circle at center, rgba(255, 245, 255, 0.12) 0%, transparent 75%);
            /* Más blur para suavizar el halo grande */
            filter: blur(36px);
            /* screen ayuda a iluminar el fondo; si se quiere más contraste, cambiar a normal */
            mix-blend-mode: screen;
            animation: rotate 30s linear infinite;
            pointer-events: none;
            z-index: 0;
            opacity: 0.95;
        }

        @keyframes rotate {

            /* preserve the translate so the halo stays centered while rotating */
            from {
                transform: translate(-50%, -50%) rotate(0deg);
            }

            to {
                transform: translate(-50%, -50%) rotate(360deg);
            }
        }


        .card {
            --card-edge-gap: 2px;
            /* space between card edge and title/button */
            background: rgba(255, 255, 255, 0.95);
            backdrop-filter: blur(10px);
            padding: 40px 32px;
            border-radius: 25px;
            box-shadow: 0 20px 60px rgba(0, 0, 0, 0.4);
            width: 350px;
            height: auto !important;
            position: relative;
            z-index: 1;
            /* ensure the card never forces the page to scroll vertically */
            max-height: calc(100vh - 48px);
            overflow: hidden;
            display: flex;
            flex-direction: column;
            justify-content: center;
            margin-bottom: 2rem;

        }

        /* (responsive admin button kept as floating .admin-btn-container) */

        .card h2 {
            color: #000000;
            font-size: 25px !important;
            font-weight: 700;

            text-align: center;
            font-family: 'Orbitron', sans-serif;
        }

        /* Center the hint/description text under the title */
        .card p {
            text-align: center;
            color: #334155;
            margin-bottom: 8px;
            font-size: 14px;
        }

        input {
            width: 100%;
            padding: 14px 16px;
            margin: 12px 0;
            border: 2px solid #e2e8f0;
            border-radius: 12px;
            font-size: 15px;
            background: #f8fafc;
            transition: all 0.3s ease;
        }

        input:focus {
            outline: none;
            border-color: #667eea;
            background: #fff;
            box-shadow: 0 0 0 3px rgba(102, 126, 234, 0.1);
        }

        button {
            width: 100%;
            padding: 14px;
            background: linear-gradient(135deg, #0c0c0c 0%, #303030 100%);
            color: #fff;
            border: none;
            border-radius: 12px;
            font-size: 16px;
            font-weight: 600;
            cursor: pointer;
            transition: all 0.3s ease;
            box-shadow: 0 4px 15px rgba(102, 126, 234, 0.4);
        }

        button:hover {
            transform: translateY(-2px);
            box-shadow: 0 6px 20px rgba(0, 0, 0, 0.6);
        }

        button:active {
            transform: translateY(0);
        }

        .hint {
            font-size: 12px;
            color: #64748b;
            margin-top: 16px;
            padding: 16px;
            background: #f1f5f9;
            border-radius: 12px;
            line-height: 1.6;
        }

        .admin-btn-container {
            position: fixed;
            top: 20px;
            right: 20px;
            z-index: 100000;
            pointer-events: auto;
            display: flex;
            align-items: center;
            justify-content: center;
        }

        /* hide floating admin button globally — use in-card button inside the card for all viewports */
        .admin-btn-container {
            display: none !important;
        }

        /* In-card admin button (shown inside the card on all viewports) */
        .admin-in-card {
            display: none;
            /* hide the floating in-card admin button — we provide an inline button under login */
        }

        .admin-in-card button {
            padding: 0 10px 0 10px !important;
            border-radius: 18px;
            background: rgba(255, 255, 255, 0.9);
            color: #111827;
            border: 1px solid rgba(0, 0, 0, 0.06);
            box-shadow: 0 6px 18px rgba(0, 0, 0, 0.12);
            min-height: 40px;
        }

        /* Ensure the main login button has consistent vertical spacing across viewports.
           Use inline-flex + min-height so text is vertically centered and padding applies
           symmetrically (top/bottom). Adjust min-height to increase touch target if needed. */
        #btnLogin {
            box-sizing: border-box;
            padding-top: 14px;
            padding-bottom: 14px;
            padding-left: 16px;
            padding-right: 16px;
            line-height: 1;
            /* prevent extra line-height gaps */
            display: inline-flex;
            align-items: center;
            justify-content: center;
            min-height: 48px;
            /* consistent height across devices */
            width: 100%;

        }

        /* New admin inline button: same sizing as #btnLogin but gray variant */
        #btnAdminInline {
            box-sizing: border-box;
            padding-top: 14px;
            padding-bottom: 14px;
            padding-left: 16px;
            padding-right: 16px;
            line-height: 1;
            display: inline-flex;
            align-items: center;
            justify-content: center;
            min-height: 48px;
            width: 100%;
            margin-top: 12px;
            background: linear-gradient(135deg, #e6e6e6 0%, #cfcfcf 100%);
            color: #0f172a;
            border: none;
            border-radius: 12px;
            font-size: 16px;
            font-weight: 600;
            cursor: pointer;
            transition: all 0.22s ease;
            box-shadow: 0 4px 12px rgba(0, 0, 0, 0.08);
        }

        #btnAdminInline:hover {
            transform: translateY(-2px);
            box-shadow: 0 8px 22px rgba(0, 0, 0, 0.12);
        }

        .admin-btn-container button {
            width: auto;
            padding: 10px 20px;
            border-radius: 20px;
            /* Restored translucent pill used before so desktop keeps the original look */
            background: rgba(255, 255, 255, 0.18);
            backdrop-filter: blur(10px);
            color: #fff;
            font-size: 14px;
            box-shadow: 0 4px 15px rgba(0, 0, 0, 0.2);
            border: 1px solid rgba(255, 255, 255, 0.06);
            min-width: 56px;
            min-height: 40px;
            opacity: 0.98;
        }

        .admin-btn-container button:hover {
            background: rgba(255, 255, 255, 0.3);
        }

        /* Mobile Responsive */
        @media (max-width: 768px) {
            body {
                padding: 16px;
            }

            .card {
                --card-edge-gap: 19px;
                /* larger top/bottom gap on mobile */
            }

            .card h2 {
                font-size: 30px !important;
                font-family: 'Orbitron', sans-serif;
            }

            #mpCheckoutLink {

                font-family: 'Orbitron', sans-serif;
                border-radius: 16px;


                background: linear-gradient(to right, #00A3EE, #00C8FF);
                border: none;
            }

            .card p {
                font-size: 13px;
            }

            input {
                padding: 12px 14px;
                font-size: 14px;
            }

            button {
                padding: 12px;
                font-size: 15px;
            }

            .hint {
                font-size: 11px;
                padding: 12px;
            }

            .admin-btn-container {
                /* move to bottom center on mobile */
                top: auto;
                right: auto;
                left: 50%;
                bottom: 16px;
                transform: translateX(-50%);
                width: auto;
                max-width: calc(100% - 32px);
                padding: 0 8px;
            }

            /* hide floating button on mobile (we'll hide it globally below) */
            .admin-btn-container {
                display: none;
            }

            .admin-btn-container button {
                padding: 10px 20px;
                font-size: 14px;
                /* On mobile we force a high-contrast white pill so it remains clearly visible */
                background: rgba(255, 255, 255, 0.98) !important;
                color: #111827 !important;
                box-shadow: 0 8px 30px rgba(0, 0, 0, 0.25);
                border-radius: 999px !important;
                border: 1px solid rgba(0, 0, 0, 0.06);
                min-width: 140px;
                max-width: 100%;
                min-height: 44px;
                opacity: 1 !important;
                /* Prevent touch-drag/pan when interacting with the button */
                touch-action: none !important;
                -webkit-user-drag: none !important;
                -webkit-tap-highlight-color: rgba(0, 0, 0, 0);
            }
        }

        @media (max-width: 480px) {
            .card {
                padding: 24px 20px;
            }

            .card h2 {
                font-size: 22px;
                font-family: 'Orbitron', sans-serif !important;
            }
        }

        /* small animation for mobile entrance */
        .admin-btn-container.show {
            animation: slideUp 360ms cubic-bezier(.2, .9, .2, 1) both;
        }

        @keyframes slideUp {
            from {
                transform: translateX(-50%) translateY(18px);
                opacity: 0;
            }

            to {
                transform: translateX(-50%) translateY(0);
                opacity: 1;
            }
        }

        #toggleRegPass,
        #toggleRegConfirm {
            box-shadow: none !important;
        }

        .division {
            width: 100%;
            border-bottom: 1px solid #00000076;
            margin-top: 1rem;
            margin-bottom: 1rem;
        }

        .install-cta {
            position: fixed;
            bottom: 0;
            left: 0;
            right: 0;
            display: none;
            padding: 16px;
    background: linear-gradient(135deg, #000000f0 0%, #141414ed 100%);
            box-shadow: 0 -4px 20px rgba(0, 0, 0, 0.3);
            z-index: 1000;
        }

        .install-cta button {
            width: 100%;
            max-width: 400px;
            margin: 0 auto;
            display: flex;
            align-items: center;
            justify-content: center;
            gap: 12px;
            padding: 0.5rem;
            border-radius: 12px;
            border: none;
            font-weight: 600;
            font-size: 15px;
            color: #fff;
            background: rgba(255, 255, 255, 0.12);
            backdrop-filter: blur(10px);
            border: 1px solid rgba(255, 255, 255, 0.2);
            cursor: pointer;
            transition: all 300ms ease;
        }

        .install-cta button:hover {
            background: rgba(255, 255, 255, 0.18);
            border-color: rgba(255, 255, 255, 0.3);
            transform: translateY(-2px);
        }

        .install-cta button:active {
            transform: translateY(0);
        }

        .install-cta .logo-icon {
            width: 40px;
            height: 40px;
            background-image: url('/public/icons/app-icon.png');
            background-size: 156%;
            background-repeat: no-repeat;
            background-position: center;
            flex-shrink: 0;
            border-radius: 50%;
        }

        .install-cta .text-content {
            display: flex;
            align-items: center;
            gap: 8px;
            flex: 1;
        }

        .install-cta .download-arrow {
            width: 20px;
            height: 20px;
            flex-shrink: 0;
        }

        .login-inline-alert {
            display: none;
            margin-top: 4px;
            display: block;
            color: #b91c1c;
            font-weight: 700;
            font-size: 14px;
        }

        /* Input error styling when we show the message inside the field */
        input.input-error {
            border-color: #dc2626;
            color: #b91c1c;
        }

        input.input-error::placeholder {
            color: #dc2626;
            font-weight: 700;
        }

    #toggleAdminPass {
            box-shadow: none !important;
        }
    </style>
</head>

<body>

    <div class="install-cta">
        <button id="btnAddToHome" type="button">
            <div class="logo-icon"></div>
            <div class="text-content">
                <span>Instalar aplicación</span>
                <svg class="download-arrow" viewBox="0 0 24 24" fill="none" xmlns="http://www.w3.org/2000/svg">
                    <path d="M12 3v12m0 0l-4-4m4 4l4-4m0 0H5a2 2 0 00-2 2v6a2 2 0 002 2h14a2 2 0 002-2v-6a2 2 0 00-2-2h-8" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round"/>
                </svg>
            </div>
        </button>
    </div>

    <div class="card card-surface">
        <h2>Iniciar sesión</h2>
        <p>Ingresá tu DNI para acceder</p>
        <input id="dni" placeholder="DNI" maxlength="15" />
        <div id="dniAlert" class="login-inline-alert" role="alert"></div>
        <button id="btnLogin">Ingresar</button>
        <div class="division">

        </div>
        <button id="btnAdminInline"
            style="display:none;margin-top:0px;background:#e2e8f0;color:#475569;box-shadow:none;border:none;padding:10px;border-radius:10px">Ingreso
            Administradores</button>
        <p style="text-align:center;margin:10px 0 0 0;color:#475569;font-size:13px">
            ¿No tienes una cuenta?
            <a id="btnCreateAccount" href="#" role="button"
                style="color:#2563eb;text-decoration:underline;margin-left:3px;font-weight:600;cursor:pointer">Regístrate</a>
        </p>
        <!-- <div class="hint">
            Usuarios de prueba:<br>
            • Alumno por DNI: 10000001<br>
            • Profesor por DNI: 20000002<br>
            • Superusuario por DNI: 40000004<br>
            • Admin: usar botón "admin" arriba a la derecha (email: admin@pilates.local / pass: AdminPass123!)
        </div> -->
        <div class="admin-in-card">
            <button id="btnAdminCard">Admin</button>
        </div>
    </div>

    <div class="admin-btn-container">
        <button id="btnAdmin">Admin</button>
    </div>
    </div>

    <script>
        // Add-to-home-screen (mobile shortcut)
        (function () {
            let deferredPrompt = null;
            const cta = document.querySelector('.install-cta');
            const btnA2hs = document.getElementById('btnAddToHome');

            const updateCtaVisibility = () => {
                // Always visible across contexts per user request
                if (cta) cta.style.display = 'block';
            };
            updateCtaVisibility();

            // Periodically verify context to ensure CTA stays visible in web after uninstall/reopen
            let visInterval = null;
            const startVisibilityWatch = () => {
                if (visInterval) return;
                visInterval = setInterval(updateCtaVisibility, 2000);
            };
            const stopVisibilityWatch = () => {
                if (visInterval) { clearInterval(visInterval); visInterval = null; }
            };
            startVisibilityWatch();

            // Enable install flow when the browser allows it
            window.addEventListener('beforeinstallprompt', (e) => {
                e.preventDefault();
                deferredPrompt = e;
            });

            // Keep CTA present on web; provide fallback guidance when install isn't available
            if (btnA2hs) {
                btnA2hs.addEventListener('click', async () => {
                    if (!deferredPrompt) {
                        // No guidance message; silently do nothing if install isn't available yet
                        return;
                    }
                    deferredPrompt.prompt();
                    try {
                        await deferredPrompt.userChoice;
                    } catch (err) {
                        /* ignore */
                    }
                    // Reset prompt; CTA remains visible on web for future sessions
                    deferredPrompt = null;
                });
            }

            // Keep CTA visible on any visibility change
            document.addEventListener('visibilitychange', updateCtaVisibility);
            window.addEventListener('pagehide', stopVisibilityWatch);
            window.addEventListener('beforeunload', stopVisibilityWatch);
        })();

        // Ensure admin button is positioned correctly on mobile and prevent page pan while interacting
        (function () {
            const btn = document.getElementById('btnAdmin');
            const container = document.querySelector('.admin-btn-container');
            if (!btn || !container) return;

            function adjustAdminPosition() {
                if (window.innerWidth <= 768) {
                    container.style.left = '50%';
                    container.style.right = 'auto';
                    container.style.bottom = '16px';
                    container.style.top = 'auto';
                    container.style.transform = 'translateX(-50%)';
                    container.style.zIndex = '2147483647';
                    container.classList.add('show');
                } else {
                    container.style.left = '';
                    container.style.right = '20px';
                    container.style.bottom = '';
                    container.style.top = '20px';
                    container.style.transform = '';
                    container.style.zIndex = '';
                    container.classList.remove('show');
                }
            }

            // Prevent touchmove (page pan) when the user is interacting with the admin button
            let touchActive = false;
            btn.addEventListener('touchstart', (e) => { touchActive = true; });
            btn.addEventListener('touchmove', (e) => { if (touchActive) e.preventDefault(); }, { passive: false });
            btn.addEventListener('touchend', (e) => { touchActive = false; });

            // Ensure desktop click still works
            btn.addEventListener('click', (e) => { openAdminModal(); });

            // mobile in-card button (fallback inside the card)
            const btnCard = document.getElementById('btnAdminCard');
            if (btnCard) {
                // call openAdminModal at click time (it is defined later in the file)
                btnCard.addEventListener('click', (e) => { openAdminModal(); });
                btnCard.addEventListener('touchstart', (e) => { e.stopPropagation(); });
                btnCard.addEventListener('touchmove', (e) => { e.preventDefault(); }, { passive: false });
            }

            window.addEventListener('resize', adjustAdminPosition);
            // run once
            adjustAdminPosition();
        })();
    </script>
    <script src="/public/js/auth.js"></script>
    <script>
        const btn = document.getElementById('btnLogin');
        const dniInput = document.getElementById('dni');
        const dniAlert = document.getElementById('dniAlert');
        const defaultPlaceholder = dniInput.placeholder || 'DNI';

        const showDniError = (msg) => {
            if (dniAlert) {
                dniAlert.textContent = '';
                dniAlert.style.display = 'none';
            }
            dniInput.value = '';
            dniInput.placeholder = msg;
            dniInput.classList.add('input-error');
            dniInput.focus();
        };

        const clearDniError = () => {
            if (dniAlert) {
                dniAlert.textContent = '';
                dniAlert.style.display = 'none';
            }
            dniInput.placeholder = defaultPlaceholder;
            dniInput.classList.remove('input-error');
        };

        btn.addEventListener('click', async () => {
            const dni = dniInput.value.trim();
            if (!dni) {
                showDniError('Ingresá un DNI para continuar');
                return;
            }
            clearDniError();
            try {
                const res = await pilatesAuth.loginDni(dni);
                // redirigir según rol
                if (res.role === 'alumno') window.location.href = '/alumno.html';
                else if (res.role === 'profesor') window.location.href = '/profesor.html';
                else if (res.role === 'administrador') window.location.href = '/administrador.html';
                else if (res.role === 'superusuario') window.location.href = '/superusuario.html';
                else window.location.href = '/index.html';
            } catch (err) {
                showDniError(err.message || 'No pudimos iniciar sesión con ese DNI');
            }
        });

        // admin modal
        const btnAdmin = document.getElementById('btnAdmin');
        btnAdmin.addEventListener('click', () => {
            openAdminModal();
        });

        // inline admin button under the login form
        const btnAdminInline = document.getElementById('btnAdminInline');
        if (btnAdminInline) {
            // make it visible (was added with inline style hidden) and wire to open modal
            btnAdminInline.style.display = 'inline-flex';
            btnAdminInline.addEventListener('click', () => { openAdminModal(); });
            // ensure touch interactions don't pan the page
            btnAdminInline.addEventListener('touchstart', (e) => { e.stopPropagation(); });
            btnAdminInline.addEventListener('touchmove', (e) => { e.preventDefault(); }, { passive: false });
        }

        function openAdminModal() {
            const modal = document.createElement('div');
            modal.style = 'position:fixed;inset:0;background:rgba(0,0,0,0.5);backdrop-filter:blur(5px);display:flex;align-items:center;justify-content:center;z-index:1000';
            modal.innerHTML = `
                    <div style="background:#fff;padding:24px;border-radius:16px;width:380px;box-shadow:0 20px 60px rgba(0,0,0,0.3)">
                        <h3 style="color:#000000;font-size:22px;margin-bottom:12px;text-align:center">Ingreso Administradores</h3>
                        <div style="margin:8px 0 4px 0">
                            <input id="adminEmail" placeholder="Email" style="width:100%;padding:12px 14px;border:2px solid #e2e8f0;border-radius:10px;font-size:14px;background:#f8fafc" />
                            <small id="adminEmailError" style="display:none;color:#b91c1c;font-weight:700;font-size:13px;margin-top:4px;line-height:1.3"></small>
                        </div>
                        <div style="position:relative;margin:8px 0 4px 0;">
                            <input id="adminPass" type="password" placeholder="Contraseña" style="width:100%;padding:12px 44px 12px 14px;border:2px solid #e2e8f0;border-radius:10px;font-size:14px;background:#f8fafc" />
                            <button id="toggleAdminPass" type="button" aria-label="Mostrar contraseña" style="position:absolute;right:12px;top:50%;transform:translateY(-50%);background:transparent;border:none;width:20px;height:20px;padding:0;cursor:pointer;display:inline-flex;align-items:center;justify-content:center;line-height:0"> 
                                <svg width="20" height="20" viewBox="0 0 24 24" fill="none" xmlns="http://www.w3.org/2000/svg"><path d="M1 12s4-7 11-7 11 7 11 7-4 7-11 7S1 12 1 12z" stroke="#374151" stroke-width="1.5" stroke-linecap="round" stroke-linejoin="round"/><circle cx="12" cy="12" r="3" stroke="#374151" stroke-width="1.5" stroke-linecap="round" stroke-linejoin="round"/></svg>
                            </button>
                            <small id="adminPassError" style="display:none;color:#b91c1c;font-weight:700;font-size:13px;margin-top:4px;line-height:1.3;position:absolute;left:0;top:100%;transform:translateY(4px);"></small>
                        </div>
                        <div style="display:flex;gap:10px;margin-top:14px">
                            <button id="cancelAdmin" style="flex:1;padding:10px;border-radius:10px;background:#e2e8f0;color:#475569;box-shadow:none">Cancelar</button>
                            <button id="submitAdmin" style="flex:1;padding:10px;border-radius:10px;background-color:#000000;color:#fff;box-shadow:0 4px 12px rgba(0,0,0,0.12)">Entrar</button>
                        </div>
                        <div style="text-align:center;margin-top:10px">
                            <a id="adminForgotLink" href="#" style="color:#6b7280;font-size:13px;text-decoration:underline;cursor:pointer">¿Olvidaste tu contraseña?</a>
                        </div>
                        
                    </div>`;

            document.body.appendChild(modal);

            // Toggle password visibility
            const adminPassInput = document.getElementById('adminPass');
            const adminPassToggle = document.getElementById('toggleAdminPass');
            const adminEmailInput = document.getElementById('adminEmail');
            const adminEmailError = document.getElementById('adminEmailError');
            const adminPassError = document.getElementById('adminPassError');
            const defaultAdminEmailPh = adminEmailInput.placeholder || 'Email';
            const defaultAdminPassPh = adminPassInput.placeholder || 'Contraseña';
            const eyeSvg = '<svg width="20" height="20" viewBox="0 0 24 24" fill="none" xmlns="http://www.w3.org/2000/svg"><path d="M1 12s4-7 11-7 11 7 11 7-4 7-11 7S1 12 1 12z" stroke="#374151" stroke-width="1.5" stroke-linecap="round" stroke-linejoin="round"/><circle cx="12" cy="12" r="3" stroke="#374151" stroke-width="1.5" stroke-linecap="round" stroke-linejoin="round"/></svg>';
            const eyeOffSvg = '<svg width="20" height="20" viewBox="0 0 24 24" fill="none" xmlns="http://www.w3.org/2000/svg"><path d="M17.94 17.94A10.94 10.94 0 0 1 12 19c-7 0-11-7-11-7 .95-1.63 2.28-3.21 3.84-4.5M9.88 9.88A3 3 0 0 0 14.12 14.12M1 1l22 22" stroke="#374151" stroke-width="1.5" stroke-linecap="round" stroke-linejoin="round"/></svg>';
            
            if (adminPassToggle) {
                adminPassToggle.addEventListener('click', () => {
                    if (adminPassInput.type === 'password') {
                        adminPassInput.type = 'text';
                        adminPassToggle.setAttribute('aria-label', 'Ocultar contraseña');
                        adminPassToggle.innerHTML = eyeOffSvg;
                    } else {
                        adminPassInput.type = 'password';
                        adminPassToggle.setAttribute('aria-label', 'Mostrar contraseña');
                        adminPassToggle.innerHTML = eyeSvg;
                    }
                });
            }

            // cleanup helper
            function removeModal() { try { modal.remove(); } catch (e) { } }

            const showFieldError = (inputEl, placeholderMsg, helperEl) => {
                if (helperEl) {
                    helperEl.textContent = '';
                    helperEl.style.display = 'none';
                }
                if (!inputEl) return;
                inputEl.value = '';
                inputEl.placeholder = placeholderMsg;
                inputEl.classList.add('input-error');
            };

            const clearFieldError = (inputEl, defaultPh, helperEl) => {
                if (helperEl) {
                    helperEl.textContent = '';
                    helperEl.style.display = 'none';
                }
                if (!inputEl) return;
                inputEl.placeholder = defaultPh;
                inputEl.classList.remove('input-error');
            };

            document.getElementById('cancelAdmin').addEventListener('click', () => removeModal());
            document.getElementById('submitAdmin').addEventListener('click', async () => {
                const email = adminEmailInput.value.trim();
                const pass = adminPassInput.value;

                clearFieldError(adminEmailInput, defaultAdminEmailPh, adminEmailError);
                clearFieldError(adminPassInput, defaultAdminPassPh, adminPassError);

                let hasError = false;
                if (!email) {
                    showFieldError(adminEmailInput, 'Ingresá tu email', adminEmailError);
                    hasError = true;
                }
                if (!pass) {
                    showFieldError(adminPassInput, 'Ingresá tu contraseña', adminPassError);
                    hasError = true;
                }
                if (hasError) {
                    if (!email) adminEmailInput.focus(); else adminPassInput.focus();
                    return;
                }

                try {
                    const res = await pilatesAuth.adminLogin(email, pass);
                    if (res.role === 'administrador' || res.role === 'superusuario') {
                        window.location.href = '/administrador.html';
                    } else {
                        showFieldError(adminPassInput, 'Mail o contraseña incorrectas', adminPassError);
                    }
                } catch (err) {
                    const msg = err.message || 'Mail o contraseña incorrectas';
                    showFieldError(adminPassInput, msg, adminPassError);
                }
            });

            // forgot password handler: open small modal to request reset email
            const forgotLink = document.getElementById('adminForgotLink');
            if (forgotLink) {
                forgotLink.addEventListener('click', (ev) => {
                    ev.preventDefault();
                    const fm = document.createElement('div');
                    fm.style = 'position:fixed;inset:0;background:rgba(0,0,0,0.5);display:flex;align-items:center;justify-content:center;z-index:1100';
                    fm.innerHTML = `
                        <div style="background:#fff;padding:18px;border-radius:12px;width:360px;box-shadow:0 20px 60px rgba(0,0,0,0.25)">
                            <h4 style="margin:0 0 10px 0;text-align:center">Recuperar contraseña</h4>
                            <div style="font-size:13px;color:#374151;margin-bottom:8px;text-align:center">Te enviaremos un email con instrucciones para restablecer la contraseña.</div>
                            <input id="forgotEmail" placeholder="Email" style="width:100%;padding:10px 12px;margin:8px 0;border:1px solid #e6edf3;border-radius:8px" />
                            <div style="display:flex;gap:8px;margin-top:8px">
                                <button id="cancelForgot" type="button" style="flex:1;padding:10px;border-radius:8px;border:none;background:#e2e8f0;color:#0f172a">Cancelar</button>
                                <button id="sendForgot" type="button" style="flex:1;padding:12px;border-radius:12px;border:none;background:linear-gradient(135deg,#0c0c0c 0%,#303030 100%);color:#fff;font-size:16px;font-weight:600;box-shadow:0 4px 15px rgba(102,126,234,0.4)">Enviar email</button>
                            </div>
                        </div>`;
                    document.body.appendChild(fm);

                    const removeForgot = () => { try { fm.remove(); } catch (e) { } };
                    fm.querySelector('#cancelForgot').addEventListener('click', removeForgot);
                    const input = fm.querySelector('#forgotEmail');
                    input && input.focus();
                    input && input.addEventListener('keydown', (e) => { if (e.key === 'Enter') fm.querySelector('#sendForgot').click(); });

                    fm.querySelector('#sendForgot').addEventListener('click', async () => {
                        const email = (fm.querySelector('#forgotEmail').value || '').trim();
                        if (!email) return alert('Ingresá un email válido');
                        try {
                            const r = await fetch('/api/password-reset/request', { method: 'POST', headers: { 'Content-Type': 'application/json' }, body: JSON.stringify({ email }) });
                            const body = await r.json().catch(() => ({}));
                            if (!r.ok) {
                                alert(body && body.error ? body.error : 'Error enviando email');
                                return;
                            }
                            alert('Si existe una cuenta con ese email, recibirás instrucciones para restablecer la contraseña');
                            removeForgot();
                        } catch (e) {
                            console.error('Error requesting password reset', e);
                            alert('Error de red al enviar solicitud');
                        }
                    });
                });
            }


        }
    </script>
    <script>
        // Crear cuenta -> abrir modal de registro con validación de contraseñas
        (function () {
            const btnCreate = document.getElementById('btnCreateAccount');
            if (!btnCreate) return;

            // small inline toast helper (no global CSS changes)
            function showToast(message, kind = 'info') {
                const t = document.createElement('div');
                t.textContent = message;
                t.style.position = 'fixed';
                t.style.top = '18px';
                t.style.left = '50%';
                t.style.transform = 'translateX(-50%)';
                t.style.padding = '10px 14px';
                t.style.borderRadius = '10px';
                t.style.color = '#fff';
                t.style.zIndex = 2001;
                t.style.boxShadow = '0 8px 30px rgba(0,0,0,0.25)';
                t.style.fontSize = '14px';
                t.style.opacity = '0';
                t.style.transition = 'opacity 200ms, transform 200ms';
                if (kind === 'error') {
                    t.style.background = '#dc2626';
                } else {
                    t.style.background = '#16a34a';
                }
                document.body.appendChild(t);
                requestAnimationFrame(() => { t.style.opacity = '1'; t.style.transform = 'translateX(-50%) translateY(0)'; });
                setTimeout(() => { t.style.opacity = '0'; t.style.transform = 'translateX(-50%) translateY(-6px)'; setTimeout(() => t.remove(), 220); }, 3000);
            }

            btnCreate.addEventListener('click', (e) => {
                e.preventDefault();
                const modal = document.createElement('div');
                modal.style.position = 'fixed';
                modal.style.inset = '0';
                modal.style.background = 'rgba(0,0,0,0.5)';
                modal.style.display = 'flex';
                modal.style.alignItems = 'center';
                modal.style.justifyContent = 'center';
                modal.style.zIndex = 1000;

                const dialog = document.createElement('div');
                dialog.setAttribute('role', 'dialog');
                dialog.setAttribute('aria-modal', 'true');
                dialog.style.background = '#fff';
                dialog.style.padding = '20px';
                dialog.style.borderRadius = '12px';
                dialog.style.width = '420px';
                dialog.style.maxWidth = '92%';
                dialog.style.boxShadow = '0 20px 60px rgba(0,0,0,0.3)';

                dialog.innerHTML = `
                    <h3 style="margin:0 0 10px 0;text-align:center;font-size:20px;color:#000; font-family: 'Orbitron', sans-serif;">Crear cuenta</h3>
                                        <form id="regForm" style="display:flex;flex-direction:column;gap:8px">
                                            <input id="regGym" placeholder="Nombre del gimnasio" required />
                                            <input id="regPhone" placeholder="Teléfono" type="tel" />
                                            <input id="regEmail" placeholder="Gmail" type="email" required />
                                            <div style="position:relative;background:transparent;">
                                                <input id="regPass" placeholder="Contraseña" type="password" required style="padding-right:44px" />
                                                <button id="toggleRegPass" type="button" aria-label="Mostrar contraseña" style="position:absolute;right:8px;top:50%;transform:translateY(-50%);background:transparent;border:none;width:20px;height:20px;padding:0;cursor:pointer;display:inline-flex;align-items:center;justify-content:center;line-height:0"> 
                                                    <svg width="20" height="20" viewBox="0 0 24 24" fill="none" xmlns="http://www.w3.org/2000/svg"><path d="M1 12s4-7 11-7 11 7 11 7-4 7-11 7S1 12 1 12z" stroke="#374151" stroke-width="1.5" stroke-linecap="round" stroke-linejoin="round"/><circle cx="12" cy="12" r="3" stroke="#374151" stroke-width="1.5" stroke-linecap="round" stroke-linejoin="round"/></svg>
                                                </button>
                                            </div>
                                            <div style="position:relative;background:transparent;">
                                                <input id="regConfirm" placeholder="Confirmar contraseña" type="password" required style="padding-right:44px" />
                                                <button id="toggleRegConfirm" type="button" aria-label="Mostrar contraseña" style="position:absolute;right:8px;top:50%;transform:translateY(-50%);background:transparent;border:none;width:20px;height:20px;padding:0;cursor:pointer;display:inline-flex;align-items:center;justify-content:center;line-height:0"> 
                                                    <svg width="20" height="20" viewBox="0 0 24 24" fill="none" xmlns="http://www.w3.org/2000/svg"><path d="M1 12s4-7 11-7 11 7 11 7-4 7-11 7S1 12 1 12z" stroke="#374151" stroke-width="1.5" stroke-linecap="round" stroke-linejoin="round"/><circle cx="12" cy="12" r="3" stroke="#374151" stroke-width="1.5" stroke-linecap="round" stroke-linejoin="round"/></svg>
                                                </button>
                                            </div>
                                            
                                            <div style="display:flex;gap:8px;margin-top:8px">
                                                <button type="button" id="regCancel" style="flex:1;padding:10px;border-radius:8px;border:none;background:#e2e8f0;color:#0f172a">Cancelar</button>
                                                <button type="submit" style="flex:1;padding:10px;border-radius:8px;border:none;background:linear-gradient(135deg,#0c0c0c 0%,#303030 100%);color:#fff">Siguiente</button>
                                            </div>
                                        </form>`;

                modal.appendChild(dialog);
                document.body.appendChild(modal);

                // Toggle password visibility buttons
                const passInput = dialog.querySelector('#regPass');
                const passToggle = dialog.querySelector('#toggleRegPass');
                const confInput = dialog.querySelector('#regConfirm');
                const confToggle = dialog.querySelector('#toggleRegConfirm');

                const eyeSvg = '<svg width="20" height="20" viewBox="0 0 24 24" fill="none" xmlns="http://www.w3.org/2000/svg"><path d="M1 12s4-7 11-7 11 7 11 7-4 7-11 7S1 12 1 12z" stroke="#374151" stroke-width="1.5" stroke-linecap="round" stroke-linejoin="round"/><circle cx="12" cy="12" r="3" stroke="#374151" stroke-width="1.5" stroke-linecap="round" stroke-linejoin="round"/></svg>';
                const eyeOffSvg = '<svg width="20" height="20" viewBox="0 0 24 24" fill="none" xmlns="http://www.w3.org/2000/svg"><path d="M17.94 17.94A10.94 10.94 0 0 1 12 19c-7 0-11-7-11-7 .95-1.63 2.28-3.21 3.84-4.5M9.88 9.88A3 3 0 0 0 14.12 14.12M1 1l22 22" stroke="#374151" stroke-width="1.5" stroke-linecap="round" stroke-linejoin="round"/></svg>';

                function wireToggle(input, btn) {
                    if (!input || !btn) return;
                    btn.addEventListener('click', () => {
                        if (input.type === 'password') {
                            input.type = 'text';
                            btn.setAttribute('aria-label', 'Ocultar contraseña');
                            btn.innerHTML = eyeOffSvg;
                        } else {
                            input.type = 'password';
                            btn.setAttribute('aria-label', 'Mostrar contraseña');
                            btn.innerHTML = eyeSvg;
                        }
                    });
                }

                // initialize icons
                if (passToggle) passToggle.innerHTML = eyeSvg;
                if (confToggle) confToggle.innerHTML = eyeSvg;
                wireToggle(passInput, passToggle);
                wireToggle(confInput, confToggle);

                // focus
                const first = dialog.querySelector('#regGym');
                if (first) first.focus();

                // close helpers
                function closeModal() { if (modal && modal.parentNode) modal.parentNode.removeChild(modal); }

                dialog.querySelector('#regCancel').addEventListener('click', closeModal);

                // escape to close
                function onKey(e) { if (e.key === 'Escape') closeModal(); }
                document.addEventListener('keydown', onKey);

                dialog.querySelector('#regForm').addEventListener('submit', async (ev) => {
                    ev.preventDefault();
                    const gymName = dialog.querySelector('#regGym').value.trim();
                    const phone = dialog.querySelector('#regPhone').value.trim();
                    const email = dialog.querySelector('#regEmail').value.trim();
                    const pass = dialog.querySelector('#regPass').value;
                    const conf = dialog.querySelector('#regConfirm').value;
                    const confInput = dialog.querySelector('#regConfirm');

                    if (pass !== conf) {
                        // Show error inside the confirm password input
                        confInput.value = '';
                        confInput.placeholder = 'Las contraseñas no coinciden';
                        confInput.classList.add('input-error');
                        confInput.focus();
                        return;
                    }

                    // Clear error if it was there
                    confInput.classList.remove('input-error');
                    confInput.placeholder = 'Confirmar contraseña';

                    // Open payment modal where user will click to go to Mercado Pago subscription plan
                    try {
                        const paymentModal = document.createElement('div');
                        paymentModal.style = 'position:fixed;inset:0;background:rgba(0,0,0,0.5);display:flex;align-items:center;justify-content:center;z-index:1100';
                        const mpPlanLink = 'https://www.mercadopago.com.ar/subscriptions/checkout?preapproval_plan_id=1531b5a4151a4a76a099fc119a97abec';

                        // Build modal DOM safely (avoid template literals with backticks)
                        const modalInner = document.createElement('div');
                        modalInner.style.cssText = 'background:#fff;padding:18px;border-radius:12px;width:420px;box-shadow:0 20px 60px rgba(0,0,0,0.25)';

                        const h4 = document.createElement('h4');
                        h4.style.margin = '0 0 10px 0';
                        h4.style.textAlign = 'center';
                        h4.textContent = 'Pago de suscripción';
                        h4.className = 'modal-title';
                        modalInner.appendChild(h4);

                        const desc = document.createElement('div');
                        desc.style.cssText = 'font-size:13px;color:#374151;margin-bottom:12px;text-align:center';
                        desc.textContent = 'Para completar el registro, realizá el pago de la suscripción mensual.';
                        desc.className = 'modal-desc';
                        modalInner.appendChild(desc);

                        const actions = document.createElement('div');
                        actions.style.cssText = 'display:flex;flex-direction:column;gap:8px;align-items:stretch;width:100%';

                        // shared button style: full width, same gray gradient as other gray buttons
                        const actionBtnStyle = 'display:inline-flex;align-items:center;justify-content:center;width:100%;padding:12px;border-radius:12px;border:none;background:linear-gradient(135deg,#e6e6e6 0%,#cfcfcf 100%);color:#0f172a;font-weight:600;text-align:center;text-decoration:none;box-shadow:0 4px 12px rgba(0,0,0,0.08);min-height:48px';

                        const mpLink = document.createElement('a');
                        mpLink.id = 'mpCheckoutLink';
                        mpLink.href = mpPlanLink;
                        mpLink.setAttribute('name', 'MP-payButton');
                        mpLink.style.cssText = actionBtnStyle + ';border:1px solid rgba(0,0,0,0.04)';
                        mpLink.textContent = 'Suscribirme';
                        // ensure the anchor behaves like a button for accessibility
                        mpLink.setAttribute('role', 'button');
                        mpLink.setAttribute('tabindex', '0');
                        actions.appendChild(mpLink);

                        modalInner.appendChild(actions);

                        // divider removed per design request

                        const footer = document.createElement('div');
                        footer.style.cssText = 'display:flex;flex-direction:column;gap:8px;margin-top:0;align-items:stretch;width:100%';
                        const backBtn = document.createElement('button');
                        backBtn.id = 'backToForm';
                        backBtn.type = 'button';
                        backBtn.style.cssText = actionBtnStyle + ';background:transparent;border:1px solid #e6e9ef;color:#374151;margin-top:5px';
                        backBtn.textContent = 'Volver';
                        footer.appendChild(backBtn);

                        modalInner.appendChild(footer);

                        // style for blue-button and modal typography
                        const styleEl = document.createElement('style');
                        styleEl.textContent = "\n.modal-title { font-family: 'Orbitron', Arial, sans-serif; font-size:20px; letter-spacing:0.2px; color:#0f172a }\n.modal-desc { color: #475569; font-size:14px }\n";
                        modalInner.appendChild(styleEl);

                        // loader for Mercado Pago render.js
                        const loaderScript = document.createElement('script');
                        loaderScript.type = 'text/javascript';
                        loaderScript.async = true;
                        loaderScript.src = (document.location.protocol || 'https:') + '//secure.mlstatic.com/mptools/render.js';

                        paymentModal.appendChild(modalInner);
                        paymentModal.appendChild(loaderScript);

                        document.body.appendChild(paymentModal);

                        const removePayment = () => { try { paymentModal.remove(); } catch (e) { } };
                        backBtn.addEventListener('click', () => { window.removeEventListener('message', mpMessageHandler); removePayment(); });
                        // closeBtn removed — use 'Volver' to close the modal

                        // Message listener to handle events from Mercado Pago modal (optional)
                        const mpMessageHandler = (ev) => {
                            try {
                                if (!ev || !ev.data) return;
                                const data = typeof ev.data === 'string' ? (ev.data) : (ev.data);
                                // If MP sends a preapproval id or similar, try redirecting to mp-return
                                // Many MP widgets post messages with preapproval_id or status; we do a best-effort check
                                const text = JSON.stringify(data);
                                if (text && text.indexOf('preapproval_id') !== -1) {
                                    // close UI and redirect to mp-return to let server finalize login
                                    removePayment();
                                    closeModal();
                                    try { window.location.href = '/mp-return?email=' + encodeURIComponent(email); } catch (e) { }
                                }
                            } catch (e) { /* ignore */ }
                        };
                        window.addEventListener('message', mpMessageHandler);

                        paymentModal.querySelector('#mpCheckoutLink').addEventListener('click', async (ev) => {
                            ev.preventDefault();
                            try {
                                // Save pending subscription on our server before redirecting to checkout
                                const r = await fetch('/api/mercadopago/create-subscription-plan', {
                                    method: 'POST', headers: { 'Content-Type': 'application/json' },
                                    body: JSON.stringify({ gymName, phone, email, password: pass, planUrl: mpPlanLink })
                                });
                                const b = await r.json().catch(() => ({}));
                                if (!r.ok) {
                                    showToast(b && b.error ? b.error : 'Error iniciando pago', 'error');
                                    return;
                                }
                                if (b.checkoutUrl) {
                                    // close modals and redirect to checkout (this may open MP modal/widget)
                                    removePayment();
                                    closeModal();
                                    window.location.href = b.checkoutUrl;
                                    return;
                                }
                                showToast('No se pudo iniciar el pago', 'error');
                            } catch (e) {
                                console.error('Error iniciando pago:', e);
                                showToast('Error de red al iniciar pago', 'error');
                            }
                        });

                        // Cleanup listener when modal closed via 'Volver' or removed
                        paymentModal.querySelector('#backToForm').addEventListener('click', () => { window.removeEventListener('message', mpMessageHandler); removePayment(); });

                    } catch (e) {
                        console.error('Error preparando pago:', e);
                        showToast('Error preparando pago', 'error');
                    }
                });

            });

            // keyboard accessibility on the link
            btnCreate.addEventListener('keydown', (e) => {
                if (e.key === 'Enter' || e.key === ' ') { e.preventDefault(); btnCreate.click(); }
            });
        })();
    </script>

    <!-- Register Service Worker for PWA offline support -->
    <script>
        if ('serviceWorker' in navigator) {
            window.addEventListener('load', () => {
                navigator.serviceWorker.register('/public/sw.js')
                    .then(reg => {
                        console.log('Service Worker registrado:', reg);
                        // Check for updates periodically
                        setInterval(() => reg.update(), 60000); // Every 60 seconds
                    })
                    .catch(err => console.log('Error registrando Service Worker:', err));
            });
        }
    </script>
</body>

</html>
