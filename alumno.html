<!doctype html>
<html lang="es">

<head>
    <meta charset="utf-8" />
    <meta name="viewport" content="width=device-width, initial-scale=1" />
    <title>Alumno - Pilates Camilla</title>
    <link rel="icon"
        href="data:image/svg+xml,<svg xmlns='http://www.w3.org/2000/svg' viewBox='0 0 100 100'><rect width='100' height='100' rx='16' fill='%232563eb'/><text x='50' y='62' font-size='56' text-anchor='middle' fill='white' font-family='Arial'>A</text></svg>">
    <style>
        * {
            margin: 0;
            padding: 0;
            box-sizing: border-box;
        }

        :root {
            /* Centralized spacing variables to keep tickets-panel and cards aligned */
            --content-h: 18px;
            /* horizontal inset for main content */
            --content-v: 16px;
            /* vertical padding used by panels/cards */
        }

        body {
            font-family: 'Inter', -apple-system, BlinkMacSystemFont, 'Segoe UI', Arial, sans-serif;
            background-color: #d9d9d9;

            display: flex;
            justify-content: center;
            flex-direction: column;
        }

        .top {
            background: #fff;
            color: #111827;
            /* Use the content variables so the top card aligns with other panels */
            padding: var(--content-v) calc(var(--content-h) + 2px);
            border-radius: 8px;
            margin: 12px var(--content-h) 12px var(--content-h);
            box-shadow: 0 8px 20px rgba(2, 6, 23, 0.04);
            border: 1px solid rgba(2, 6, 23, 0.04);
            position: relative;
            /* allow absolute placement of logout button in top-right */
        }

        /* Desktop: set containers to 80% width and center them */
        @media (min-width: 901px) {
            :root {
                --container-max-w: 980px;
            }

            /* allow children to size relative to viewport; we'll set each to 80% below */
            .container {
                max-width: 100%;
            }

            .top,
            .tabs,
            #cuotaStatus,
            .cuota,
            .tickets-panel,
            .cards-row,
            .card,
            /* Ensure class containers and panels also obey the 80% width */
            #tabContent,
            #misClasesPanel,
            #recuperarPanel,
            .class-grid {
                width: 80%;
                margin-left: auto;
                margin-right: auto;
            }

            /* cuota status spacing */
            #cuotaStatus {
                margin: 12px auto;
            }
        }

        .top h1 {
            font-size: 28px;
            font-weight: 700;
            margin-bottom: 8px;
        }

        .top-header {
            display: flex;
            justify-content: space-between;
            align-items: center;
        }

        /* Header: student info area */
        .me-area {
            display: flex;
            align-items: center;
            gap: 12px;
        }

        .me-panel {
            text-align: right;
            display: flex;
            flex-direction: column;
            gap: 4px;
            align-items: flex-end;
        }

        .top-right {
            display: flex;
            flex-direction: column;
            align-items: flex-end;
            justify-content: center;
            gap: 6px;
            text-align: right;
        }

        /* Logout icon button placed in header (top-right) */

        .logout-btn {
            /* white circular background so the black X is always visible */
            background: #ffffff;
            border: 1px solid rgba(2, 6, 23, 0.06);
            color: #000;
            width: 44px;
            height: 44px;
            border-radius: 999px;
            display: inline-flex;
            align-items: center;
            justify-content: center;
            cursor: pointer;
            box-shadow: 0 8px 20px rgba(2, 6, 23, 0.06);
            transition: all 0.15s ease, transform 0.12s ease;
            position: absolute;
            /* place in top-left corner of .top */
            top: 12px;
            left: 12px;
            right: auto;
            z-index: 99999;
            /* ensure it's above avatars or other elements */
        }

        .logout-btn svg {
            width: 20px;
            height: 20px;
            transform: none;
            /* no mirroring; icon will point left explicitly */
        }

        .logout-x {
            color: #000000;
            font-size: 18px;
            font-weight: 800;
            line-height: 1;
            user-select: none;
            display: inline-block;
            transform: translateY(-1px);
            display: flex;
            justify-content: center;
            align-items: center;
        }

        .logout-btn:hover {
            transform: translateY(-3px);
            background: #ffffff;
            box-shadow: 0 12px 30px rgba(2, 6, 23, 0.08);
            color: #000;
        }

        /* From 701px and up: place logout button below the dueBox inside header
           by returning it to the normal flow and aligning it to the right.
           Also show textual label and hide the compact X. */
        @media (min-width: 701px) {
            .logout-btn {
                position: static;
                margin-top: 8px;
                align-self: flex-end;
                /* keep it right-aligned inside .top-right */
                width: auto;
                height: auto;
                padding: 8px 12px;
                border-radius: 8px;
            }

            .logout-x {
                display: none;
            }

            .logout-text {
                display: inline-block !important;
                font-weight: 700;
                color: #000000;
                font-size: 14px;
                line-height: 1;
                user-select: none;
            }
        }

        .me-name {
            font-weight: 700;
            font-size: 16px;
            color: #111827;
            text-transform: none;
        }

        .due-box {
            padding: 6px 10px;
            border-radius: 10px;
            font-size: 13px;
            font-weight: 700;
            color: #155724;
            background: #cbefd0;
            border: 1px solid #c3e6cb;
            box-shadow: 0 6px 18px rgba(72, 187, 120, 0.08);
        }

        .due-box.vencida {
            color: #721c24;
            background: linear-gradient(135deg, #f8d7da 0%, #f5c6cb 100%);
        }

        .top button {
            padding: 10px 20px;
            border-radius: 20px;
            border: 2px solid rgba(255, 255, 255, 0.3);
            background: rgba(255, 255, 255, 0.2);
            color: #fff;
            font-weight: 600;
            cursor: pointer;
            transition: all 0.3s ease;
            backdrop-filter: blur(10px);
        }

        .top button:hover {
            background: rgba(255, 255, 255, 0.3);
            border-color: rgba(255, 255, 255, 0.5);
        }

        .cuota {
            padding: 12px 24px;
            border-radius: 16px;
            font-weight: 600;
            /* keep vertical spacing but align horizontally with content */
            margin: 20px var(--content-h);
            display: inline-block;
            backdrop-filter: blur(10px);
        }

        .cuota.vigente {
            background: rgba(72, 187, 120, 0.9);
            color: #fff;
            box-shadow: 0 4px 15px rgba(72, 187, 120, 0.4);
        }

        .cuota.vencida {
            background: rgba(229, 62, 62, 0.9);
            color: #fff;
            box-shadow: 0 4px 15px rgba(229, 62, 62, 0.4);
        }

        /* Tabs bar like screenshot - centered responsively */
        .tabs {
            background: #fbfdff;
            border-radius: 10px;
            padding: 5px;
            /* force identical outer width as other main containers */
            width: calc(100% - (var(--content-h) * 2));
            margin: 0px var(--content-h);
            box-shadow: none;
            font-size: 13px;
            color: #6b7280;
            border: 1px solid rgba(2, 6, 23, 0.03);
            display: flex;
            box-sizing: border-box;
            justify-content: center;
            /* center the tab buttons horizontally */
            gap: 12px;
        }

        /* Desktop override: ensure .tabs uses the same 80% centered container as other panels */
        @media (min-width: 901px) {
            .tabs {
                width: 80%;
                margin-left: auto;
                margin-right: auto;
            }
        }

        .tab {

            background: transparent;
            color: rgba(0, 0, 0, 0.95);
            font-weight: 700;
            cursor: pointer;
            border: none;
            outline: none;
            border-radius: 6px;
            transition: all 0.18s ease;
            box-shadow: none;
            display: inline-flex;
            align-items: center;
            justify-content: center;
            flex: 0 0 auto;
            width: 49%;
            /* let content size; center via parent */
            min-width: 160px;
            padding: 10px 20px;
            text-align: center;
        }

        .tab.active {
            background-color: #d9d9d9;
            color: #111827;
            box-shadow: 0 6px 18px rgba(2, 6, 23, 0.04);
        }

        .card {
            /* Match horizontal spacing with .tickets-panel so inner class cards align */

            /* Force same outer width as other main containers so inner cards align */
            width: calc(100% - (var(--content-h) * 2));
            margin: 0px var(--content-h) 40px var(--content-h);
            box-sizing: border-box;
        }

        .alert {
            padding: 14px 20px;
            border-radius: 12px;
            margin: 16px 0;
            font-weight: 600;
            display: flex;
            align-items: center;
            gap: 10px;
        }

        .alert.success {
            background: linear-gradient(135deg, #48bb78 0%, #38a169 100%);
            color: #fff;
            box-shadow: 0 4px 15px rgba(72, 187, 120, 0.3);
        }

        .alert.error {
            background: linear-gradient(135deg, #fc8181 0%, #e53e3e 100%);
            color: #fff;
            box-shadow: 0 4px 15px rgba(229, 62, 62, 0.3);
        }

        .alert.warn {
            background: linear-gradient(135deg, #f6e05e 0%, #ecc94b 100%);
            color: #744210;
            box-shadow: 0 4px 15px rgba(237, 137, 54, 0.3);
        }

        table {
            width: 100%;
            border-collapse: separate;
            border-spacing: 0;
            background: #fff;
            border-radius: 12px;
            overflow: hidden;
            box-shadow: 0 2px 8px rgba(0, 0, 0, 0.05);
        }

        th,
        td {
            padding: 14px 12px;
            text-align: left;
        }

        th {
            background: #764ba2b6;
            color: #ffffff;
            font-weight: 600;
            font-size: 14px;
            text-transform: uppercase;
            letter-spacing: 0.5px;
        }

        tbody tr {
            border-bottom: 1px solid #f1f5f9;
            transition: all 0.2s ease;
        }

        tbody tr:hover {
            background: #f8fafc;
            transform: scale(1.01);
        }

        tbody tr:last-child {
            border-bottom: none;
        }

        button {
            padding: 10px 20px;
            border-radius: 10px;
            border: none;
            background: linear-gradient(135deg, #667eea 0%, #764ba2 100%);
            color: #fff;
            font-weight: 600;
            cursor: pointer;
            transition: all 0.3s ease;
            box-shadow: 0 4px 12px rgba(102, 126, 234, 0.3);
        }

        button:hover {
            /* No translation to avoid moving/creating gap with content below */
            transform: none;
            filter: brightness(1.03);
        }

        button.cancel {
            background: linear-gradient(135deg, #fe3c3ccc 0%, #e83939db 100%);
            box-shadow: 0 4px 12px rgba(191, 191, 191, 0.3);
        }

        button.cancel:hover {
            box-shadow: 0 6px 16px rgba(58, 58, 58, 0.4);
        }

        button.recover {
            background: linear-gradient(135deg, #48bb78 0%, #38a169 100%);
            box-shadow: 0 4px 12px rgba(72, 187, 120, 0.3);
        }

        button.recover:hover {
            box-shadow: 0 6px 16px rgba(72, 187, 120, 0.4);
        }

        button:disabled {
            background: #cbd5e1;
            color: #94a3b8;
            cursor: not-allowed;
            box-shadow: none;
        }

        .tickets-badge {
            display: inline-block;
            padding: 12px 18px;
            color: #111827;
            background: #f8fafc;
            border-radius: 12px;
            font-size: 16px;
            font-weight: 800;
            margin-left: 12px;
            min-width: 44px;
            text-align: center;
            box-shadow: 0 6px 18px rgba(2, 6, 23, 0.04);
        }

        /* Big panel showing classes available to recover */
        .tickets-panel {
            background: #fbfdff;
            border-radius: 10px;
            padding: 5px;
            padding-left: 15px;
            /* Force identical outer width */
            width: calc(100% - (var(--content-h) * 2));
            margin: 12px var(--content-h);
            box-shadow: none;
            font-size: 13px;
            color: #6b7280;
            border: 1px solid rgba(2, 6, 23, 0.03);
            box-sizing: border-box;
            margin-bottom: 35px !important;
            margin-top: 0px !important;
        }

        .tickets-panel .big-number {
            font-size: 28px;
            font-weight: 800;
            color: #111827;
            margin-top: 6px;
        }

        @keyframes fadeIn {
            from {
                opacity: 0;
            }

            to {
                opacity: 1;
            }
        }

        .modal-content {
            background: #fff;
            padding: 32px;
            border-radius: 20px;
            max-width: 500px;
            width: 90%;
            box-shadow: 0 20px 60px rgba(0, 0, 0, 0.3);
            animation: slideUp 0.3s ease;
        }

        /* Modal overlay to ensure the modal is visible and centered */
        .modal {
            position: fixed;
            inset: 0;
            display: flex;
            align-items: center;
            justify-content: center;
            background: rgba(0, 0, 0, 0.35);
            z-index: 9999;
            padding: 20px;
        }

        @keyframes slideUp {
            from {
                opacity: 0;
                transform: translateY(20px);
            }

            to {
                opacity: 1;
                transform: translateY(0);
            }
        }

        .modal-content h3 {
            margin-top: 0;
            color: #000000;
            font-size: 22px;
            margin-bottom: 12px;
        }

        .modal-content p {
            color: #64748b;
            line-height: 1.6;
        }

        .modal-actions {
            display: flex;
            gap: 12px;
            justify-content: flex-end;
            margin-top: 24px;
        }

        .modal-actions button {
            padding: 12px 24px;
        }

        @media (max-width: 700px) {
            body {
                overflow-x: hidden;
            }

            .top {
                padding: 16px;
            }

            .top h1 {
                font-size: 20px;
            }

            .top-header {
                flex-direction: column;
                gap: 12px;
                align-items: center;
            }

            .top-header>div {
                display: flex;
                flex-wrap: wrap;
                gap: 8px;
                align-items: center;
                width: 100%;
            }

            .top button {
                padding: 8px 16px;
                font-size: 14px;
            }

            #meHeader {
                font-size: 22px;
            }

            .cuota {
                margin: 12px 16px;
                padding: 10px 16px;
                font-size: 14px;
            }

            .tabs {

                gap: 8px;
                overflow-x: hidden;

            }

            .tab {
                padding: 12px 20px;
                font-size: 14px;
                white-space: nowrap;
            }

            .card {
                /* Keep mobile spacing consistent with tickets-panel */


                border-radius: 0 16px 16px 16px;
            }

            /* Hacer tablas responsive con scroll horizontal */
            table {
                display: block;
                overflow-x: auto;
                -webkit-overflow-scrolling: touch;
                white-space: nowrap;
            }

            th,
            td {
                padding: 10px 8px;
                font-size: 13px;
            }

            button {
                padding: 8px 14px;
                font-size: 14px;
            }

            .tickets-badge {
                padding: 6px 12px;
                font-size: 12px;
                margin-left: 8px;
            }

            .alert {
                padding: 12px 16px;
                font-size: 14px;
            }

            .modal-content {
                width: 95%;
                padding: 24px 20px;
            }

            .modal-content h3 {
                font-size: 20px;
            }

            .modal-content p {
                font-size: 14px;
            }

            .modal-actions button {
                padding: 10px 16px;
                font-size: 14px;
            }

            /* Mobile: center header content */
            .top-header {
                flex-direction: column;
                align-items: center;
                gap: 10px;
            }

            .top-right {
                align-items: center;
                text-align: center;
                width: 100%;
            }

            .top-left {
                width: 100%;
            }

            .top-left h1 {
                text-align: center;
                margin: 0 auto;
            }
        }

        @media (max-width: 480px) {
            .top h1 {
                font-size: 18px;
            }


            .tab {
                padding: 10px 16px;
                font-size: 13px;
            }



            th,
            td {
                padding: 8px 6px;
                font-size: 12px;
            }

            button {
                padding: 6px 12px;
                font-size: 13px;
            }

            /* Small logout button bottom-left */
            #logoutFooter {
                position: fixed;
                bottom: 12px;
                left: 12px;
                width: auto !important;
                padding: 8px 12px !important;
                border-radius: 8px;
                font-size: 13px;
                box-shadow: 0 6px 18px rgba(0, 0, 0, 0.12);
                color: rgb(0, 0, 0) !important;
            }

            /* Ensure header right block is centered on very small screens */
            .top-header {
                flex-direction: column;
                align-items: center;
                gap: 8px;
            }

            .top-right {
                align-items: center;
                text-align: center;
            }

            .top-right {
                width: 100%;
            }

            .top-left {
                width: 100%;
            }

            .top-left h1 {
                text-align: center;
                margin: 0 auto;
            }
        }

        /* Highlight recovered classes (yellow background) and mark with yellow left border */
        .recovered-row {
            background: linear-gradient(90deg, #fff9c4 0%, #fff59d 100%);
            /* override the default black left border for recovered classes */
            border-left: 5px solid #f6e05e;
        }

        /* Card based layout for class lists */
        .class-grid {
            display: grid;
            /* Desktop: allow multiple cards per row with a sensible minimum width */
            grid-template-columns: repeat(auto-fit, minmax(260px, 1fr));
            gap: 16px;
            /* center the grid within its container so columns appear centered */
            justify-content: center;
            /* Remove horizontal padding so cards align with .card / .tickets-panel edges.
               .card already provides the horizontal inset via var(--content-h). */
            padding: 12px 0 18px 0;

        }

        .class-card {
            background: #fff;
            border-radius: 8px;
            padding: 16px;
            border-left: 5px solid rgb(0, 0, 0);
            box-shadow: 0 6px 18px rgba(2, 6, 23, 0.02);
            display: flex;
            flex-direction: column;
            gap: 10px;

            transition: transform 0.12s ease, box-shadow 0.12s ease;

        }

        .class-card:hover {
            transform: translateY(-4px);
            box-shadow: 0 12px 30px rgba(16, 24, 40, 0.12);
        }

        /* Ensure recovered cards show a yellow left border despite .class-card default */
        .class-card.recovered-row {
            border-left-color: #fbdc2c;
        }

        .class-card .date {
            font-weight: 800;
            color: #111827;
            font-size: 15px;
        }

        .class-card .meta {
            display: flex;
            flex-direction: column;
            gap: 8px;
            color: #6b7280;
            font-size: 13px;
        }

        .class-card .meta .label {
            color: #6b7280;
        }

        .card-actions {
            display: block;
            margin-top: 12px;
        }

        .btn-pill {
            padding: 8px 12px;
            border-radius: 999px;
            border: none;
            cursor: pointer;
            font-weight: 700;
            font-size: 13px;
        }

        .cancel-full {
            width: 100%;
            padding: 10px 14px;
            border-radius: 10px;
            border: 1px solid rgba(2, 6, 23, 0.06);
            background: #fff;
            color: #111827;
            font-weight: 700;
            box-shadow: none;
            display: flex;
            align-items: center;
            justify-content: center;
            gap: 8px;
            font-size: 14px
        }

        .recover-full {
            width: 100%;
            padding: 10px 14px;
            border-radius: 10px;
            border: none;
            background: linear-gradient(90deg, #10b981 0%, #059669 100%);
            color: #fff;
            font-weight: 800;
            box-shadow: none;
            display: flex;
            align-items: center;
            justify-content: center;
            gap: 8px;
            font-size: 14px
        }

        .btn-cancel {
            background: linear-gradient(135deg, #fc8181 0%, #e53e3e 100%);
            color: #fff;
            box-shadow: 0 6px 18px rgba(229, 62, 62, 0.18);
        }

        .btn-recover {
            background: linear-gradient(135deg, #48bb78 0%, #38a169 100%);
            color: #fff;
            box-shadow: 0 6px 18px rgba(72, 187, 120, 0.18);
        }

        .badge-recovered {
            display: inline-block;
            padding: 6px 10px;
            background: linear-gradient(90deg, #fff9c4 0%, #fff59d 100%);
            color: #8a6d00;
            border-radius: 999px;
            font-weight: 800;
            font-size: 12px;
        }

        @media (max-width: 520px) {
            .class-grid {
                gap: 12px;
                grid-template-columns: 1fr;
            }

            .class-card {
                padding: 12px;
                position: relative;

            }

            .class-card .date {
                font-size: 16px;
            }

            .class-card .meta {
                flex-direction: column;
                align-items: flex-start;
                gap: 6px;
                font-size: 15px;
            }

            .card-actions {
                width: 100%;
                justify-content: flex-end;
            }

            /* Stack action buttons on small screens for easier tapping */
            .card-actions {
                display: flex;
                flex-direction: column;
                gap: 8px;
            }

            .btn-pill {
                width: 100%;
            }

            .badge-recovered {
                position: absolute;
                top: 10px;
                right: 10px;
            }
        }
        /* Tuned blobs: darker color, more movement but visually subtle
           - lower visual prominence via higher blur + lower opacity
           - stronger movement (larger translation + rotation) to show motion
           - mix-blend-mode: multiply to keep them dark while not overpowering UI
           - respects prefers-reduced-motion */
        html {
            background-color: #d9d9d9; /* base background */
        }

        body {
            position: relative;
            background-color: transparent;
        }

        .container {
            position: relative;
            z-index: 3;
        }

        body::before,
        body::after {
            content: '';
            position: fixed;
            pointer-events: none;
            z-index: 0;
            filter: blur(34px); /* softer edges to be less intrusive */
            opacity: 0.22;     /* subtle visibility */
            will-change: transform;
            mix-blend-mode: multiply;
        }

        body::before {
            width: 72vw;
            height: 72vw;
            left: -18vw;
            top: -12vw;
            background: radial-gradient(circle at 30% 30%, rgba(4,30,66,0.95), rgba(4,30,66,0.85) 30%, rgba(4,30,66,0.6) 52%, transparent 72%);
            transform: translate3d(0, 0, 0) rotate(0deg) scale(1);
            animation: blobFloatA 8s ease-in-out infinite;
        }

        body::after {
            width: 66vw;
            height: 66vw;
            right: -18vw;
            bottom: -18vw;
            background: radial-gradient(circle at 70% 70%, rgba(45,10,60,0.95), rgba(45,10,60,0.85) 30%, rgba(45,10,60,0.6) 52%, transparent 72%);
            transform: translate3d(0, 0, 0) rotate(0deg) scale(1);
            animation: blobFloatB 9s ease-in-out infinite;
        }

        @keyframes blobFloatA {
            0% { transform: translate3d(0,0,0) rotate(0deg) scale(1); }
            20% { transform: translate3d(10vw,-12vw,0) rotate(10deg) scale(1.08); }
            50% { transform: translate3d(0,10vw,0) rotate(-8deg) scale(1.12); }
            80% { transform: translate3d(-8vw,-6vw,0) rotate(6deg) scale(1.06); }
            100% { transform: translate3d(0,0,0) rotate(0deg) scale(1); }
        }

        @keyframes blobFloatB {
            0% { transform: translate3d(0,0,0) rotate(0deg) scale(1); }
            20% { transform: translate3d(-11vw,10vw,0) rotate(-9deg) scale(1.08); }
            50% { transform: translate3d(8vw,-8vw,0) rotate(8deg) scale(1.14); }
            80% { transform: translate3d(-6vw,12vw,0) rotate(-6deg) scale(1.07); }
            100% { transform: translate3d(0,0,0) rotate(0deg) scale(1); }
        }

        @media (prefers-reduced-motion: reduce) {
            body::before,
            body::after {
                animation: none !important;
                filter: blur(36px);
                opacity: 0.12;
                mix-blend-mode: normal;
            }
        }

    </style>
</head>

<body>
    
    <div class="container">
        <div class="top">
            <div class="top-header">
                <div class="top-left">
                    <!-- Header ahora mostrará nombre y apellido del alumno -->
                    <h1 id="meHeader">Cargando...</h1>
                </div>
                <div class="top-right">
                    <div id="dueBox" class="due-box">Cuota: --</div>
                    <!-- Logout icon/button placed top-right for easy access -->
                    <button id="logoutTop" class="logout-btn" aria-label="Cerrar sesión" title="Cerrar sesión">
                        <!-- Compact X for small screens -->
                        <span class="logout-x" aria-hidden="true">✕</span>
                        <!-- Text label for larger screens (hidden by default) -->
                        <span class="logout-text" aria-hidden="true" style="display:none">Cerrar sesión</span>
                    </button>
                </div>
            </div>
        </div>

        <div id="cuotaStatus" class="cuota">Cargando cuota...</div>
        <div class="tabs">
            <button class="tab active" id="tabClases">Mis Clases</button>
            <button class="tab" id="tabRecuperar">Recuperar Clase</button>
        </div>
        <div class="card" id="tabContent">
            <!-- Content will be loaded here -->
        </div>
    </div>
    <div id="alertContainer"></div>
    <div id="modalContainer"></div>
    <!-- footer logout removed: logout moved to header for easier access -->
    <script src="/public/js/auth.js"></script>
    <script src="/public/js/admin_classes.js"></script>
    <script src="/public/js/admin_gym.js"></script>
    <script>
        let alumno = null;
        let gymConfig = null;
        let tickets = [];
        let ticketsUsed = [];
        // Client-side synthetic tickets created when backend doesn't return a ticket
        // after cancelling a previously recovered class. These persist until full reload.
        let syntheticTickets = [];
        // Keep a short-lived client-side history of instances/classes that WERE
        // recovered at some point. This ensures we keep showing the yellow
        // recovered border even after the student cancels the recovered class.
        // It lives only in-memory and won't affect server state.
        let recoveredHistory = [];
        let classes = [];
        let activeTab = localStorage.getItem('alumnoTab') || 'clases';
        let refreshTimer = null;

        function showAlert(type, msg) {
            const icons = { success: '✅', error: '❌', warn: '⚠️' };
            document.getElementById('alertContainer').innerHTML = `<div class="alert ${type}">${icons[type]} ${msg}</div>`;
            setTimeout(() => { document.getElementById('alertContainer').innerHTML = ''; }, 3500);
        }

        function showModal(title, message, onConfirm) {
            const modalHTML = `
                <div class="modal">
                    <div class="modal-content">
                        <h3>${title}</h3>
                        <p>${message}</p>
                        <div class="modal-actions">
                            <button onclick="closeModal()" style="background:#e2e8f0;color:#475569;box-shadow:none;">Cancelar</button>
                            <button onclick="confirmModal()">Confirmar</button>
                        </div>
                    </div>
                </div>
            `;
            document.getElementById('modalContainer').innerHTML = modalHTML;

            // Guardar callback
            window.modalConfirmCallback = onConfirm;
            // Mark modal open so other logic can avoid interfering
            window._modalOpen = true;
        } function closeModal() {
            document.getElementById('modalContainer').innerHTML = '';
            window.modalConfirmCallback = null;
            window._modalOpen = false;
        }

        // Simple modal with a single OK button (used for informational alerts
        // where we want the user to acknowledge but still proceed with the
        // cancellation). onOk will be executed when the user clicks OK.
        function showOkModal(title, message, onOk) {
            const modalHTML = `
                <div class="modal">
                    <div class="modal-content">
                        <h3>${title}</h3>
                        <p>${message}</p>
                        <div class="modal-actions" style="justify-content:center;">
                            <button onclick="okModalClick()" style="background:#667eea;color:#fff;">Aceptar</button>
                        </div>
                    </div>
                </div>
            `;
            document.getElementById('modalContainer').innerHTML = modalHTML;
            window._modalOpen = true;
            window._okModalCallback = onOk;
        }

        function okModalClick() {
            try {
                if (window._okModalCallback) window._okModalCallback();
            } finally {
                document.getElementById('modalContainer').innerHTML = '';
                window._okModalCallback = null;
                window._modalOpen = false;
            }
        }

        function confirmModal() {
            if (window.modalConfirmCallback) {
                window.modalConfirmCallback();
            }
            closeModal();
        }

        /* Logout confirmation modal (aesthetic, centered, with icon) */
        function showLogoutConfirm() {
            const modalHTML = `
                <div class="modal">
                    <div class="modal-content" style="max-width:420px;text-align:center;">
                        <div style="width:88px;height:88px;margin:0 auto 12px;border-radius:999px;background:linear-gradient(135deg,#eef2ff,#f8fbff);display:flex;align-items:center;justify-content:center;color:#667eea">
                                <svg viewBox="0 0 44 44" xmlns="http://www.w3.org/2000/svg" aria-hidden="true" style="width:44px;height:44px;" role="img" focusable="false">
                                <line x1="10" y1="10" x2="34" y2="34" stroke="#000" stroke-width="3" stroke-linecap="round" />
                                <line x1="10" y1="34" x2="34" y2="10" stroke="#000" stroke-width="3" stroke-linecap="round" />
                            </svg>
                        </div>
                        <h3>Cerrar sesión</h3>
                        <p style="color:#475569;margin-top:6px;">Vas a cerrar sesión en tu cuenta. ¿Querés continuar?</p>
                        <div class="modal-actions" style="justify-content:center;margin-top:20px;">
                            <button onclick="closeModal()" style="background:#e2e8f0;color:#475569;box-shadow:none;">Cancelar</button>
                            <button onclick="confirmLogout()" style="    background: linear-gradient(90deg, #595c6b, #000000);">Cerrar sesión</button>
                        </div>
                    </div>
                </div>
            `;
            document.getElementById('modalContainer').innerHTML = modalHTML;
            window._modalOpen = true;
        }

        function confirmLogout() {
            try {
                // Close modal first for a smooth UX
                closeModal();
            } finally {
                // Delegate to auth helper which will clear token and redirect
                if (window.pilatesAuth && typeof pilatesAuth.logout === 'function') pilatesAuth.logout();
                else window.location.href = '/index.html';
            }
        }

        async function loadConfig() {
            // usar endpoint público para que funcione con tokens de alumno
            try {
                const res = await fetch('/api/gym/config/public');
                gymConfig = await res.json();
            } catch (e) {
                console.warn('No se pudo cargar config pública, fallback a valores por defecto');
                gymConfig = { minCancellationHours: 24, creditExpirationDays: 30, autoCancelDueOverdueDays: 7, maxCredits: 10 };
            }
        }

        async function loadAlumno() {
            try {
                const me = await pilatesAuth.getMe();
                // pedir datos completos del alumno al backend
                const res = await fetch(`/api/students/${me.id}`, { headers: { Authorization: `Bearer ${localStorage.getItem('token')}` } });
                if (!res.ok) throw new Error(`HTTP ${res.status}`);
                alumno = await res.json();
                // Normalize name and lastname to start with uppercase
                function titleCase(str) {
                    if (!str) return '';
                    return str.split(' ').map(s => s.charAt(0).toUpperCase() + s.slice(1).toLowerCase()).join(' ');
                }
                const displayName = `${titleCase(alumno.name)} ${titleCase(alumno.lastName)}`.trim();
                // Mostrar nombre completo en el encabezado principal
                const headerEl = document.getElementById('meHeader');
                // Show display name and (below it) the assigned days/times for the student's classes
                if (headerEl) {
                    // Default to just the name; we'll try to fetch assigned classes and append a schedule line
                    headerEl.innerHTML = `<div>${displayName || 'Alumno'}</div>`;
                    try {
                        const clsRes = await fetch(`/api/students/${me.id}/classes`, { headers: { Authorization: `Bearer ${localStorage.getItem('token')}` } });
                        if (clsRes.ok) {
                            const assigned = await clsRes.json();
                            // Build a concise schedule string per class: "lunes, miércoles y viernes 20hs"
                            const formatDays = (days) => {
                                if (!Array.isArray(days) || days.length === 0) return '';
                                // Normalize spacing and lowercase
                                const ds = days.map(d => String(d).trim());
                                if (ds.length === 1) return ds[0];
                                if (ds.length === 2) return `${ds[0]} y ${ds[1]}`;
                                return ds.slice(0, -1).join(', ') + ' y ' + ds[ds.length - 1];
                            };
                            const formatStart = (start) => {
                                if (!start) return '';
                                const parts = String(start).split(':');
                                if (parts.length >= 2) {
                                    if (parts[1] === '00') return `${parts[0]}hs`;
                                    return `${parts[0]}:${parts[1]}hs`;
                                }
                                return `${parts[0]}hs`;
                            };

                            const entries = assigned.map(c => {
                                const daysStr = formatDays(c.days || []);
                                const timeStr = formatStart(c.start || '');
                                const joined = [daysStr, timeStr].filter(Boolean).join(' ');
                                return joined;
                            }).filter(Boolean);

                            const scheduleStr = entries.length ? entries.join(' · ') : '';
                            if (scheduleStr) {
                                const node = document.createElement('div');
                                node.style.fontSize = '13px';
                                node.style.color = '#6b7280';
                                node.style.marginTop = '4px';
                                node.textContent = scheduleStr;
                                headerEl.appendChild(node);
                            }
                        }
                    } catch (e) {
                        // silent fallback: leave only name
                        console.warn('Could not load assigned classes for header schedule', e);
                    }
                }
                // Update due box inside header
                const dueBox = document.getElementById('dueBox');
                if (alumno.dueDate) {
                    const d = new Date(alumno.dueDate);
                    if (!isNaN(d.getTime())) {
                        dueBox.textContent = `Cuota vigente hasta ${d.toLocaleDateString()}`;
                        dueBox.classList.remove('vencida');
                    } else {
                        dueBox.textContent = 'Cuota: --';
                    }
                } else {
                    dueBox.textContent = 'Cuota: --';
                }
                // Hide the separate big cuotaStatus box (we show it in header now)
                const cuotaDiv = document.getElementById('cuotaStatus');
                if (cuotaDiv) cuotaDiv.style.display = 'none';
            } catch (e) {
                console.error('Error loading alumno:', e);
                const headerError = document.getElementById('meHeader');
                if (headerError) headerError.textContent = 'Error cargando datos';
                showAlert('error', 'No se pudieron cargar tus datos. ' + e.message);
                throw e;
            }
        }

        function updateCuotaStatus() {
            const cuotaDiv = document.getElementById('cuotaStatus');
            const now = new Date();
            // Keep behaviour for other consumers but hide it (we now render due info in header)
            if (!cuotaDiv) return;
            cuotaDiv.style.display = 'none';
        }

        async function loadTickets() {
            // tickets ya vienen en alumno; separar activos de usados para poder marcar recuperadas
            const now = new Date();
            const raw = (alumno.tickets || []).map(t => ({
                id: t.id || t.ticketId || null,
                classId: t.classId || null,
                instanceId: t.instanceId || null,
                status: t.status || (t.used ? 'used' : 'active'),
                expiresAt: t.expiresAt || t.expiry || t.createdAt,
                createdAt: t.createdAt || null,
                usedAt: t.usedAt || null
            }));

            tickets = raw.filter(t => t.status === 'active' && new Date(t.expiresAt || t.createdAt) > now);
            ticketsUsed = raw.filter(t => t.status === 'used' || (t.usedAt && new Date(t.usedAt) <= now));

            // Merge any client-side synthetic tickets (avoid duplicates)
            if (Array.isArray(syntheticTickets) && syntheticTickets.length) {
                const toAdd = syntheticTickets.filter(st => !tickets.some(t => t.id === st.id));
                if (toAdd.length) tickets = tickets.concat(toAdd);
            }

            // Actualizar badge de tickets (mostrar siempre aunque sea 0) con texto solicitado
            const badge = document.getElementById('ticketsBadge');
            if (badge) {
                badge.textContent = `Clases disponibles para recuperar: ${tickets.length}`;
                badge.style.display = 'inline-block';
            }

            // Mostrar panel grande con cantidad de clases para recuperar
            const cuotaDiv = document.getElementById('cuotaStatus');
            if (cuotaDiv) {
                cuotaDiv.style.display = 'block';
                cuotaDiv.className = 'tickets-panel';
                cuotaDiv.innerHTML = `<div>Clases disponibles para recuperar :</div><div class="big-number">${tickets.length}</div>`;
            }
        }

        async function loadClasses() {
            // Obtener instancias específicas del alumno
            try {
                const token = localStorage.getItem('token');
                if (!token) { classes = []; return; }
                const me = await pilatesAuth.getMe();
                const res = await fetch(`/api/students/${me.id}/class-instances`, {
                    headers: { Authorization: `Bearer ${token}` }
                });
                if (!res.ok) {
                    classes = [];
                    return;
                }
                classes = await res.json();
                // If there are no upcoming generated instances, fall back to the
                // student's enrolled classes so the UI still shows what the
                // student is assigned to. Respect the gym's autoCancelDueOverdueDays
                // (grace period after quota dueDate).
                if ((!classes || classes.length === 0) && alumno) {
                    try {
                        // If the student's due date is past the admin-defined grace
                        // period, we should not show the classes.
                        const now = new Date();
                        const extraDays = (gymConfig && gymConfig.autoCancelDueOverdueDays) ? gymConfig.autoCancelDueOverdueDays : 0;
                        if (alumno.dueDate) {
                            const venc = new Date(alumno.dueDate);
                            if (venc < now && ((now - venc) / 864e5) > extraDays) {
                                // quota expired beyond grace period -> don't show classes
                                classes = [];
                                return;
                            }
                        }

                        const clsRes = await fetch(`/api/students/${me.id}/classes`, {
                            headers: { Authorization: `Bearer ${token}` }
                        });
                        if (clsRes.ok) {
                            const enrolled = await clsRes.json();
                            // For each enrolled class, synthesize the next occurrence
                            // within a computed window so the UI can render a card.
                            // The window is: up to the student's dueDate + gymConfig.autoCancelDueOverdueDays,
                            // but bounded to a safe maximum to avoid very long computations.
                            const synthesized = [];
                            const MAX_SYNTH_DAYS = 90;
                            const today = new Date();
                            let maxOffset = 30; // default fallback
                            try {
                                const extraDays = (gymConfig && gymConfig.autoCancelDueOverdueDays) ? gymConfig.autoCancelDueOverdueDays : 0;
                                if (alumno && alumno.dueDate) {
                                    const venc = new Date(alumno.dueDate);
                                    const upper = new Date(venc);
                                    upper.setDate(upper.getDate() + extraDays);
                                    const daysUntilUpper = Math.ceil((upper - today) / 864e5);
                                    if (daysUntilUpper > 0) {
                                        maxOffset = Math.min(daysUntilUpper, MAX_SYNTH_DAYS);
                                    } else {
                                        // Already past the upper limit; no synthesis window
                                        maxOffset = 0;
                                    }
                                }
                            } catch (eCalc) {
                                console.warn('Error computing synth window, using default 30 days', eCalc);
                                maxOffset = 30;
                            }
                            const dayMap = { 0: 'domingo', 1: 'lunes', 2: 'martes', 3: 'miércoles', 4: 'jueves', 5: 'viernes', 6: 'sábado' };
                            for (const c of enrolled) {
                                // compute next date for one of the class days
                                let found = null;
                                for (let offset = 0; offset <= maxOffset; offset++) {
                                    const d = new Date(today);
                                    d.setDate(today.getDate() + offset);
                                    const weekdayName = dayMap[d.getDay()];
                                    // class.days may contain Spanish day names
                                    if (Array.isArray(c.days) && c.days.includes(weekdayName)) {
                                        // parse c.start (HH:MM) if present
                                        let instDate = new Date(d);
                                        if (c.start && typeof c.start === 'string') {
                                            const parts = c.start.split(':').map(x => parseInt(x, 10));
                                            if (!isNaN(parts[0])) instDate.setHours(parts[0]);
                                            if (!isNaN(parts[1])) instDate.setMinutes(parts[1]);
                                            instDate.setSeconds(0); instDate.setMilliseconds(0);
                                        }
                                        found = instDate;
                                        break;
                                    }
                                }
                                const pseudo = {
                                    // create a synthetic id so rendering and canceling won't accidentally treat it as a real instance
                                    _id: `class-${c._id}`,
                                    classId: c._id,
                                    dateTime: (found || new Date()).toISOString(),
                                    duration: c.duration || null,
                                    roomName: c.roomName || null,
                                    professorName: c.professorName || null,
                                    // keep students so some UI logic which checks membership still works
                                    students: c.students || [],
                                    // Mark as 'synthetic' so downstream flows avoid sending instance-level API calls
                                    _synthetic: true
                                };
                                synthesized.push(pseudo);
                            }
                            if (synthesized.length) classes = synthesized;
                        }
                    } catch (e) {
                        console.warn('Error loading enrolled classes fallback:', e);
                    }
                }
            } catch (err) {
                console.warn('Error loading class instances for student', err);
                classes = [];
            }
        }

        function switchTab(tab) {
            activeTab = tab;
            localStorage.setItem('alumnoTab', tab);
            document.getElementById('tabClases').classList.toggle('active', tab === 'clases');
            document.getElementById('tabRecuperar').classList.toggle('active', tab === 'recuperar');
            renderTab();
        }

        function renderTab() {
            if (activeTab === 'clases') renderMisClases();
            else renderRecuperarClase();
        }

        function renderMisClases() {
            console.log('renderMisClases called');
            if (!classes.length) {
                // Mejor mensaje explicativo: si la cuota está vencida fuera del periodo
                // de gracia o si el alumno no está inscrito en ninguna clase, mostrar
                // instrucciones claras para el usuario.
                const now = new Date();
                let msg = 'No tenés clases próximas asignadas.';
                if (alumno && alumno.dueDate) {
                    const venc = new Date(alumno.dueDate);
                    const extra = (gymConfig && gymConfig.autoCancelDueOverdueDays) ? gymConfig.autoCancelDueOverdueDays : 0;
                    const daysSince = Math.floor((now - venc) / 864e5);
                    if (venc < now && daysSince > extra) {
                        msg = 'Tu cuota está vencida y excede el período de gracia. Contactá al administrador para reactivar tu cuenta.';
                    } else {
                        msg = 'No estás inscrito en ninguna clase en este momento. Si creés que es un error, contactá al administrador.';
                    }
                }
                document.getElementById('tabContent').innerHTML = `<div style="margin:24px 0">${msg}</div>`;
                return;
            }

            // Render as card grid for better responsiveness
            let html = '<div class="class-grid">';
            for (const inst of classes) {
                const dt = new Date(inst.dateTime);
                const dayNames = ['Domingo', 'Lunes', 'Martes', 'Miércoles', 'Jueves', 'Viernes', 'Sábado'];
                const hrs = dt.getHours();
                const mins = dt.getMinutes();
                const timeStr = mins === 0 ? `${hrs}hs` : `${hrs.toString().padStart(2, '0')}:${mins.toString().padStart(2, '0')}hs`;
                const dateStr = `${dayNames[dt.getDay()]} ${dt.getDate()}/${dt.getMonth() + 1} - ${timeStr}`;

                const instId = inst._id && inst._id.toString ? inst._id.toString() : String(inst._id);
                const classId = inst.classId && inst.classId.toString ? inst.classId.toString() : String(inst.classId || '');
                // recovered if the instance object was explicitly marked as recovered
                // (preferred), or a used ticket refers to this exact instance, or
                // if this exact instance was previously recovered (we store
                // instance ids in recoveredHistory). Using the instance property
                // is more robust and prevents accidental matches across many
                // classes.
                const recovered = (!!inst._recovered) || ticketsUsed.some(t => (t.instanceId && String(t.instanceId) === instId)) || recoveredHistory.includes(instId);

                html += `
                    <div class="class-card ${recovered ? 'recovered-row' : ''}" data-id="${inst._id}">
                        <div style="display:flex;gap:12px;align-items:flex-start;">
                            <div style="width:56px;flex:0 0 56px;display:flex;align-items:center;justify-content:center;border-radius:10px;background:#f3f4f6;">
                                <!-- calendar SVG -->
                                <svg width="28" height="28" viewBox="0 0 24 24" fill="none" xmlns="http://www.w3.org/2000/svg"><rect x="3" y="4" width="18" height="16" rx="2" stroke="#374151" stroke-width="1.2" fill="#ffffff"/><path d="M8 2v4M16 2v4" stroke="#374151" stroke-width="1.2" stroke-linecap="round"/><path d="M7 11h1M11 11h6M7 15h1" stroke="#374151" stroke-width="1.2" stroke-linecap="round" stroke-linejoin="round"/></svg>
                            </div>
                            <div style="flex:1">
                                <div class="date">${dateStr}</div>
                                <div class="meta">
                                    <div style="display:flex;align-items:center;gap:8px;color:#6b7280"><svg width="14" height="14" viewBox="0 0 24 24" fill="none" xmlns="http://www.w3.org/2000/svg"><path d="M12 12c2.761 0 5-2.239 5-5s-2.239-5-5-5-5 2.239-5 5 2.239 5 5 5z" stroke="#9ca3af" stroke-width="1.2"/><path d="M4 20c0-4 4-6 8-6s8 2 8 6" stroke="#9ca3af" stroke-width="1.2"/></svg> ${inst.professorName || '-'}</div>
                                    <div style="display:flex;align-items:center;gap:8px;color:#6b7280"><svg width="14" height="14" viewBox="0 0 24 24" fill="none" xmlns="http://www.w3.org/2000/svg"><path d="M12 2C8.13 2 5 5.13 5 9c0 5.25 7 13 7 13s7-7.75 7-13c0-3.87-3.13-7-7-7z" stroke="#9ca3af" stroke-width="1.2" fill="none"/></svg> ${inst.roomName || '-'}</div>
                                </div>
                            </div>
                            
                        </div>
                        <div class="card-actions">
                            <button type="button" class="cancel-full cancel" data-id="${instId}" data-date="${dateStr}" data-recovered="${recovered ? '1' : '0'}" data-classid="${classId}"><span style="font-weight:900">✖</span> <span>Cancelar</span></button>
                        </div>
                    </div>`;
            }

            html += '</div>';
            document.getElementById('tabContent').innerHTML = html;

            // Clicks for cancel are handled by the delegated document click handler.
            // We avoid attaching per-button listeners to prevent duplicate events.
            console.log('Cancel buttons rendered; delegated handler will manage clicks');
        }

        function confirmarCancelar(instanceId, dateStr, recovered = false, classId = null) {
            console.log('confirmarCancelar called, instanceId=', instanceId, 'dateStr=', dateStr, 'recovered=', recovered, 'classId=', classId);
            showModal(
                '¿Confirmar cancelación?',
                `¿Estás seguro que querés cancelar la clase del ${dateStr}?`,
                () => cancelarInstancia(instanceId, { recovered: !!recovered, classId: classId })
            );
        }

        async function cancelarInstancia(instanceId, opts = {}) {
            // opts: { recovered: boolean, classId: string }
            try {
                const myId = (alumno._id || alumno.id).toString();
                // If this is a synthesized class-level pseudo-instance (no real instance id)
                // use the class-level cancel endpoint so the backend can create a ticket.
                const isClassCancel = !!opts.classId && String(instanceId).startsWith('class-');
                let res, data;
                if (isClassCancel) {
                    res = await fetch(`/api/students/${myId}/cancel/${opts.classId}`, {
                        method: 'POST',
                        headers: { Authorization: `Bearer ${localStorage.getItem('token')}` }
                    });
                    try { data = await res.json(); } catch (e) { data = {}; }
                    if (!res.ok) throw new Error(data.error || 'No se pudo cancelar la clase');
                } else {
                    res = await fetch(`/api/students/${myId}/cancel-instance/${instanceId}`, {
                        method: 'POST',
                        headers: { Authorization: `Bearer ${localStorage.getItem('token')}` }
                    });
                    data = await res.json();
                    if (!res.ok) throw new Error(data.error || 'No se pudo cancelar');
                }

                // At this point the server confirmed cancellation. To make the
                // UI reflect that immediately, remove the canceled instance from
                // the local `classes` list and re-render.
                try {
                    // If the instance was recovered before, keep a record so the
                    // recovered yellow border continues to show.
                    const instIdStr = String(instanceId);
                    const recoveredBefore = ticketsUsed.some(t => (t.instanceId && String(t.instanceId) === instIdStr));
                    if (recoveredBefore) {
                        // Only record the instance id to keep recovered highlighting
                        // scoped to the single instance the student had recovered.
                        if (!recoveredHistory.includes(instIdStr)) recoveredHistory.push(instIdStr);
                    }

                    // Remove matching instances (by _id or by classId for class-level cancels)
                    classes = classes.filter(c => {
                        const cid = c._id && c._id.toString ? c._id.toString() : String(c._id);
                        const cclass = c.classId && c.classId.toString ? c.classId.toString() : String(c.classId || '');
                        if (isClassCancel && opts.classId) return cclass !== String(opts.classId);
                        return cid !== instIdStr && cclass !== instIdStr;
                    });

                    // Recompute tickets and re-render immediately so the user sees
                    // the class disappear without waiting for the next refresh.
                    await loadTickets();
                    renderTab();
                } catch (uiErr) {
                    console.warn('Error updating UI after cancel:', uiErr);
                }

                // If backend returned a ticket, show success as before
                if (data.ticket) {
                    showAlert('success', '✅ Clase cancelada. Se generó un ticket para recuperar.');
                } else if (opts.recovered) {
                    // If backend didn't return a ticket, attempt to persist one server-side
                    // so the student can immediately reuse it to recover classes.
                    try {
                        const resp = await fetch(`/api/students/${myId}/create-ticket`, {
                            method: 'POST',
                            headers: { Authorization: `Bearer ${localStorage.getItem('token')}`, 'Content-Type': 'application/json' },
                            body: JSON.stringify({ instanceId: instanceId, classId: opts.classId })
                        });

                        let j = null;
                        if (resp.ok) {
                            try {
                                j = await resp.json();
                            } catch (parseErr) {
                                console.warn('create-ticket: response not JSON', parseErr);
                            }
                        }

                        if (resp.ok && j && j.ticket) {
                            // Merge newly created ticket into client lists
                            syntheticTickets.push(j.ticket);
                            await loadTickets();
                            renderTab();
                            showAlert('success', '✅ Clase cancelada. Se restauró un crédito para recuperar.');
                        } else {
                            // log server response for debugging and fallback to client-side
                            let bodyText = '';
                            try { bodyText = await resp.text(); } catch (tErr) { bodyText = String(tErr); }
                            console.warn('create-ticket failed', resp.status, bodyText);
                            const synthetic = {
                                id: `local-${Date.now()}`,
                                classId: opts.classId || null,
                                instanceId: instanceId,
                                status: 'active',
                                createdAt: new Date().toISOString(),
                                expiresAt: new Date(Date.now() + (30 * 864e5)).toISOString() // 30 days
                            };
                            syntheticTickets.push(synthetic);
                            await loadTickets();
                            renderTab();
                            showAlert('success', '✅ Clase cancelada. Se restauró un crédito para recuperar (localmente).');
                        }
                    } catch (e2) {
                        console.error('Failed to persist ticket fetch:', e2);
                        const synthetic = {
                            id: `local-${Date.now()}`,
                            classId: opts.classId || null,
                            instanceId: instanceId,
                            status: 'active',
                            createdAt: new Date().toISOString(),
                            expiresAt: new Date(Date.now() + (30 * 864e5)).toISOString() // 30 days
                        };
                        syntheticTickets.push(synthetic);
                        await loadTickets();
                        renderTab();
                        showAlert('success', '✅ Clase cancelada. Se restauró un crédito para recuperar (localmente).');
                    }
                } else {
                    // No ticket was created. We still cancelled the class; show a
                    // blocking OK-only modal (so user acknowledges), but don't
                    // revert the cancellation.
                    const info = data && data.message ? data.message : 'La clase fue cancelada pero no se generó un ticket (por tiempo mínimo de cancelación).';
                    showOkModal('Cancelación procesada', info, () => {
                        // Accept: nothing more to do. We already updated the UI
                        // above. Keep a short refresh scheduled to reconcile with
                        // server state if needed.
                        setTimeout(refreshPanel, 800);
                    });
                }
            } catch (e) {
                showAlert('error', `❌ ${e.message}`);
            }
            // If we pushed a synthetic ticket we already called loadTickets() above.
            // Otherwise refresh to get authoritative server state.
            if (!opts.recovered) await refreshPanel();
        }

        async function renderRecuperarClase() {
            console.log('renderRecuperarClase called');
            if (!tickets.length) {
                document.getElementById('tabContent').innerHTML = '<div style="margin:24px 0">No tenés clases para recuperar disponibles.</div>';
                return;
            }

            const now = new Date();
            const vencimiento = new Date(alumno.dueDate);
            const extraDays = gymConfig.autoCancelDueOverdueDays || 0;
            if (vencimiento < now && (now - vencimiento) / 864e5 > extraDays) {
                document.getElementById('tabContent').innerHTML = '<div style="margin:24px 0">No puedes recuperar clases, cuota vencida.</div>';
                return;
            }

            // Obtener instancias disponibles
            try {
                const res = await fetch('/api/class-instances/available', {
                    headers: { Authorization: `Bearer ${localStorage.getItem('token')}` }
                });
                if (!res.ok) throw new Error('No se pudieron cargar instancias disponibles');
                const disponibles = await res.json();

                // Filtrar las que ya tengo
                const myId = (alumno._id || alumno.id).toString();
                const filtered = disponibles.filter(inst => {
                    return !Array.isArray(inst.students) || !inst.students.map(x => x.toString()).includes(myId);
                });

                if (!filtered.length) {
                    document.getElementById('tabContent').innerHTML = '<div style="margin:24px 0">No hay clases disponibles para recuperar.</div>';
                    return;
                }

                // Render available instances as cards
                let html = '<div class="class-grid">';
                for (const inst of filtered) {
                    const dt = new Date(inst.dateTime);
                    const dayNames = ['Domingo', 'Lunes', 'Martes', 'Miércoles', 'Jueves', 'Viernes', 'Sábado'];
                    const hrs = dt.getHours();
                    const mins = dt.getMinutes();
                    const timeStr = mins === 0 ? `${hrs}hs` : `${hrs.toString().padStart(2, '0')}:${mins.toString().padStart(2, '0')}hs`;
                    const dateStr = `${dayNames[dt.getDay()]} ${dt.getDate()}/${dt.getMonth() + 1} - ${timeStr}`;
                    const instId = inst._id && inst._id.toString ? inst._id.toString() : inst._id;

                    html += `
                        <div class="class-card" data-id="${inst._id}">
                            <div style="display:flex;gap:12px;align-items:flex-start;">
                                <div style="width:56px;flex:0 0 56px;display:flex;align-items:center;justify-content:center;border-radius:10px;background:#f3f4f6;">
                                    <svg width="28" height="28" viewBox="0 0 24 24" fill="none" xmlns="http://www.w3.org/2000/svg"><rect x="3" y="4" width="18" height="16" rx="2" stroke="#374151" stroke-width="1.2" fill="#ffffff"/><path d="M8 2v4M16 2v4" stroke="#374151" stroke-width="1.2" stroke-linecap="round"/><path d="M7 11h1M11 11h6M7 15h1" stroke="#374151" stroke-width="1.2" stroke-linecap="round" stroke-linejoin="round"/></svg>
                                </div>
                                <div style="flex:1">
                                    <div class="date">${dateStr}</div>
                                    <div class="meta">
                                        <div style="display:flex;align-items:center;gap:8px;color:#6b7280"><svg width="14" height="14" viewBox="0 0 24 24" fill="none" xmlns="http://www.w3.org/2000/svg"><path d="M12 12c2.761 0 5-2.239 5-5s-2.239-5-5-5-5 2.239-5 5 2.239 5 5 5z" stroke="#9ca3af" stroke-width="1.2"/><path d="M4 20c0-4 4-6 8-6s8 2 8 6" stroke="#9ca3af" stroke-width="1.2"/></svg> ${inst.professorName || '-'}</div>
                                        <div style="display:flex;align-items:center;gap:8px;color:#6b7280"><svg width="14" height="14" viewBox="0 0 24 24" fill="none" xmlns="http://www.w3.org/2000/svg"><path d="M12 2C8.13 2 5 5.13 5 9c0 5.25 7 13 7 13s7-7.75 7-13c0-3.87-3.13-7-7-7z" stroke="#9ca3af" stroke-width="1.2" fill="none"/></svg> ${inst.roomName || '-'}</div>
                                    </div>
                                </div>
                            </div>
                            <div class="card-actions">
                                <button type="button" class="recover-full recover" data-id="${instId}" data-date="${dateStr}"><span style="font-weight:900">✓</span> <span>Recuperar</span></button>
                            </div>
                        </div>`;
                }
                html += '</div>';
                document.getElementById('tabContent').innerHTML = html;
                // Clicks for recover are handled by the delegated document click handler.
                // We avoid attaching per-button listeners to prevent duplicate events.
                console.log('Recover buttons rendered; delegated handler will manage clicks');
            } catch (e) {
                console.error('Error cargando instancias disponibles:', e);
                document.getElementById('tabContent').innerHTML = '<div style="margin:24px 0">Error cargando clases disponibles.</div>';
            }
        }

        function confirmarRecuperar(instanceId, dateStr) {
            console.log('confirmarRecuperar called, instanceId=', instanceId, 'dateStr=', dateStr);
            if (!tickets.length) {
                showAlert('error', '❌ No tenés tickets válidos.');
                return;
            }
            showModal(
                '¿Confirmar reserva?',
                `¿Estás seguro que querés reservar la clase del ${dateStr}? Se usará 1 ticket.`,
                () => recuperarInstancia(instanceId)
            );
        }

        async function recuperarInstancia(instanceId) {
            if (!tickets.length) {
                showAlert('error', '❌ No tenés tickets válidos.');
                return;
            }
            try {
                const myId = (alumno._id || alumno.id).toString();
                // Pick the first server-backed ticket (avoid local synthetic tickets)
                const ticketIndex = tickets.findIndex(t => !(String(t.id || '').startsWith('local-')));
                if (ticketIndex === -1) {
                    showAlert('error', '❌ No tenés tickets válidos para enviar al servidor.');
                    return;
                }
                const ticket = tickets[ticketIndex];
                const res = await fetch(`/api/students/${myId}/recover-instance/${instanceId}`, {
                    method: 'POST',
                    headers: { Authorization: `Bearer ${localStorage.getItem('token')}`, 'Content-Type': 'application/json' },
                    body: JSON.stringify({ ticketId: ticket.id })
                });
                // Parse response carefully and surface server message on error.
                let data = null;
                let textBody = null;
                try {
                    data = await res.json();
                } catch (parseErr) {
                    try { textBody = await res.text(); } catch (tErr) { textBody = null; }
                }

                if (!res.ok) {
                    const serverMsg = (data && (data.error || data.message)) || textBody || `Error ${res.status}`;
                    console.warn('recover-instance failed', res.status, serverMsg);
                    // If server tells us the ticket is already used / inactive,
                    // remove that ticket from our local lists so it no longer
                    // appears as available.
                    const msgLower = String(serverMsg).toLowerCase();
                    if (msgLower.includes('ya fue usado') || msgLower.includes('no está activo') || msgLower.includes('no esta activo') || msgLower.includes('no está disponible')) {
                        try {
                            // Remove from syntheticTickets if it was local, otherwise
                            // remove from tickets so UI updates.
                            if (String(ticket.id).startsWith('local-')) {
                                syntheticTickets = syntheticTickets.filter(st => st.id !== ticket.id);
                            }
                            tickets = tickets.filter(t => t.id !== ticket.id);
                            await loadTickets();
                            renderTab();
                        } catch (remErr) {
                            console.warn('Error removing invalid ticket locally', remErr);
                        }
                    }
                    // Show blocking OK modal so user can acknowledge why recovery failed
                    showOkModal('No se pudo recuperar', String(serverMsg), () => { });
                    return;
                }

                // Successful recovery: mark as recovered in UI and refresh tickets
                try {
                    const instIdStr = String(instanceId);
                    if (!recoveredHistory.includes(instIdStr)) recoveredHistory.push(instIdStr);
                    // Also mark the matching instance in-memory as recovered so
                    // only that specific card shows the yellow border.
                    try {
                        const found = classes.find(c => {
                            const cid = c._id && c._id.toString ? c._id.toString() : String(c._id);
                            return cid === instIdStr;
                        });
                        if (found) found._recovered = true;
                    } catch (eMark) {
                        console.warn('Could not mark instance as recovered in classes array', eMark);
                    }
                    await loadTickets();
                    renderTab();
                } catch (uiErr) {
                    console.warn('Error updating UI after recover:', uiErr);
                }

                showAlert('success', '✅ Clase recuperada correctamente.');
            } catch (e) {
                showAlert('error', `❌ ${e.message}`);
            }
            await refreshPanel();
        }

        async function refreshPanel() {
            await loadAlumno();
            await loadTickets();
            await loadClasses();
            renderTab();
        }

        function startRealtime() {
            if (refreshTimer) clearInterval(refreshTimer);
            // Pull every 10s for fresh data (simple and robust)
            refreshTimer = setInterval(refreshPanel, 10000);
            document.addEventListener('visibilitychange', () => {
                if (document.hidden) return;
                refreshPanel();
            });
        }

        // Delegated click handler for dynamic action buttons. This ensures clicks are
        // handled even if per-button listeners fail to attach for any reason.
        document.addEventListener('click', function (e) {
            try {
                const target = e.target;
                // Use a robust upward traversal instead of relying only on closest
                let node = target;
                while (node && node !== document) {
                    if (node.classList && (node.classList.contains('cancel-full') || node.classList.contains('cancel'))) {
                        console.log('delegated cancel click', node.dataset.id);
                        e.preventDefault();
                        confirmarCancelar(node.dataset.id, node.dataset.date, node.dataset.recovered === '1', node.dataset.classid);
                        return;
                    }
                    if (node.classList && (node.classList.contains('recover-full') || node.classList.contains('recover'))) {
                        console.log('delegated recover click', node.dataset.id);
                        e.preventDefault();
                        confirmarRecuperar(node.dataset.id, node.dataset.date, node.dataset.classid);
                        return;
                    }
                    node = node.parentNode;
                }
            } catch (err) {
                console.error('Error in delegated click handler', err);
            }
        });

        document.getElementById('tabClases').onclick = () => switchTab('clases');
        document.getElementById('tabRecuperar').onclick = () => switchTab('recuperar');
        // Logout button placed in header (top-right) - open confirmation modal
        const logoutTopBtn = document.getElementById('logoutTop');
        if (logoutTopBtn) logoutTopBtn.onclick = showLogoutConfirm;

        // Inicialización
        (async () => {
            try {
                // Verificar que hay token
                const token = localStorage.getItem('token');
                if (!token) {
                    window.location.href = '/index.html';
                    return;
                }

                await loadConfig();
                await refreshPanel();
                startRealtime();
                switchTab(activeTab);
            } catch (e) {
                console.error('Error durante inicialización:', e);
                const headerErr = document.getElementById('meHeader');
                if (headerErr) headerErr.textContent = 'Error';
                document.getElementById('cuotaStatus').textContent = 'Error al cargar';
                document.getElementById('tabContent').innerHTML = `<div class="alert error">Error: ${e.message}. <br>Revisa la consola del navegador (F12) para más detalles.</div>`;
            }
        })();
    </script>
</body>

</html>